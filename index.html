<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="莫佳骏学习笔记">
<meta property="og:type" content="website">
<meta property="og:title" content="mojiajun">
<meta property="og:url" content="https://mojiajun.github.io/index.html">
<meta property="og:site_name" content="mojiajun">
<meta property="og:description" content="莫佳骏学习笔记">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mojiajun">
<meta name="twitter:description" content="莫佳骏学习笔记">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://mojiajun.github.io/">





  <title>mojiajun</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">mojiajun</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://mojiajun.github.io/post/18ee0c7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mojiajun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mojiajun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/18ee0c7.html" itemprop="url">mit6828-内联汇编-xv6-xchg-spinlock</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-10T00:00:00+08:00">
                2019-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码阅读/" itemprop="url" rel="index">
                    <span itemprop="name">源码阅读</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码阅读/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<h2 id="inline-assembly"><a href="#inline-assembly" class="headerlink" title="inline assembly"></a>inline assembly</h2><p>入门:<a href="https://blog.csdn.net/slvher/article/details/8864996" target="_blank" rel="noopener">【Linux学习笔记】Linux C中内联汇编的语法格式及使用方法（Inline Assembly in Linux C）</a>这个讲的比较好了.更全面的得查类似<a href="http://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html#ss5.1" target="_blank" rel="noopener">GCC-Inline-Assembly-HOWTO</a>这种</p>
<p>inline assembly感觉细节好多…下次看估计又忘了…</p>
<hr>
<p>用1对双引号将多行命令括起来 加”;”分号?<br>clobbered register修饰寄存器?修饰?<br><a href="https://en.wikipedia.org/wiki/Inline_assembler" target="_blank" rel="noopener">Inline assembler</a>里面有个用汇编求tan(x)的例子,待看,感觉挺有趣.</p>
<hr>
<p>当我们不想通过寄存器中转，而是直接操作内存时，可以用”m”来约束。例如：<br>asm volatile ( “lock; decl %0” : “=m” (counter) : “m” (counter));<br>该指令实现原子减一操作，输入、输出操作数均直接来自内存（<strong>也正因如此，才能保证操作的原子性</strong>）。 </p>
<blockquote>
<p>  也正因如此，才能保证操作的原子性,更底层细节?这是是保证原子性的关键吗?结合后面的xv6的xchg函数实现.<br>  3个东西.1是lock前缀,2是+代表read-modify-write,3是”m”直接操作内存</p>
</blockquote>
<p>“=的意思” output operand应该有个”=”,1.说明这个是输出操作数,2.write-only</p>
<ul>
<li>“r” is a constraint on the operands. We’ll see constraints in detail later. For the time being, “r” says to GCC to use any register for storing the operands. output operand constraint should have a constraint modifier “=”. And this modifier says that it is the output operand and is write-only.</li>
</ul>
<p>“cc”的意思</p>
<p>If our instruction can alter the condition code register, we have to add “cc” to the list of clobbered registers.s</p>
<hr>
<h2 id="xv6的xchg函数"><a href="#xv6的xchg函数" class="headerlink" title="xv6的xchg函数"></a>xv6的xchg函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//交换*addr和newval,然后把*addr的原先的值作为result返回!!!这只是从C层面可以这么从逻辑上理解.实际编译器干的有些区别,但是最终结果一致.</span></span><br><span class="line"><span class="comment">//范例:见后面</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint</span><br><span class="line">xchg(<span class="keyword">volatile</span> uint *addr, uint newval)</span><br><span class="line">&#123;</span><br><span class="line">  uint result;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The + in "+m" denotes a read-modify-write operand.</span></span><br><span class="line">  <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">"lock; xchgl %0, %1"</span> :</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="string">"+m"</span> (*addr), <span class="string">"=a"</span> (result) :</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="string">"1"</span> (newval) :</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="string">"cc"</span>)</span></span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这个"1"感觉是代表对应前面的%1,指定位置的作用?没仔细查...猜的</span></span><br><span class="line">kernel.<span class="keyword">asm</span>:</span><br><span class="line"> <span class="number">8515</span>   <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">"lock; xchgl %0, %1"</span> :</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8516</span> <span class="number">80104373</span>:       ba <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x1</span>,%edx</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8517</span> <span class="number">80104378</span>:       eb <span class="number">09</span>                   jmp    <span class="number">80104383</span> &lt;acquire+<span class="number">0x33</span>&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8518</span> <span class="number">8010437</span>a:       <span class="number">8</span>d b6 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       lea    <span class="number">0x0</span>(%esi),%esi</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8519</span> <span class="number">80104380</span>:       <span class="number">8b</span> <span class="number">5</span>d <span class="number">08</span>                mov    <span class="number">0x8</span>(%ebp),%ebx</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8520</span> <span class="number">80104383</span>:       <span class="number">89</span> d0                   mov    %edx,%eax</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8521</span> <span class="number">80104385</span>:       f0 <span class="number">87</span> <span class="number">03</span>                lock xchg %eax,(%ebx)</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8522</span>   <span class="keyword">while</span>(xchg(&amp;lk-&gt;locked, <span class="number">1</span>) != <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8523</span> <span class="number">80104388</span>:       <span class="number">85</span> c0                   test   %eax,%eax</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8524</span> <span class="number">8010438</span>a:       <span class="number">75</span> f4                   jne    <span class="number">80104380</span> &lt;acquire+<span class="number">0x30</span>&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">在实际运行的汇编代码里面为什么顺序又变了?前后的顺序?</span></span></span><br><span class="line"><span class="function"><span class="params">猜测:这部分代码还是得根据实际运行的情况来看,test   %eax,%eax,即测试的是eax,而且<span class="string">"=a"</span> (result) :</span></span></span><br><span class="line"><span class="function"><span class="params">所以eax存的是交换之后的值,那么在交换之前,存在是newval</span></span></span><br><span class="line"><span class="function"><span class="params">根据lock; xchgl (*addr), newval字面来套是这样的.因为eax得存交换后的值,所以eax交换前存的是newval</span></span></span><br><span class="line"><span class="function"><span class="params">所以lock; xchgl (*addr), eax,然后就和实际运行看到的相反了...这个过程是编译器给做的.并不太清楚编译器寄存器分配的规则...</span></span></span><br><span class="line"><span class="function"><span class="params">                     </span></span></span><br><span class="line"><span class="function"><span class="params">                     </span></span></span><br><span class="line"><span class="function"><span class="params">附上前后的其他东西,便于数那个&lt;acquire+<span class="number">0x30</span>&gt;的位置十进制数偏移<span class="number">48</span>,jne    <span class="number">80104380</span> &lt;acquire+<span class="number">0x30</span>&gt;跳转到lea    <span class="number">0x0</span>(%esi),%esi</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8498</span> <span class="number">80104350</span> &lt;acquire&gt;:</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8499</span> &#123;</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8500</span> <span class="number">80104350</span>:       <span class="number">55</span>                      push   %ebp</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8501</span> <span class="number">80104351</span>:       <span class="number">89</span> e5                   mov    %esp,%ebp</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8502</span> <span class="number">80104353</span>:       <span class="number">56</span>                      push   %esi</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8503</span> <span class="number">80104354</span>:       <span class="number">53</span>                      push   %ebx</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8504</span>   pushcli(); <span class="comment">// disable interrupts to avoid deadlock.</span></span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8505</span> <span class="number">80104355</span>:       e8 <span class="number">26</span> ff ff ff          call   <span class="number">80104280</span> &lt;pushcli&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8506</span>   <span class="keyword">if</span>(holding(lk))</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8507</span> <span class="number">8010435</span>a:       <span class="number">8b</span> <span class="number">5</span>d <span class="number">08</span>                mov    <span class="number">0x8</span>(%ebp),%ebx</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8508</span> <span class="number">8010435</span>d:       <span class="number">83</span> ec <span class="number">0</span>c                sub    $<span class="number">0xc</span>,%esp</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8509</span> <span class="number">80104360</span>:       <span class="number">53</span>                      push   %ebx</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8510</span> <span class="number">80104361</span>:       e8 ba ff ff ff          call   <span class="number">80104320</span> &lt;holding&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8511</span> <span class="number">80104366</span>:       <span class="number">83</span> c4 <span class="number">10</span>                add    $<span class="number">0x10</span>,%esp</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8512</span> <span class="number">80104369</span>:       <span class="number">85</span> c0                   test   %eax,%eax</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8513</span> <span class="number">8010436b</span>:       <span class="number">0f</span> <span class="number">85</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       jne    <span class="number">801043f</span>4 &lt;acquire+<span class="number">0xa4</span>&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8514</span> <span class="number">80104371</span>:       <span class="number">89</span> c6                   mov    %eax,%esi</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8515</span>   <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="string">"lock; xchgl %0, %1"</span> :   </span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8516</span> <span class="number">80104373</span>:       ba <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x1</span>,%edx</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8517</span> <span class="number">80104378</span>:       eb <span class="number">09</span>                   jmp    <span class="number">80104383</span> &lt;acquire+<span class="number">0x33</span>&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8518</span> <span class="number">8010437</span>a:       <span class="number">8</span>d b6 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       lea    <span class="number">0x0</span>(%esi),%esi</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8519</span> <span class="number">80104380</span>:       <span class="number">8b</span> <span class="number">5</span>d <span class="number">08</span>                mov    <span class="number">0x8</span>(%ebp),%ebx</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8520</span> <span class="number">80104383</span>:       <span class="number">89</span> d0                   mov    %edx,%eax</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8521</span> <span class="number">80104385</span>:       f0 <span class="number">87</span> <span class="number">03</span>                lock xchg %eax,(%ebx)</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8522</span>   <span class="keyword">while</span>(xchg(&amp;lk-&gt;locked, <span class="number">1</span>) != <span class="number">0</span>)      </span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8523</span> <span class="number">80104388</span>:       <span class="number">85</span> c0                   test   %eax,%eax</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8524</span> <span class="number">8010438</span>a:       <span class="number">75</span> f4                   jne    <span class="number">80104380</span> &lt;acquire+<span class="number">0x30</span>&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8525</span>   __sync_synchronize();</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8526</span> <span class="number">8010438</span>c:       f0 <span class="number">83</span> <span class="number">0</span>c <span class="number">24</span> <span class="number">00</span>          lock orl $<span class="number">0x0</span>,(%esp)</span></span></span><br></pre></td></tr></table></figure>
<h2 id="xchg-使用案例-xv6的spinlock的acquire和release"><a href="#xchg-使用案例-xv6的spinlock的acquire和release" class="headerlink" title="xchg()使用案例,xv6的spinlock的acquire和release"></a>xchg()使用案例,xv6的spinlock的acquire和release</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">acquire(struct spinlock *lk)</span><br><span class="line">&#123;</span><br><span class="line">  pushcli(); <span class="comment">// disable interrupts to avoid deadlock.</span></span><br><span class="line">  <span class="keyword">if</span>(holding(lk))</span><br><span class="line">    panic(<span class="string">"acquire"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The xchg is atomic.</span></span><br><span class="line">  <span class="keyword">while</span>(xchg(&amp;lk-&gt;locked, <span class="number">1</span>) != <span class="number">0</span>)</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Tell the C compiler and the processor to not move loads or stores</span></span><br><span class="line">  <span class="comment">// past this point, to ensure that the critical section's memory</span></span><br><span class="line">  <span class="comment">// references happen after the lock is acquired.</span></span><br><span class="line">  __sync_synchronize();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Record info about lock acquisition for debugging.</span></span><br><span class="line">  lk-&gt;cpu = mycpu();</span><br><span class="line">  getcallerpcs(&amp;lk, lk-&gt;pcs);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Release the lock.</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">release(struct spinlock *lk)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span>(!holding(lk))</span><br><span class="line">    panic(<span class="string">"release"</span>);</span><br><span class="line"></span><br><span class="line">  lk-&gt;pcs[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  lk-&gt;cpu = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Tell the C compiler and the processor to not move loads or stores</span></span><br><span class="line">  <span class="comment">// past this point, to ensure that all the stores in the critical</span></span><br><span class="line">  <span class="comment">// section are visible to other cores before the lock is released.</span></span><br><span class="line">  <span class="comment">// Both the C compiler and the hardware may re-order loads and</span></span><br><span class="line">  <span class="comment">// stores; __sync_synchronize() tells them both not to.</span></span><br><span class="line">  __sync_synchronize();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Release the lock, equivalent to lk-&gt;locked = 0.</span></span><br><span class="line">  <span class="comment">// This code can't use a C assignment, since it might</span></span><br><span class="line">  <span class="comment">// not be atomic. A real OS would use C atomics here.</span></span><br><span class="line">  <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">"movl $0, %0"</span> : <span class="string">"+m"</span> (lk-&gt;locked) : )</span></span>;</span><br><span class="line"></span><br><span class="line">  popcli();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">8516</span> <span class="number">80104373</span>:       ba <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x1</span>,%edx</span><br><span class="line"> <span class="number">8517</span> <span class="number">80104378</span>:       eb <span class="number">09</span>                   jmp    <span class="number">80104383</span> &lt;acquire+<span class="number">0x33</span>&gt;</span><br><span class="line"> <span class="number">8518</span> <span class="number">8010437</span>a:       <span class="number">8</span>d b6 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       lea    <span class="number">0x0</span>(%esi),%esi</span><br><span class="line"> <span class="number">8519</span> <span class="number">80104380</span>:       <span class="number">8b</span> <span class="number">5</span>d <span class="number">08</span>                mov    <span class="number">0x8</span>(%ebp),%ebx</span><br><span class="line"> <span class="number">8520</span> <span class="number">80104383</span>:       <span class="number">89</span> d0                   mov    %edx,%eax</span><br><span class="line"> <span class="number">8521</span> <span class="number">80104385</span>:       f0 <span class="number">87</span> <span class="number">03</span>                lock xchg %eax,(%ebx)</span><br><span class="line"> <span class="number">8523</span> <span class="number">80104388</span>:       <span class="number">85</span> c0                   test   %eax,%eax</span><br><span class="line"> <span class="number">8524</span> <span class="number">8010438</span>a:       <span class="number">75</span> f4                   jne    <span class="number">80104380</span> &lt;acquire+<span class="number">0x30</span>&gt;</span><br><span class="line"><span class="comment">// 这八行汇编是底下的这个while循环被编译器编译后处理的结果,在kernel.asm拿到的.详细的见前面的分析.jne    80104380 &lt;acquire+0x30&gt;跳到lea    0x0(%esi),%esi</span></span><br><span class="line">  <span class="keyword">while</span>(xchg(&amp;lk-&gt;locked, <span class="number">1</span>) != <span class="number">0</span>)</span><br><span class="line">    ;</span><br><span class="line">没拿到锁的时候,lk-&gt;locked存的是<span class="number">0</span>,拿到锁后存的是<span class="number">1.</span></span><br><span class="line">    </span><br><span class="line">情况A:假设lk这把spinlock的locked原来的状态是<span class="number">0</span>,代表当前这把锁还没有被拿到过,然后进入acquire(),xchg()换lk-&gt;locked和<span class="number">1</span>,交换后lk-&gt;locked存的变成<span class="number">1</span>了,代表锁上了.然后从C层面看的话,xchg()返回的结果是lk-&gt;locked()交换之前的值.也就是<span class="number">0</span>,所以<span class="keyword">while</span>(<span class="number">0</span> != <span class="number">0</span>)条件不满足,<span class="literal">false</span>,<span class="keyword">while</span>(<span class="literal">false</span>),那么不执行循环语句,在这里是空语句(;).然后执行__sync_synchronize();.代表拿到锁了.</span><br><span class="line">    </span><br><span class="line">情况B:假设lk这把spinlock的locked原来的状态是<span class="number">1</span>,代表当前这把锁已经被拿过了,然后进入acquire(),xchg()换lk-&gt;locked和<span class="number">1</span>,交换后lk-&gt;locked存的仍然是<span class="number">1</span>(<span class="number">1</span>和<span class="number">1</span>交换).然后从C层面看的话,xchg()返回的结果是lk-&gt;locked()交换之前的值.也就是<span class="number">1</span>,所以<span class="keyword">while</span>(<span class="number">1</span> != <span class="number">0</span>)条件满足,<span class="literal">true</span>,<span class="keyword">while</span>(<span class="literal">true</span>),那么执行循环语句,在这里是空语句(;)然后再次执行xchg()...还是<span class="number">1</span>和<span class="number">1</span>交换.然后再次执行xchg()...这个就是spinlock的本质!在汇编层面实际执行的循环是,这个就是操作系统教材里面爱提的概念busy wait???</span><br><span class="line"> <span class="number">8518</span> <span class="number">8010437</span>a:       <span class="number">8</span>d b6 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       lea    <span class="number">0x0</span>(%esi),%esi</span><br><span class="line"> <span class="number">8519</span> <span class="number">80104380</span>:       <span class="number">8b</span> <span class="number">5</span>d <span class="number">08</span>                mov    <span class="number">0x8</span>(%ebp),%ebx</span><br><span class="line"> <span class="number">8520</span> <span class="number">80104383</span>:       <span class="number">89</span> d0                   mov    %edx,%eax</span><br><span class="line"> <span class="number">8521</span> <span class="number">80104385</span>:       f0 <span class="number">87</span> <span class="number">03</span>                lock xchg %eax,(%ebx)</span><br><span class="line"> <span class="number">8523</span> <span class="number">80104388</span>:       <span class="number">85</span> c0                   test   %eax,%eax</span><br><span class="line"> <span class="number">8524</span> <span class="number">8010438</span>a:       <span class="number">75</span> f4                   jne    <span class="number">80104380</span> &lt;acquire+<span class="number">0x30</span>&gt;</span><br></pre></td></tr></table></figure>
<h2 id="额外"><a href="#额外" class="headerlink" title="额外"></a>额外</h2><p>1.read-modify-write??</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The + in "+m" denotes a read-modify-write operand.</span></span><br><span class="line">+号在GCC-Inline-Assembly-HOWTO还没找着(没仔细找),还有这个read-modify-write operand,是原子操作的关键所在???!!!</span><br></pre></td></tr></table></figure>
<p>2.研究下busy wait和sleep<br><a href="https://stackoverflow.com/questions/1107593/what-are-trade-offs-for-busy-wait-vs-sleep" target="_blank" rel="noopener">What are trade offs for “busy wait” vs “sleep”?</a>还没看,但是待看…<br>感觉busy wait消耗cpu资源,sleep并没有消耗cpu资源(只是粗略的讲)</p>
<p>3.实际调试下,打断点.在acquire()上</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://mojiajun.github.io/post/11e7222f.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mojiajun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mojiajun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/11e7222f.html" itemprop="url">redis-项目文件概览</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-28T00:00:00+08:00">
                2019-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码阅读/" itemprop="url" rel="index">
                    <span itemprop="name">源码阅读</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码阅读/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<p>基于redis-2.8</p>
<h2 id="底层数据结构"><a href="#底层数据结构" class="headerlink" title="底层数据结构"></a>底层数据结构</h2><h3 id="dict-h-c"><a href="#dict-h-c" class="headerlink" title="dict.h.c"></a>dict.h.c</h3><p>dict,hash的实现</p>
<h3 id="adlist-h-c"><a href="#adlist-h-c" class="headerlink" title="adlist.h.c"></a>adlist.h.c</h3><p>通用双向链表?</p>
<h3 id="sds-h-c"><a href="#sds-h-c" class="headerlink" title="sds.h.c"></a>sds.h.c</h3><p>封装了底层的字符串</p>
<h2 id="五种redis对象-基于底层数据结构"><a href="#五种redis对象-基于底层数据结构" class="headerlink" title="五种redis对象(基于底层数据结构)"></a>五种redis对象(基于底层数据结构)</h2><h3 id="t-list-c"><a href="#t-list-c" class="headerlink" title="t_list.c"></a>t_list.c</h3><h3 id="t-set-c"><a href="#t-set-c" class="headerlink" title="t_set.c"></a>t_set.c</h3><h3 id="t-string-c"><a href="#t-string-c" class="headerlink" title="t_string.c"></a>t_string.c</h3><h3 id="t-zset-c"><a href="#t-zset-c" class="headerlink" title="t_zset.c"></a>t_zset.c</h3><h3 id="t-hash-c"><a href="#t-hash-c" class="headerlink" title="t_hash.c"></a>t_hash.c</h3><h2 id="网络有关"><a href="#网络有关" class="headerlink" title="网络有关"></a>网络有关</h2><h3 id="networking-c"><a href="#networking-c" class="headerlink" title="networking.c"></a>networking.c</h3><p>和anet,ae的关系?</p>
<h3 id="anet-h-c"><a href="#anet-h-c" class="headerlink" title="anet.h.c"></a>anet.h.c</h3><p>a代表什么?封装了底层操作系统的socket API</p>
<h3 id="ae-h-c"><a href="#ae-h-c" class="headerlink" title="ae.h.c"></a>ae.h.c</h3><p>简单的事件驱动库,redis的reactor模式的实现</p>
<h4 id="ae-epoll-c-ae-evport-c-ae-kqueue-c-qe-select-c"><a href="#ae-epoll-c-ae-evport-c-ae-kqueue-c-qe-select-c" class="headerlink" title="ae_epoll.c,ae_evport.c,ae_kqueue.c,qe_select.c"></a>ae_epoll.c,ae_evport.c,ae_kqueue.c,qe_select.c</h4><p>这四个文件统一了不同操作系统提供的I/O event notification.<br>拿linux下的ae_epoll.c举例子,其在底层的epoll上面封了一层.</p>
<p>ae.h.c会使用这四种操作系统提供的event notification之一,对于ae.h.c来说,API是统一的.</p>
<h2 id="上层数据库"><a href="#上层数据库" class="headerlink" title="上层数据库"></a>上层数据库</h2><h3 id="redis-h-c"><a href="#redis-h-c" class="headerlink" title="redis.h.c"></a>redis.h.c</h3><p>redisDb是数据库的核心结构体,围绕它有redisClient,redisServer.分配代表客户端和服务器,然后再基于reactor模式,实现了两者之间的通信,典型的C/S架构.</p>
<p>redis.h里面的很多API函数是在其他的一些.c里实现的,不一定在redis.c里.例如redisDb的API函数就是在db.c里实现的.</p>
<h2 id="通用"><a href="#通用" class="headerlink" title="通用"></a>通用</h2><h3 id="zmalloc-h-c"><a href="#zmalloc-h-c" class="headerlink" title="zmalloc.h.c"></a>zmalloc.h.c</h3><p>封装了底层的malloc,calloc,remalloc,free四个函数.提供了可以进行内存分配统计的能力.</p>
<blockquote>
<p>  可以替换掉glibc的内存分配函数,例如可以用jemalloc库代替.有啥优点?</p>
</blockquote>
<h2 id="杂项"><a href="#杂项" class="headerlink" title="杂项"></a>杂项</h2><h3 id="version-h"><a href="#version-h" class="headerlink" title="version.h"></a>version.h</h3><p>版本号</p>
<h3 id="asciilogo-h"><a href="#asciilogo-h" class="headerlink" title="asciilogo.h"></a>asciilogo.h</h3><p>redis的ascii格式的logo,在服务器启动的时候会显示出来.</p>
<h3 id="config-c"><a href="#config-c" class="headerlink" title="config.c"></a>config.c</h3><p>解析配置文件的实现函数,API接口在redis.h里</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://mojiajun.github.io/post/18ee0d3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mojiajun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mojiajun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/18ee0d3.html" itemprop="url">redis-server初始化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-27T00:00:00+08:00">
                2019-04-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码阅读/" itemprop="url" rel="index">
                    <span itemprop="name">源码阅读</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码阅读/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="initServerConfig"><a href="#initServerConfig" class="headerlink" title="initServerConfig()"></a>initServerConfig()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initServerConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">    getRandomHexChars(server.runid,REDIS_RUN_ID_SIZE);</span><br><span class="line">    server.configfile = <span class="literal">NULL</span>;</span><br><span class="line">    server.hz = REDIS_DEFAULT_HZ;</span><br><span class="line">    server.runid[REDIS_RUN_ID_SIZE] = <span class="string">'\0'</span>;</span><br><span class="line">    server.arch_bits = (<span class="keyword">sizeof</span>(<span class="keyword">long</span>) == <span class="number">8</span>) ? <span class="number">64</span> : <span class="number">32</span>;</span><br><span class="line">    server.port = REDIS_SERVERPORT;</span><br><span class="line">    server.bindaddr_count = <span class="number">0</span>;</span><br><span class="line">    server.unixsocket = <span class="literal">NULL</span>;</span><br><span class="line">    server.unixsocketperm = REDIS_DEFAULT_UNIX_SOCKET_PERM;</span><br><span class="line">    server.ipfd_count = <span class="number">0</span>;</span><br><span class="line">    server.sofd = <span class="number">-1</span>;</span><br><span class="line">    server.dbnum = REDIS_DEFAULT_DBNUM;</span><br><span class="line">    server.verbosity = REDIS_DEFAULT_VERBOSITY;</span><br><span class="line">    server.maxidletime = REDIS_MAXIDLETIME;</span><br><span class="line">    server.tcpkeepalive = REDIS_DEFAULT_TCP_KEEPALIVE;</span><br><span class="line">    server.active_expire_enabled = <span class="number">1</span>;</span><br><span class="line">    server.client_max_querybuf_len = REDIS_MAX_QUERYBUF_LEN;</span><br><span class="line">    server.saveparams = <span class="literal">NULL</span>;</span><br><span class="line">    server.loading = <span class="number">0</span>;</span><br><span class="line">    server.logfile = zstrdup(REDIS_DEFAULT_LOGFILE);</span><br><span class="line">    server.syslog_enabled = REDIS_DEFAULT_SYSLOG_ENABLED;</span><br><span class="line">    server.syslog_ident = zstrdup(REDIS_DEFAULT_SYSLOG_IDENT);</span><br><span class="line">    server.syslog_facility = LOG_LOCAL0;</span><br><span class="line">    server.daemonize = REDIS_DEFAULT_DAEMONIZE;</span><br><span class="line">    server.aof_state = REDIS_AOF_OFF;</span><br><span class="line">    server.aof_fsync = REDIS_DEFAULT_AOF_FSYNC;</span><br><span class="line">    server.aof_no_fsync_on_rewrite = REDIS_DEFAULT_AOF_NO_FSYNC_ON_REWRITE;</span><br><span class="line">    server.aof_rewrite_perc = REDIS_AOF_REWRITE_PERC;</span><br><span class="line">    server.aof_rewrite_min_size = REDIS_AOF_REWRITE_MIN_SIZE;</span><br><span class="line">    server.aof_rewrite_base_size = <span class="number">0</span>;</span><br><span class="line">    server.aof_rewrite_scheduled = <span class="number">0</span>;</span><br><span class="line">    server.aof_last_fsync = time(<span class="literal">NULL</span>);</span><br><span class="line">    server.aof_rewrite_time_last = <span class="number">-1</span>;</span><br><span class="line">    server.aof_rewrite_time_start = <span class="number">-1</span>;</span><br><span class="line">    server.aof_lastbgrewrite_status = REDIS_OK;</span><br><span class="line">    server.aof_delayed_fsync = <span class="number">0</span>;</span><br><span class="line">    server.aof_fd = <span class="number">-1</span>;</span><br><span class="line">    server.aof_selected_db = <span class="number">-1</span>; <span class="comment">/* Make sure the first time will not match */</span></span><br><span class="line">    server.aof_flush_postponed_start = <span class="number">0</span>;</span><br><span class="line">    server.aof_rewrite_incremental_fsync = REDIS_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC;</span><br><span class="line">    server.pidfile = zstrdup(REDIS_DEFAULT_PID_FILE);</span><br><span class="line">    server.rdb_filename = zstrdup(REDIS_DEFAULT_RDB_FILENAME);</span><br><span class="line">    server.aof_filename = zstrdup(<span class="string">"appendonly.aof"</span>);</span><br><span class="line">    server.requirepass = <span class="literal">NULL</span>;</span><br><span class="line">    server.rdb_compression = REDIS_DEFAULT_RDB_COMPRESSION;</span><br><span class="line">    server.rdb_checksum = REDIS_DEFAULT_RDB_CHECKSUM;</span><br><span class="line">    server.stop_writes_on_bgsave_err = REDIS_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR;</span><br><span class="line">    server.activerehashing = REDIS_DEFAULT_ACTIVE_REHASHING;</span><br><span class="line">    server.notify_keyspace_events = <span class="number">0</span>;</span><br><span class="line">    server.maxclients = REDIS_MAX_CLIENTS;</span><br><span class="line">    server.bpop_blocked_clients = <span class="number">0</span>;</span><br><span class="line">    server.maxmemory = REDIS_DEFAULT_MAXMEMORY;</span><br><span class="line">    server.maxmemory_policy = REDIS_DEFAULT_MAXMEMORY_POLICY;</span><br><span class="line">    server.maxmemory_samples = REDIS_DEFAULT_MAXMEMORY_SAMPLES;</span><br><span class="line">    server.hash_max_ziplist_entries = REDIS_HASH_MAX_ZIPLIST_ENTRIES;</span><br><span class="line">    server.hash_max_ziplist_value = REDIS_HASH_MAX_ZIPLIST_VALUE;</span><br><span class="line">    server.list_max_ziplist_entries = REDIS_LIST_MAX_ZIPLIST_ENTRIES;</span><br><span class="line">    server.list_max_ziplist_value = REDIS_LIST_MAX_ZIPLIST_VALUE;</span><br><span class="line">    server.set_max_intset_entries = REDIS_SET_MAX_INTSET_ENTRIES;</span><br><span class="line">    server.zset_max_ziplist_entries = REDIS_ZSET_MAX_ZIPLIST_ENTRIES;</span><br><span class="line">    server.zset_max_ziplist_value = REDIS_ZSET_MAX_ZIPLIST_VALUE;</span><br><span class="line">    server.shutdown_asap = <span class="number">0</span>;</span><br><span class="line">    server.repl_ping_slave_period = REDIS_REPL_PING_SLAVE_PERIOD;</span><br><span class="line">    server.repl_timeout = REDIS_REPL_TIMEOUT;</span><br><span class="line">    server.repl_min_slaves_to_write = REDIS_DEFAULT_MIN_SLAVES_TO_WRITE;</span><br><span class="line">    server.repl_min_slaves_max_lag = REDIS_DEFAULT_MIN_SLAVES_MAX_LAG;</span><br><span class="line">    server.lua_caller = <span class="literal">NULL</span>;</span><br><span class="line">    server.lua_time_limit = REDIS_LUA_TIME_LIMIT;</span><br><span class="line">    server.lua_client = <span class="literal">NULL</span>;</span><br><span class="line">    server.lua_timedout = <span class="number">0</span>;</span><br><span class="line">    server.loading_process_events_interval_bytes = (<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    updateLRUClock();</span><br><span class="line">    resetServerSaveParams();</span><br><span class="line"></span><br><span class="line">    appendServerSaveParams(<span class="number">60</span>*<span class="number">60</span>,<span class="number">1</span>);  <span class="comment">/* save after 1 hour and 1 change */</span></span><br><span class="line">    appendServerSaveParams(<span class="number">300</span>,<span class="number">100</span>);  <span class="comment">/* save after 5 minutes and 100 changes */</span></span><br><span class="line">    appendServerSaveParams(<span class="number">60</span>,<span class="number">10000</span>); <span class="comment">/* save after 1 minute and 10000 changes */</span></span><br><span class="line">    <span class="comment">/* Replication related */</span></span><br><span class="line">    server.masterauth = <span class="literal">NULL</span>;</span><br><span class="line">    server.masterhost = <span class="literal">NULL</span>;</span><br><span class="line">    server.masterport = <span class="number">6379</span>;</span><br><span class="line">    server.master = <span class="literal">NULL</span>;</span><br><span class="line">    server.cached_master = <span class="literal">NULL</span>;</span><br><span class="line">    server.repl_master_initial_offset = <span class="number">-1</span>;</span><br><span class="line">    server.repl_state = REDIS_REPL_NONE;</span><br><span class="line">    server.repl_syncio_timeout = REDIS_REPL_SYNCIO_TIMEOUT;</span><br><span class="line">    server.repl_serve_stale_data = REDIS_DEFAULT_SLAVE_SERVE_STALE_DATA;</span><br><span class="line">    server.repl_slave_ro = REDIS_DEFAULT_SLAVE_READ_ONLY;</span><br><span class="line">    server.repl_down_since = <span class="number">0</span>; <span class="comment">/* Never connected, repl is down since EVER. */</span></span><br><span class="line">    server.repl_disable_tcp_nodelay = REDIS_DEFAULT_REPL_DISABLE_TCP_NODELAY;</span><br><span class="line">    server.slave_priority = REDIS_DEFAULT_SLAVE_PRIORITY;</span><br><span class="line">    server.master_repl_offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Replication partial resync backlog */</span></span><br><span class="line">    server.repl_backlog = <span class="literal">NULL</span>;</span><br><span class="line">    server.repl_backlog_size = REDIS_DEFAULT_REPL_BACKLOG_SIZE;</span><br><span class="line">    server.repl_backlog_histlen = <span class="number">0</span>;</span><br><span class="line">    server.repl_backlog_idx = <span class="number">0</span>;</span><br><span class="line">    server.repl_backlog_off = <span class="number">0</span>;</span><br><span class="line">    server.repl_backlog_time_limit = REDIS_DEFAULT_REPL_BACKLOG_TIME_LIMIT;</span><br><span class="line">    server.repl_no_slaves_since = time(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Client output buffer limits */</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; REDIS_CLIENT_LIMIT_NUM_CLASSES; j++)</span><br><span class="line">        server.client_obuf_limits[j] = clientBufferLimitsDefaults[j];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Double constants initialization */</span></span><br><span class="line">    R_Zero = <span class="number">0.0</span>;</span><br><span class="line">    R_PosInf = <span class="number">1.0</span>/R_Zero;</span><br><span class="line">    R_NegInf = <span class="number">-1.0</span>/R_Zero;</span><br><span class="line">    R_Nan = R_Zero/R_Zero;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Command table -- we initiialize it here as it is part of the</span></span><br><span class="line"><span class="comment">     * initial configuration, since command names may be changed via</span></span><br><span class="line"><span class="comment">     * redis.conf using the rename-command directive. */</span></span><br><span class="line">    server.commands = dictCreate(&amp;commandTableDictType,<span class="literal">NULL</span>);</span><br><span class="line">    server.orig_commands = dictCreate(&amp;commandTableDictType,<span class="literal">NULL</span>);</span><br><span class="line">    populateCommandTable();</span><br><span class="line">    server.delCommand = lookupCommandByCString(<span class="string">"del"</span>);</span><br><span class="line">    server.multiCommand = lookupCommandByCString(<span class="string">"multi"</span>);</span><br><span class="line">    server.lpushCommand = lookupCommandByCString(<span class="string">"lpush"</span>);</span><br><span class="line">    server.lpopCommand = lookupCommandByCString(<span class="string">"lpop"</span>);</span><br><span class="line">    server.rpopCommand = lookupCommandByCString(<span class="string">"rpop"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Slow log */</span></span><br><span class="line">    server.slowlog_log_slower_than = REDIS_SLOWLOG_LOG_SLOWER_THAN;</span><br><span class="line">    server.slowlog_max_len = REDIS_SLOWLOG_MAX_LEN;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Debugging */</span></span><br><span class="line">    server.assert_failed = <span class="string">"&lt;no assertion failed&gt;"</span>;</span><br><span class="line">    server.assert_file = <span class="string">"&lt;no file&gt;"</span>;</span><br><span class="line">    server.assert_line = <span class="number">0</span>;</span><br><span class="line">    server.bug_report_start = <span class="number">0</span>;</span><br><span class="line">    server.watchdog_period = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="initServer"><a href="#initServer" class="headerlink" title="initServer()"></a>initServer()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">    signal(SIGHUP, SIG_IGN);</span><br><span class="line">    signal(SIGPIPE, SIG_IGN);</span><br><span class="line">    setupSignalHandlers();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.syslog_enabled) &#123;</span><br><span class="line">        openlog(server.syslog_ident, LOG_PID | LOG_NDELAY | LOG_NOWAIT,</span><br><span class="line">            server.syslog_facility);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server.current_client = <span class="literal">NULL</span>;</span><br><span class="line">    server.clients = listCreate();</span><br><span class="line">    server.clients_to_close = listCreate();</span><br><span class="line">    server.slaves = listCreate();</span><br><span class="line">    server.monitors = listCreate();</span><br><span class="line">    server.slaveseldb = <span class="number">-1</span>; <span class="comment">/* Force to emit the first SELECT command. */</span></span><br><span class="line">    server.unblocked_clients = listCreate();</span><br><span class="line">    server.ready_keys = listCreate();</span><br><span class="line"></span><br><span class="line">    createSharedObjects();</span><br><span class="line">    adjustOpenFilesLimit();</span><br><span class="line">    server.el = aeCreateEventLoop(server.maxclients+REDIS_EVENTLOOP_FDSET_INCR);</span><br><span class="line">    server.db = zmalloc(<span class="keyword">sizeof</span>(redisDb)*server.dbnum);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Open the TCP listening socket for the user commands. */</span></span><br><span class="line">    <span class="keyword">if</span> (listenToPort(server.port,server.ipfd,&amp;server.ipfd_count) == REDIS_ERR)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Open the listening Unix domain socket. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.unixsocket != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        unlink(server.unixsocket); <span class="comment">/* don't care if this fails */</span></span><br><span class="line">        server.sofd = anetUnixServer(server.neterr,server.unixsocket,server.unixsocketperm);</span><br><span class="line">        <span class="keyword">if</span> (server.sofd == ANET_ERR) &#123;</span><br><span class="line">            redisLog(REDIS_WARNING, <span class="string">"Opening socket: %s"</span>, server.neterr);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Abort if there are no listening sockets at all. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.ipfd_count == <span class="number">0</span> &amp;&amp; server.sofd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        redisLog(REDIS_WARNING, <span class="string">"Configured to not listen anywhere, exiting."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create the Redis databases, and initialize other internal state. */</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.dbnum; j++) &#123;</span><br><span class="line">        server.db[j].dict = dictCreate(&amp;dbDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].expires = dictCreate(&amp;keyptrDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].blocking_keys = dictCreate(&amp;keylistDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].ready_keys = dictCreate(&amp;setDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].watched_keys = dictCreate(&amp;keylistDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].id = j;</span><br><span class="line">        server.db[j].avg_ttl = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    server.pubsub_channels = dictCreate(&amp;keylistDictType,<span class="literal">NULL</span>);</span><br><span class="line">    server.pubsub_patterns = listCreate();</span><br><span class="line">    listSetFreeMethod(server.pubsub_patterns,freePubsubPattern);</span><br><span class="line">    listSetMatchMethod(server.pubsub_patterns,listMatchPubsubPattern);</span><br><span class="line">    server.cronloops = <span class="number">0</span>;</span><br><span class="line">    server.rdb_child_pid = <span class="number">-1</span>;</span><br><span class="line">    server.aof_child_pid = <span class="number">-1</span>;</span><br><span class="line">    aofRewriteBufferReset();</span><br><span class="line">    server.aof_buf = sdsempty();</span><br><span class="line">    server.lastsave = time(<span class="literal">NULL</span>); <span class="comment">/* At startup we consider the DB saved. */</span></span><br><span class="line">    server.lastbgsave_try = <span class="number">0</span>;    <span class="comment">/* At startup we never tried to BGSAVE. */</span></span><br><span class="line">    server.rdb_save_time_last = <span class="number">-1</span>;</span><br><span class="line">    server.rdb_save_time_start = <span class="number">-1</span>;</span><br><span class="line">    server.dirty = <span class="number">0</span>;</span><br><span class="line">    server.stat_numcommands = <span class="number">0</span>;</span><br><span class="line">    server.stat_numconnections = <span class="number">0</span>;</span><br><span class="line">    server.stat_expiredkeys = <span class="number">0</span>;</span><br><span class="line">    server.stat_evictedkeys = <span class="number">0</span>;</span><br><span class="line">    server.stat_starttime = time(<span class="literal">NULL</span>);</span><br><span class="line">    server.stat_keyspace_misses = <span class="number">0</span>;</span><br><span class="line">    server.stat_keyspace_hits = <span class="number">0</span>;</span><br><span class="line">    server.stat_peak_memory = <span class="number">0</span>;</span><br><span class="line">    server.stat_fork_time = <span class="number">0</span>;</span><br><span class="line">    server.stat_rejected_conn = <span class="number">0</span>;</span><br><span class="line">    server.stat_sync_full = <span class="number">0</span>;</span><br><span class="line">    server.stat_sync_partial_ok = <span class="number">0</span>;</span><br><span class="line">    server.stat_sync_partial_err = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(server.ops_sec_samples,<span class="number">0</span>,<span class="keyword">sizeof</span>(server.ops_sec_samples));</span><br><span class="line">    server.ops_sec_idx = <span class="number">0</span>;</span><br><span class="line">    server.ops_sec_last_sample_time = mstime();</span><br><span class="line">    server.ops_sec_last_sample_ops = <span class="number">0</span>;</span><br><span class="line">    server.unixtime = time(<span class="literal">NULL</span>);</span><br><span class="line">    server.mstime = mstime();</span><br><span class="line">    server.lastbgsave_status = REDIS_OK;</span><br><span class="line">    server.repl_good_slaves_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create the serverCron() time event, that's our main way to process</span></span><br><span class="line"><span class="comment">     * background operations. */</span></span><br><span class="line">    <span class="keyword">if</span>(aeCreateTimeEvent(server.el, <span class="number">1</span>, serverCron, <span class="literal">NULL</span>, <span class="literal">NULL</span>) == AE_ERR) &#123;</span><br><span class="line">        redisPanic(<span class="string">"Can't create the serverCron time event."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create an event handler for accepting new connections in TCP and Unix</span></span><br><span class="line"><span class="comment">     * domain sockets. */</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.ipfd_count; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (aeCreateFileEvent(server.el, server.ipfd[j], AE_READABLE,</span><br><span class="line">            acceptTcpHandler,<span class="literal">NULL</span>) == AE_ERR)</span><br><span class="line">            &#123;</span><br><span class="line">                redisPanic(</span><br><span class="line">                    <span class="string">"Unrecoverable error creating server.ipfd file event."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (server.sofd &gt; <span class="number">0</span> &amp;&amp; aeCreateFileEvent(server.el,server.sofd,AE_READABLE,</span><br><span class="line">        acceptUnixHandler,<span class="literal">NULL</span>) == AE_ERR) redisPanic(<span class="string">"Unrecoverable error creating server.sofd file event."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Open the AOF file if needed. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.aof_state == REDIS_AOF_ON) &#123;</span><br><span class="line">        server.aof_fd = open(server.aof_filename,</span><br><span class="line">                               O_WRONLY|O_APPEND|O_CREAT,<span class="number">0644</span>);</span><br><span class="line">        <span class="keyword">if</span> (server.aof_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">            redisLog(REDIS_WARNING, <span class="string">"Can't open the append-only file: %s"</span>,</span><br><span class="line">                strerror(errno));</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 32 bit instances are limited to 4GB of address space, so if there is</span></span><br><span class="line"><span class="comment">     * no explicit limit in the user provided configuration we set a limit</span></span><br><span class="line"><span class="comment">     * at 3 GB using maxmemory with 'noeviction' policy'. This avoids</span></span><br><span class="line"><span class="comment">     * useless crashes of the Redis instance for out of memory. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.arch_bits == <span class="number">32</span> &amp;&amp; server.maxmemory == <span class="number">0</span>) &#123;</span><br><span class="line">        redisLog(REDIS_WARNING,<span class="string">"Warning: 32 bit instance detected but no memory limit set. Setting 3 GB maxmemory limit with 'noeviction' policy now."</span>);</span><br><span class="line">        server.maxmemory = <span class="number">3072L</span>L*(<span class="number">1024</span>*<span class="number">1024</span>); <span class="comment">/* 3 GB */</span></span><br><span class="line">        server.maxmemory_policy = REDIS_MAXMEMORY_NO_EVICTION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    replicationScriptCacheInit();</span><br><span class="line">    scriptingInit();</span><br><span class="line">    slowlogInit();</span><br><span class="line">    bioInit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="redis数据库创建"><a href="#redis数据库创建" class="headerlink" title="redis数据库创建"></a>redis数据库创建</h3><h4 id="核心结构体redisDb"><a href="#核心结构体redisDb" class="headerlink" title="核心结构体redisDb"></a>核心结构体redisDb</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisDb</span> &#123;</span></span><br><span class="line">    dict *dict;                 <span class="comment">/* The keyspace for this DB */</span></span><br><span class="line">    dict *expires;              <span class="comment">/* Timeout of keys with a timeout set */</span></span><br><span class="line">    dict *blocking_keys;        <span class="comment">/* Keys with clients waiting for data (BLPOP) */</span></span><br><span class="line">    dict *ready_keys;           <span class="comment">/* Blocked keys that received a PUSH */</span></span><br><span class="line">    dict *watched_keys;         <span class="comment">/* WATCHED keys for MULTI/EXEC CAS */</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> avg_ttl;          <span class="comment">/* Average TTL, just for stats */</span></span><br><span class="line">&#125; redisDb;</span><br></pre></td></tr></table></figure>
<h4 id="创建流程"><a href="#创建流程" class="headerlink" title="创建流程"></a>创建流程</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_DEFAULT_DBNUM     16</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initServerConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">    server.dbnum = REDIS_DEFAULT_DBNUM;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果是配置文件里设置了数据库的数目,如<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Set the number of databases. The default database is DB 0, you can select</span></span><br><span class="line"><span class="comment"># a different one on a per-connection basis using SELECT &lt;dbid&gt; where</span></span><br><span class="line"><span class="comment"># dbid is a number between 0 and 'databases'-1</span></span><br><span class="line">databases 16</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//把文件配置信息读入内存</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loadServerConfig</span><span class="params">(<span class="keyword">char</span> *filename, <span class="keyword">char</span> *options)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">loadServerConfigFromString(config);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//解析配置信息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loadServerConfigFromString</span><span class="params">(<span class="keyword">char</span> *config)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">"databases"</span>) &amp;&amp; argc == <span class="number">2</span>) &#123;</span><br><span class="line">            server.dbnum = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">if</span> (server.dbnum &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                err = <span class="string">"Invalid number of databases"</span>; <span class="keyword">goto</span> loaderr;</span><br><span class="line">            &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">    server.db = zmalloc(<span class="keyword">sizeof</span>(redisDb)*server.dbnum);</span><br><span class="line">...</span><br><span class="line">    <span class="comment">/* Create the Redis databases, and initialize other internal state. */</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.dbnum; j++) &#123;</span><br><span class="line">        server.db[j].dict = dictCreate(&amp;dbDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].expires = dictCreate(&amp;keyptrDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].blocking_keys = dictCreate(&amp;keylistDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].ready_keys = dictCreate(&amp;setDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].watched_keys = dictCreate(&amp;keylistDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].id = j;</span><br><span class="line">        server.db[j].avg_ttl = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="切换数据库"><a href="#切换数据库" class="headerlink" title="切换数据库"></a>切换数据库</h4><p>SELECT命令调用selectCommand, 有效值显然是[0, server.dbnum-1]<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">selectDb</span><span class="params">(redisClient *c, <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (id &lt; <span class="number">0</span> || id &gt;= server.dbnum)</span><br><span class="line">        <span class="keyword">return</span> REDIS_ERR;</span><br><span class="line">    c-&gt;db = &amp;server.db[id];</span><br><span class="line">    <span class="keyword">return</span> REDIS_OK;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// SELECT命令调用selectCommand</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">selectCommand</span><span class="params">(redisClient *c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getLongFromObjectOrReply(c, c-&gt;argv[<span class="number">1</span>], &amp;id,</span><br><span class="line">        <span class="string">"invalid DB index"</span>) != REDIS_OK)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (selectDb(c,id) == REDIS_ERR) &#123;</span><br><span class="line">        addReplyError(c,<span class="string">"invalid DB index"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        addReply(c,shared.ok);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://mojiajun.github.io/post/ad18bfc1.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mojiajun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mojiajun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/ad18bfc1.html" itemprop="url">ffmpeg-av_read_frame()</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-27T00:00:00+08:00">
                2018-12-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码阅读/" itemprop="url" rel="index">
                    <span itemprop="name">源码阅读</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码阅读/ffmpeg/" itemprop="url" rel="index">
                    <span itemprop="name">ffmpeg</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#av_read_frame()</p>
<p>代码暂时不贴上来,等看懂之后再贴</p>
<p>之前印象笔记做过一点这个的笔记的</p>
<p>##genpts有什么用?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> genpts = s-&gt;flags &amp; AVFMT_FLAG_GENPTS;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AVFMT_FLAG_GENPTS       0x0001 <span class="comment">///&lt; Generate missing pts even if it requires parsing future frames.</span></span></span><br></pre></td></tr></table></figure>
<p>然后通过这个判断,如果等于0,就在下面这两个函数中选一个执行.然后goto return_packet</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ff_packet_list_get(&amp;s-&gt;internal-&gt;packet_buffer,</span><br><span class="line">                          &amp;s-&gt;internal-&gt;packet_buffer_end, pkt)</span><br><span class="line">read_frame_internal(s, pkt);</span><br></pre></td></tr></table></figure>
<h2 id="如果genpts等于1"><a href="#如果genpts等于1" class="headerlink" title="如果genpts等于1."></a>如果genpts等于1.</h2><p>执行后面的大循环</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">int ff_packet_list_get(AVPacketList **pkt_buffer,</span><br><span class="line">                       AVPacketList **pkt_buffer_end,</span><br><span class="line">                       AVPacket      *pkt)</span><br><span class="line">&#123;</span><br><span class="line">    AVPacketList *pktl;</span><br><span class="line">    av_assert0(*pkt_buffer);  //*pkt_buffer必须非空</span><br><span class="line">    pktl        = *pkt_buffer;</span><br><span class="line">    *pkt        = pktl-&gt;pkt;</span><br><span class="line">    *pkt_buffer = pktl-&gt;next;</span><br><span class="line">    if (!pktl-&gt;next)</span><br><span class="line">        *pkt_buffer_end = NULL;</span><br><span class="line">    av_freep(&amp;pktl);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://mojiajun.github.io/post/83a7b206.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mojiajun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mojiajun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/83a7b206.html" itemprop="url">基础知识_整型_补码_大小端_字符编码_浮点数</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-08T00:00:00+08:00">
                2018-12-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/基础知识/" itemprop="url" rel="index">
                    <span itemprop="name">基础知识</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<h2 id="基础知识-整型-补码-大小端-字符编码-浮点数"><a href="#基础知识-整型-补码-大小端-字符编码-浮点数" class="headerlink" title="基础知识-整型-补码-大小端-字符编码-浮点数"></a>基础知识-整型-补码-大小端-字符编码-浮点数</h2><h3 id="整型-补码-大小端-以int型为例-进行观察"><a href="#整型-补码-大小端-以int型为例-进行观察" class="headerlink" title="整型-补码-大小端-以int型为例,进行观察."></a>整型-补码-大小端-以int型为例,进行观察.</h3><p>首先,我们先形成一个二进制文件.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    FILE *fp_out;</span><br><span class="line">    <span class="keyword">int</span> *int_buffer;</span><br><span class="line"></span><br><span class="line">    int_buffer = (<span class="keyword">int</span> *)<span class="built_in">malloc</span>(<span class="number">4</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    <span class="built_in">memset</span>(int_buffer, <span class="number">0</span>, <span class="number">4</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> int_spacial = <span class="number">0x01234567</span>;</span><br><span class="line">    <span class="keyword">int</span> int_a = <span class="number">12345</span>;</span><br><span class="line">    <span class="keyword">int</span> int_b = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> int_c = <span class="number">-12345</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> *p_int_spacial = &amp;int_spacial;</span><br><span class="line">    <span class="keyword">int</span> *p_int_a = &amp;int_a;</span><br><span class="line">    <span class="keyword">int</span> *p_int_b = &amp;int_b;</span><br><span class="line">    <span class="keyword">int</span> *p_int_c = &amp;int_c;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(int_buffer, p_int_spacial, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    <span class="built_in">memcpy</span>(int_buffer + <span class="number">1</span>, p_int_a, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    <span class="built_in">memcpy</span>(int_buffer + <span class="number">2</span>, p_int_b, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    <span class="built_in">memcpy</span>(int_buffer + <span class="number">3</span>, p_int_c, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"sizeof(int) is :%lu\n"</span>, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">    fp_out = fopen(argv[<span class="number">1</span>], <span class="string">"wb+"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fp_out) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Open outputfile error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fwrite(int_buffer, <span class="keyword">sizeof</span>(<span class="keyword">int</span>), <span class="number">4</span>, fp_out);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(int_buffer);</span><br><span class="line">    fclose(fp_out);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clang -g generate_value_file.c -o generate_value_file</span><br><span class="line">gcc 一样的</span><br></pre></td></tr></table></figure>
<p>然后是形成二进制文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./generate_value_file value_file</span><br></pre></td></tr></table></figure>
<p>其实用vim -b value_file,然后%!xxd.或者xxd value_file都能看</p>
<p>再用下面这段代码来观察这个二进制文件.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">~feof_understand.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    FILE *fp_in;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *buffer;</span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    buffer = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">4</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>) + <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="number">4</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>) + <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    fp_in = fopen(argv[<span class="number">1</span>], <span class="string">"rb+"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fp_in) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Open inputfile error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(!feof(fp_in)) &#123;</span><br><span class="line">        buffer[pos++] = fgetc(fp_in);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(buffer);</span><br><span class="line">    fclose(fp_in);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -g feof_understand.c -o feof_understand</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./feof_understand value_file</span><br></pre></td></tr></table></figure>
<p>用ls -l 查看一下大小,16个字节.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rw-r--r-- ** **  16 Dec  8 22:10 value_file</span><br></pre></td></tr></table></figure>
<p>然后就是用lldb调试,单步运行观察了.查看内存(虚拟地址)的内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memory <span class="built_in">read</span> --size 1 --format x --count 18 address</span><br></pre></td></tr></table></figure>
<p>用GDB的话在这个例子里面就是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x /<span class="number">18</span>xb address</span><br><span class="line"><span class="number">18</span>个单元 按<span class="number">16</span>进制格式显示 单元大小是b表示单字节</span><br></pre></td></tr></table></figure>
<p>在address地址开始,一个单元是1个字节(size),格式是16进制输出(x),输出18个单元(count)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x100400000</span>: <span class="number">0x67</span> <span class="number">0x45</span> <span class="number">0x23</span> <span class="number">0x01</span> <span class="number">0x39</span> <span class="number">0x30</span> <span class="number">0x00</span> <span class="number">0x00</span></span><br><span class="line"><span class="number">0x100400008</span>: <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xc7</span> <span class="number">0xcf</span> <span class="number">0xff</span> <span class="number">0xff</span></span><br><span class="line"><span class="number">0x100400010</span>: <span class="number">0xff</span> <span class="number">0x00</span></span><br><span class="line">........   </span><br><span class="line">注意feof到最后还没停,会多读一次.为什么?</span><br></pre></td></tr></table></figure>
<p>总结:可以很清楚的明白大小端(这里是小端存储的),补码存储,feof作为二进制流会多读一个等问题.(这里和feof在一起分析是因为最近刚好碰到这个的一段代码,貌似多读了一位,想验证下,其实它和其他几个概念没什么关系.)</p>
<p>小端存储,低地址存的是最低有效位!如果低地址存的是最高有效位,那就是大端,0x01234567,这个数,最低有效位是67,因为它存储在低地址,所以是小端存储</p>
<h3 id="字符编码-汉字怎么存储的"><a href="#字符编码-汉字怎么存储的" class="headerlink" title="字符编码-汉字怎么存储的?"></a>字符编码-汉字怎么存储的?</h3><p>普通的ASCII字符这里就不提了.</p>
<p>下面换一种思路分析,尽量简单,不写入文件,直接调试器去内存查看.分析汉字是怎么存储的.</p>
<p>思考一个问题char *string_a = “你好”;这一个”你好”在栈内存区,那么它在字节形式是怎么表示的?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *string_a = <span class="string">"你好"</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"string_a lenth is %lu\n"</span>, <span class="built_in">strlen</span>(string_a));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">编译</span><br><span class="line">clang -g utf8_understand.c -o utf8_understand</span><br><span class="line">运行</span><br><span class="line">./utf8_understand</span><br><span class="line">输出</span><br><span class="line">string_a lenth is <span class="number">6</span></span><br><span class="line">因为<span class="built_in">strlen</span>()求的是实际长度,会把C风格的字符串最后一个<span class="string">'\0'</span>不计算在内</span><br><span class="line">也就是说,这两个汉字你好,占了<span class="number">6</span>个字节,为什么?</span><br></pre></td></tr></table></figure>
<blockquote>
<p>查”你”字的unicode编码 4F60</p>
<p>查”好”字的unicode编码 597D</p>
</blockquote>
<p>然后用UTF8编码一下.查阅编码规则(参考<a href="https://en.wikipedia.org/wiki/UTF-8" target="_blank" rel="noopener">wiki</a>).(从第一种情况即能看出,为什么UTF8兼容ASCII)</p>
<p><img src="http://pqnp708fx.bkt.clouddn.com/2019-04-28-unicode_utf8.png" alt></p>
<p>两个字都属于第三种情况:1110xxxx-10xxxxxx-10xxxxxx</p>
<blockquote>
<p>4F60 – 0100-1111-0110-0000<br>597D – 0101-1001-0111-1101</p>
</blockquote>
<p>然后就是简单的填充了..</p>
<p>0100-1111-0110-0000 –&gt; <strong>1110</strong> 0100 -<strong>10</strong>11 1101- <strong>10</strong>10 0000 (e4bda0)</p>
<p>0101-1001-0111-1101 –&gt; <strong>1110</strong> 0101 -<strong>10</strong>10 0101- <strong>10</strong>11 1101 (e5a5bd)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) memory <span class="built_in">read</span> -s 1 -f x -c 7 string_a</span><br><span class="line">0x100000f90: 0xe4 0xbd 0xa0 0xe5 0xa5 0xbd 0x00</span><br></pre></td></tr></table></figure>
<p>问题来了,为什么UTF8没有字节序了?</p>
<blockquote>
<p>​    得思考一下字节序这个问题的由来,举个例子,十进制数1234,为什么人类就知道是一千二百三十四.而不是四千三百二十一,还不是因为历史原因,约定俗成了.计算机也一样.你得告诉它,怎么解读[参考CSAPP,2.1.3寻址与字节顺序].</p>
</blockquote>
<p>计算机面临的字节序问题:</p>
<p><img src="http://pqnp708fx.bkt.clouddn.com/2019-04-28-%E5%AD%97%E8%8A%82%E5%BA%8F.png" alt></p>
<p>所以整型,浮点(float, double)都有大小端问题.</p>
<blockquote>
<p>为什么UTF8没有字节序了?<strong>猜测</strong>应该是1110 10 10 这三个加粗的前缀码导致的,一个汉字”好”,0xe4,读到这个字节,因为开头是1110,三个1,所以整个”好”就三个字节,然后系统就知道怎么处理了.</p>
</blockquote>
<p>具体点的话:在UTF8里面,”好”是e4bda0,注意它的二进制编码是<strong>1110</strong> 0100 -<strong>10</strong>11 1101- <strong>10</strong>10 0000</p>
<p>注意(1110)(10)(10),这三个前缀码在UTF8里面是有特殊含义的!读到一个字节开头如果是1110,那么代表整个字符包括”三”个字节,而10开头的字节肯定不会是一个字符的开头.如果读到第一个字节里面开头是11110,那么代表这个字符里面有”四”个字节.而这种前缀码的特性在整型,浮点(float, double)里面没有,所以它们肯定会存在字节序的问题.而UTF8有前缀码,就不需要了.(这里最好是能去找到计算机系统内部解析UTF8的程序,然后拿来看一下…)</p>
<p>而UTF16为什么有字节序问题?UTF16没有这种前缀码.</p>
<p>看下UTF16的编码方案.参考了<a href="https://juejin.im/post/5ace27c96fb9a028dc416195" target="_blank" rel="noopener">Unicode中UTF-8与UTF-16编码详解</a>的图</p>
<p><img src="http://pqnp708fx.bkt.clouddn.com/2019-04-28-UTF16.png" alt></p>
<p>可以看到2字节存储一个汉字的情况下,没有前缀码,从哪个方向读,都是”合理的”,所以必须指明.和整型,浮点型一个道理.</p>
<blockquote>
<p>注意Unicode是字符集,UTF8和UTF16是字符编码,它们是基于Unicode的关系.</p>
</blockquote>
<p><img src="http://pqnp708fx.bkt.clouddn.com/2019-04-28-unicode.png" alt></p>
<h3 id="浮点数-float-double型"><a href="#浮点数-float-double型" class="headerlink" title="浮点数-float,double型"></a>浮点数-float,double型</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    FILE *fp_out;</span><br><span class="line">    <span class="keyword">float</span> *float_buffer;</span><br><span class="line">    <span class="keyword">double</span> *double_buffer;</span><br><span class="line"></span><br><span class="line">    float_buffer = (<span class="keyword">float</span> *)<span class="built_in">malloc</span>(<span class="number">1</span> * <span class="keyword">sizeof</span>(<span class="keyword">float</span>));</span><br><span class="line">    <span class="built_in">memset</span>(float_buffer, <span class="number">0</span>, <span class="number">1</span> * <span class="keyword">sizeof</span>(<span class="keyword">float</span>));</span><br><span class="line"></span><br><span class="line">    double_buffer = (<span class="keyword">double</span> *)<span class="built_in">malloc</span>(<span class="number">1</span> * <span class="keyword">sizeof</span>(<span class="keyword">double</span>));</span><br><span class="line">    <span class="built_in">memset</span>(double_buffer, <span class="number">0</span>, <span class="number">1</span> * <span class="keyword">sizeof</span>(<span class="keyword">double</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">float</span> float_a = <span class="number">12345.0</span>;</span><br><span class="line">    <span class="keyword">double</span> double_a = <span class="number">12345.0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">float</span> *p_float_a = &amp;float_a;</span><br><span class="line">    <span class="keyword">double</span> *p_double_a = &amp;double_a;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(float_buffer, p_float_a, <span class="keyword">sizeof</span>(<span class="keyword">float</span>));</span><br><span class="line">    <span class="built_in">memcpy</span>(double_buffer, p_double_a, <span class="keyword">sizeof</span>(<span class="keyword">double</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"sizeof(float) is :%lu\n"</span>, <span class="keyword">sizeof</span>(<span class="keyword">float</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"sizeof(double) is :%lu\n"</span>, <span class="keyword">sizeof</span>(<span class="keyword">double</span>));</span><br><span class="line"></span><br><span class="line">    fp_out = fopen(argv[<span class="number">1</span>], <span class="string">"wb+"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fp_out) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Open outputfile error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fwrite(float_buffer, <span class="keyword">sizeof</span>(<span class="keyword">float</span>), <span class="number">1</span>, fp_out);</span><br><span class="line">    fwrite(double_buffer, <span class="keyword">sizeof</span>(<span class="keyword">double</span>), <span class="number">1</span>, fp_out);</span><br><span class="line">    <span class="built_in">free</span>(float_buffer);</span><br><span class="line">    <span class="built_in">free</span>(double_buffer);</span><br><span class="line">    fclose(fp_out);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>放栈区,放动态内存区对这个例子没有什么影响.</p>
<p>直接lldb分析.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) memory read -s <span class="number">1</span> -f x -c <span class="number">4</span> &amp;float_a</span><br><span class="line"><span class="number">0x7ffeefbff914</span>: <span class="number">0x00</span> <span class="number">0xe4</span> <span class="number">0x40</span> <span class="number">0x46</span></span><br><span class="line">(lldb) memory read -s <span class="number">1</span> -f x -c <span class="number">8</span> &amp;double_a</span><br><span class="line"><span class="number">0x7ffeefbff908</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x80</span> <span class="number">0x1c</span> <span class="number">0xc8</span> <span class="number">0x40</span></span><br></pre></td></tr></table></figure>
<p>说明是小端存储,浮点数的细节参考[IEEE754],[CSAPP]</p>
<p>下面这幅图来自于CSAPP,可以发现在整型和浮点数之间是有点关系的…</p>
<p><img src="http://pqnp708fx.bkt.clouddn.com/2019-04-28-%E6%B5%AE%E7%82%B9%E6%95%B0.png" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://mojiajun.github.io/post/22230d9.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mojiajun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mojiajun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/22230d9.html" itemprop="url">ffmpeg-AVBuffer-AVBufferRef-源码阅读</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-03T00:00:00+08:00">
                2018-12-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码阅读/" itemprop="url" rel="index">
                    <span itemprop="name">源码阅读</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码阅读/ffmpeg/" itemprop="url" rel="index">
                    <span itemprop="name">ffmpeg</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>FFMPEG-AVBuffer-AVBufferRef-源码阅读</p>
<p>参考了<a href="https://www.cnblogs.com/tocy/p/ffmpeg-libavutil-avbuffer-imp.html" target="_blank" rel="noopener">ffmpeg中AVBuffer的实现分析</a></p>
<p>下面这个分析的更好.<a href="https://blog.csdn.net/muyuyuzhong/article/details/79381152" target="_blank" rel="noopener">深入理解FFMPEG-AVBuffer/AVBufferRef/AVBufferPool</a></p>
<p>主要实现文件位于libavutil中的buffer.h、buffer_internal.h、buffer.c三个文件中。其中最主要的是两个结构<strong>AVBufferRef</strong>和<strong>AVBuffer</strong>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">libavutil/buffer_internal.h</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AVBuffer</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint8_t</span> *data; <span class="comment">/**&lt; data described by this buffer */</span></span><br><span class="line">    <span class="keyword">int</span>      size; <span class="comment">/**&lt; size of data in bytes */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  number of existing AVBufferRef instances referring to this buffer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">atomic_uint</span> refcount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * a callback for freeing the data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> (*<span class="built_in">free</span>)(<span class="keyword">void</span> *opaque, <span class="keyword">uint8_t</span> *data);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * an opaque pointer, to be used by the freeing callback</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> *opaque;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A combination of BUFFER_FLAG_*</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">AVBufferRef</span> &#123;</span></span><br><span class="line">    AVBuffer *buffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The data buffer. It is considered writable if and only if</span></span><br><span class="line"><span class="comment">     * this is the only reference to the buffer, in which case</span></span><br><span class="line"><span class="comment">     * av_buffer_is_writable() returns 1.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> *data;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Size of data in bytes.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span>      size;</span><br><span class="line">&#125; AVBufferRef;</span><br></pre></td></tr></table></figure>
<p>外部使用最好是通过AVBufferRef来引用数据.不然就丧失了这个设计的意义.(能保障当引用计数等于0时自动释放指定内存区域.)</p>
<p>av_buffer_alloc()</p>
<blockquote>
<p>调用了av_buffer_create()..把AVBufferRef和AVBuffer的data和size设成了一样的值</p>
<p>调用完成后返回一个AVBufferRef指针.<br>三次分配内存,1.实际数据存放的data指针,2.AVBufferRef结构体,3.AVBuffer结构体。</p>
</blockquote>
<p>av_buffer_allocz()只是在av_buffer_alloc()基础上加了一个把实际的数据域data初始化为0的过程.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">AVBufferRef *<span class="title">av_buffer_ref</span><span class="params">(AVBufferRef *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AVBufferRef *ret = av_mallocz(<span class="keyword">sizeof</span>(*ret));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ret)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    *ret = *buf;</span><br><span class="line"></span><br><span class="line">    atomic_fetch_add_explicit(&amp;buf-&gt;buffer-&gt;refcount, <span class="number">1</span>, memory_order_relaxed);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>av_buffer_ref()给AVBufferRef *buf创建一份AVBufferRef结构体的copy,然后返回这个AVBufferRef.但是没有拷贝底层数据,只是把原来的引用计数用原子操作加一.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">buffer_replace</span><span class="params">(AVBufferRef **dst, AVBufferRef **src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AVBuffer *b;</span><br><span class="line"></span><br><span class="line">    b = (*dst)-&gt;buffer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (src) &#123;</span><br><span class="line">        **dst = **src;</span><br><span class="line">        av_freep(src);</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">        av_freep(dst);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (atomic_fetch_add_explicit(&amp;b-&gt;refcount, <span class="number">-1</span>, memory_order_acq_rel) == <span class="number">1</span>) &#123;</span><br><span class="line">        b-&gt;<span class="built_in">free</span>(b-&gt;opaque, b-&gt;data);</span><br><span class="line">        av_freep(&amp;b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">	这个buffer_replace是一个实现函数,只能在buffer.c内部使用.(加了<span class="keyword">static</span>)</span><br><span class="line">	功能如其名,让**dst被**src取代,这是结构体本身的直接赋值(覆盖).分两种情况:一,如果src是<span class="literal">NULL</span>,那么直接把AVBufferRef **dst这个结构体释放掉;二,如果src这个二级指针不为空,那么就完成替换操作,同时释放掉src.</span><br><span class="line"> 	不管哪种情况,dst里面管理的AVBuffer里面的refcount都要减一,如果满足合适条件(这个条件没看懂,是减一后判断引用计数是不是等于<span class="number">1</span>?),就释放掉AVBuffer和buf.也就是释放掉AVBufferRef这个类似于智能指针底下管理的数据.</span><br><span class="line">    类似C++的智能指针.但是又有区别,从右到左的赋值没有增加右边的引用计数,反而把右边的释放了,正如replace含义.</span><br><span class="line">PS:</span><br><span class="line"><span class="number">1.</span>查阅文档,发现atomic_fetch_add_explicit()返回的是计算前的值,所以这里==<span class="number">1</span>也就不奇怪了.</span><br><span class="line">The value held previously be the atomic object pointed to by obj.</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void av_buffer_unref(AVBufferRef **buf)调用了buffer_replace(buf, NULL),也就是把buf直接释放掉了,只要调用buffer_replace()就会把引用计数减一,然后检测底层数据的引用数.如果没有被引用了,就把底层数据释放掉.</span><br><span class="line"></span><br><span class="line">av_buffer_ref()</span><br><span class="line">av_buffer_unref()这两函数操作的都是AVBufferRef,一个创建AVBufferRef,一个销毁AVBufferRef,要不要操作底层数据会根据引用计数自行判断.</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">av_buffer_is_writable</span><span class="params">(<span class="keyword">const</span> AVBufferRef *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (buf-&gt;buffer-&gt;flags &amp; AV_BUFFER_FLAG_READONLY)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> atomic_load(&amp;buf-&gt;buffer-&gt;refcount) == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">buffer要可写必须前提是flags不能是AV_BUFFER_FLAG_READONLY,然后引用计数必须是<span class="number">1.</span>也即是当前只有一个AVBufferRef在引用这块buffer,才处于可写状态.</span><br><span class="line">av_buffer_make_writable(AVBufferRef **pbuf)这个就另外建立了一套新的引用计数系统,当然计数为<span class="number">1.</span>把原来的pbuf里面的引用计数减一.</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">av_buffer_make_writable</span><span class="params">(AVBufferRef **pbuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AVBufferRef *newbuf, *buf = *pbuf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (av_buffer_is_writable(buf))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    newbuf = av_buffer_alloc(buf-&gt;size);<span class="comment">//分配三个东西(1.实际数据存放的data指针,2.AVBufferRef结构体,3.AVBuffer结构体。)的内存.创建一套新的引用计数系统.</span></span><br><span class="line">    <span class="keyword">if</span> (!newbuf)</span><br><span class="line">        <span class="keyword">return</span> AVERROR(ENOMEM);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(newbuf-&gt;data, buf-&gt;data, buf-&gt;size);<span class="comment">//把原来的buf-&gt;data拷贝到newbuf-&gt;data.</span></span><br><span class="line"></span><br><span class="line">    buffer_replace(pbuf, &amp;newbuf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">可以通过av_buffer_make_writable()来让其可写，该函数内部内部自动创建一个新的数据缓冲区，并且原来的AVBuffer引用计数<span class="number">-1.</span></span><br></pre></td></tr></table></figure>
<p>AVBufferPool还没分析.</p>
<p>然后这几个函数在哪被用到了还没看</p>
<p>libavutil/frame.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AVFrame</span><br><span class="line">av_frame_ref()</span><br><span class="line">av_frame_unref()</span><br></pre></td></tr></table></figure>
<p>libavcodec/avpacket.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AVPacket</span><br><span class="line">av_packet_ref()</span><br><span class="line">av_packet_unref()</span><br></pre></td></tr></table></figure>
<p>参考文献:<br>1.<a href="https://www.cnblogs.com/tocy/p/ffmpeg-libavutil-avbuffer-imp.html" target="_blank" rel="noopener">ffmpeg中AVBuffer的实现分析</a></p>
<p>2.<a href="https://blog.csdn.net/muyuyuzhong/article/details/79381152" target="_blank" rel="noopener">深入理解FFMPEG-AVBuffer/AVBufferRef/AVBufferPool</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">mojiajun</p>
              <p class="site-description motion-element" itemprop="description">莫佳骏学习笔记</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">mojiajun</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>








        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
