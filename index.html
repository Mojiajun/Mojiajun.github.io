<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="è«ä½³éªå­¦ä¹ ç¬”è®°">
<meta property="og:type" content="website">
<meta property="og:title" content="mojiajun">
<meta property="og:url" content="https://mojiajun.github.io/index.html">
<meta property="og:site_name" content="mojiajun">
<meta property="og:description" content="è«ä½³éªå­¦ä¹ ç¬”è®°">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mojiajun">
<meta name="twitter:description" content="è«ä½³éªå­¦ä¹ ç¬”è®°">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://mojiajun.github.io/">





  <title>mojiajun</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">mojiajun</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://mojiajun.github.io/post/d800d427.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mojiajun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mojiajun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/d800d427.html" itemprop="url">Leecode-BinaryTreeå‰åºä¸­åºååº(éé€’å½’+stack)å’Œ(MorrisTraversal)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-08T00:00:00+08:00">
                2019-08-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Leecode/" itemprop="url" rel="index">
                    <span itemprop="name">Leecode</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>åˆ†åˆ«æ˜¯Leecode94-144-145ä¸‰é“é¢˜,è¿™é‡Œä¸è®¨è®ºé€’å½’è°ƒç”¨(å¾ˆç®€å•).</p>
<h2 id="éé€’å½’-stack"><a href="#éé€’å½’-stack" class="headerlink" title="éé€’å½’+stack"></a>éé€’å½’+stack</h2><p>æ—¶é—´å¤æ‚åº¦O(n),ç©ºé—´å¤æ‚åº¦O(h),hæ˜¯æ ‘çš„é«˜åº¦</p>
<p>ä¸­åºå‰åºä»£ç ç»“æ„å·®ä¸å¤š,ååºåœ¨å®ƒä»¬çš„åŸºç¡€ä¸Šç¨å¾®æ”¹æ”¹.(ååºç¨å¾®éº»çƒ¦ç‚¹)</p>
<h3 id="ä¸­åº"><a href="#ä¸­åº" class="headerlink" title="ä¸­åº"></a>ä¸­åº</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; inorderTraversal(TreeNode* root) &#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; result;</span><br><span class="line">        <span class="keyword">if</span> (!root) <span class="keyword">return</span> result;</span><br><span class="line">        <span class="built_in">stack</span>&lt;TreeNode*&gt; bufstack;</span><br><span class="line">        TreeNode *cur = root;</span><br><span class="line">        <span class="keyword">while</span> (!bufstack.empty() || cur) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cur) &#123;</span><br><span class="line">                bufstack.push(cur);</span><br><span class="line">                cur = cur-&gt;left;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cur = bufstack.top();</span><br><span class="line">                result.push_back(cur-&gt;val);</span><br><span class="line">                bufstack.pop();</span><br><span class="line">                cur = cur-&gt;right;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="å‰åº"><a href="#å‰åº" class="headerlink" title="å‰åº"></a>å‰åº</h3><p>å’Œä¸­åºéå†åªå·®ä¸€è¡Œ.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; preorderTraversal(TreeNode* root) &#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; result;</span><br><span class="line">        <span class="keyword">if</span> (!root) <span class="keyword">return</span> result;</span><br><span class="line">        <span class="built_in">stack</span>&lt;TreeNode*&gt; bufstack;</span><br><span class="line">        TreeNode *cur = root;</span><br><span class="line">        <span class="keyword">while</span> (!bufstack.empty() || cur) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cur) &#123;</span><br><span class="line">                bufstack.push(cur);</span><br><span class="line">                result.push_back(cur-&gt;val);</span><br><span class="line">                cur = cur-&gt;left;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cur = bufstack.top();</span><br><span class="line">                bufstack.pop();</span><br><span class="line">                cur = cur-&gt;right;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="ååº"><a href="#ååº" class="headerlink" title="ååº"></a>ååº</h3><p>è¿™æ¬¡çš„å†™æ³•è¿˜æ˜¯ä¸å‰åºä¸­åºçš„å†™æ³•æœ‰äº›æ¥è¿‘çš„.å¥½è®°ç‚¹.åœ¨å‰åºä¸­åºçš„åŸºç¡€ä¸Šç¨å¾®æ”¹æ”¹.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; postorderTraversal(TreeNode* root) &#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; result;</span><br><span class="line">        <span class="keyword">if</span> (!root) <span class="keyword">return</span> result;</span><br><span class="line">        <span class="built_in">stack</span>&lt;TreeNode*&gt; bufstack;</span><br><span class="line">        TreeNode *cur = root;</span><br><span class="line">        TreeNode *lastcur;  <span class="comment">// è®°ä½curçš„ä¸Šä¸€ä¸ªä½ç½®</span></span><br><span class="line">        <span class="keyword">while</span> (!bufstack.empty() || cur) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cur) &#123;</span><br><span class="line">                bufstack.push(cur);</span><br><span class="line">                cur = cur-&gt;left;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                cur = bufstack.top();</span><br><span class="line">                bufstack.pop();</span><br><span class="line">                <span class="keyword">if</span> (!cur-&gt;right || cur-&gt;right == lastcur) &#123;</span><br><span class="line">                    result.push_back(cur-&gt;val);  </span><br><span class="line">                    <span class="comment">//å¦‚æœä¸Šä¸€æ¬¡è®¿é—®çš„æ˜¯å³èŠ‚ç‚¹,æˆ–è€…å³èŠ‚ç‚¹ä¸ºç©º,æ‰å¯ä»¥è®¿é—®è¿™ä¸ªèŠ‚ç‚¹. </span></span><br><span class="line">                    lastcur = cur;</span><br><span class="line">                    cur = <span class="literal">NULL</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    bufstack.push(cur);  </span><br><span class="line">                    <span class="comment">//å¦‚æœæ˜¯è¿™ç§æƒ…å†µ,å³èŠ‚ç‚¹å­˜åœ¨ä¸”è¿˜æ²¡è®¿é—®å³èŠ‚ç‚¹,é‚£ä¹ˆæ ¹èŠ‚ç‚¹è¦å†æ¬¡å…¥æ ˆ.// ä¸¤æ¬¡è¿›æ ˆ</span></span><br><span class="line">                    cur = cur-&gt;right;     </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>é’ˆå¯¹äºŒæ¬¡è¿›æ ˆçš„ä¼˜åŒ–.è§ä¸‹é¢ğŸ‘‡</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; postorderTraversal(TreeNode* root) &#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; result;</span><br><span class="line">        <span class="keyword">if</span> (!root) <span class="keyword">return</span> result;</span><br><span class="line">        <span class="built_in">stack</span>&lt;TreeNode*&gt; bufstack;</span><br><span class="line">        TreeNode *cur = root;</span><br><span class="line">        TreeNode *lastcur;  <span class="comment">// è®°ä½curçš„ä¸Šä¸€ä¸ªä½ç½®</span></span><br><span class="line">        <span class="keyword">while</span> (!bufstack.empty() || cur) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cur) &#123;</span><br><span class="line">                bufstack.push(cur);</span><br><span class="line">                cur = cur-&gt;left;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                cur = bufstack.top();</span><br><span class="line">                <span class="keyword">if</span> (!cur-&gt;right || cur-&gt;right == lastcur) &#123;</span><br><span class="line">                    result.push_back(cur-&gt;val);  <span class="comment">//å¦‚æœä¸Šä¸€æ¬¡è®¿é—®çš„æ˜¯å³èŠ‚ç‚¹,æˆ–è€…å³èŠ‚ç‚¹ä¸ºç©º,æ‰å¯ä»¥è®¿é—®è¿™ä¸ªèŠ‚ç‚¹. </span></span><br><span class="line">                    lastcur = cur;</span><br><span class="line">                    cur = <span class="literal">NULL</span>;</span><br><span class="line">                    bufstack.pop();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    cur = cur-&gt;right;     </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="MorrisTraversal"><a href="#MorrisTraversal" class="headerlink" title="MorrisTraversal"></a>MorrisTraversal</h2><p>æ—¶é—´å¤æ‚åº¦O(n),ç©ºé—´å¤æ‚åº¦O(1)</p>
<p>è¿™ä¸ªç®—æ³•é‡Œé¢è•´å«çš„æ€æƒ³å°±æ˜¯åˆ©ç”¨leaf-&gt;leftå’Œleaf-&gt;rightå®ç°â€çº¿ç´¢åŒ–â€,ä¸åˆ©ç”¨æ ˆä»è€Œæ‰¾åˆ°ç›¸åº”çš„çˆ¶èŠ‚ç‚¹.åœ¨è¿™ä¸‰ç§Morriséå†é‡Œé¢,éƒ½åªç”¨äº†leaf-&gt;right,å……åˆ†åˆ©ç”¨å·²æœ‰çš„èµ„æº!é™ä½äº†ç©ºé—´å¤æ‚åº¦,å˜æˆO(1),å¾ˆå‰å®³!</p>
<ul>
<li>ä¸‰ç§MorrisTraversalå®ç°(å‰åºä¸­åºååº)éƒ½åªç”¨äº†leaf-&gt;right</li>
<li>åˆ©ç”¨leafçš„å³å­©å­ä½œä¸ºçº¿ç´¢,æŒ‡å‘åœ¨è¿™ä¸ªleafä¹‹åçš„çˆ¶èŠ‚ç‚¹çš„ä½ç½®,å’Œæœ¬ç§‘æ•°æ®ç»“æ„ä¹¦(æ¯”å¦‚ä¸¥è”šæ•æ•°æ®ç»“æ„)è®²çš„é‚£ç§çº¿ç´¢äºŒå‰æ ‘ç±»ä¼¼,ä½†æ˜¯!MorrisTraversalè¿™é‡Œçš„èŠ‚ç‚¹æ˜¯ä¸‹é¢è¿™æ ·å®šä¹‰çš„,å¹¶æ²¡æœ‰å¤šå‡ºltagå’Œrtag,è€Œä¸¥è”šæ•æ•°æ®ç»“æ„çš„èŠ‚ç‚¹å®šä¹‰æœ‰è¿™ä¸¤ä¸ª,æ‰€ä»¥è¿™ä¸ªMorrisTraversalæ–¹æ³•æ˜¯çœŸçš„å‰å®³.æœ¬è´¨æ€æƒ³å·®ä¸å¤š,éƒ½æ˜¯â€çº¿ç´¢åŒ–â€.</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TreeNode</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> val;</span><br><span class="line">    TreeNode *left;</span><br><span class="line">    TreeNode *right;</span><br><span class="line">    TreeNode(<span class="keyword">int</span> x) : val(x), left(<span class="literal">NULL</span>), right(<span class="literal">NULL</span>) &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>è¿™ç§æ–¹æ³•[å‰åºä¸­åºååºä»£ç å®ç°çš„åŸºæœ¬ç»“æ„å·®ä¸å¤š]æ˜¯åœ¨Leecodeè¿™æ ·çš„TreeNodeå®šä¹‰çš„åŸºç¡€ä¸Š,åœ¨éå†è¿‡ç¨‹ä¸­,å¯¹leaf-&gt;rightæ·»åŠ çˆ¶èŠ‚ç‚¹ä½ç½®,ç„¶ååœ¨ç¬¬äºŒæ¬¡curåˆå›æ¥çš„æ—¶å€™,ç”¨pre-&gt;right = NULL;è¿›è¡Œè¿˜åŸ,æ‰€ä»¥åªåœ¨éå†çš„è¿‡ç¨‹ä¸­ä¼šä½¿å¾—è¿™æ£µæ ‘çš„leaf-&gt;rightäº§ç”Ÿäº›è®¸å˜åŒ–.éå†å®Œäº†åˆæ¢å¤è¿‡æ¥.[ä¼šå¯¼è‡´æ ‘åœ¨éå†è¿‡ç¨‹ä¸­è¢«æ”¹å˜.è¿™æ˜¯å’Œé€’å½’è§£æ³•,éé€’å½’-stackè§£æ³•ä¸åŒçš„ä¸€ç‚¹.]</p>
</li>
<li><p>è¿™ç§æ–¹æ³•æœ€å¤§çš„ä¼˜ç‚¹æ˜¯ç©ºé—´å¤æ‚åº¦æ˜¯O(1),constantçº§çš„ç©ºé—´å¤æ‚åº¦</p>
</li>
</ul>
<h3 id="ä¸­åº-Morris-inorder-traversal"><a href="#ä¸­åº-Morris-inorder-traversal" class="headerlink" title="ä¸­åº-Morris inorder traversal"></a>ä¸­åº-Morris inorder traversal</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; inorderTraversal(TreeNode* root) &#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; result;</span><br><span class="line">        <span class="keyword">if</span> (!root) <span class="keyword">return</span> result;</span><br><span class="line">        TreeNode *cur, *pre;</span><br><span class="line">        cur = root;</span><br><span class="line">        <span class="keyword">while</span>(cur) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cur-&gt;left) &#123;</span><br><span class="line">                pre = cur-&gt;left;</span><br><span class="line">                <span class="keyword">while</span> (pre-&gt;right &amp;&amp; pre-&gt;right != cur) pre = pre-&gt;right;</span><br><span class="line">                <span class="keyword">if</span> (!pre-&gt;right) &#123;</span><br><span class="line">                    pre-&gt;right = cur;</span><br><span class="line">                    cur = cur-&gt;left;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;  <span class="comment">// pre-&gt;rightä¸ä¸ºç©º,ä»£è¡¨è¢«ç¬¬ä¸€æ¬¡åˆ°è¿™æ—¶å¡«å……è¿‡äº†,ç„¶åå»æ‰å®ƒ(è¿˜åŸ)</span></span><br><span class="line">                    pre-&gt;right = <span class="literal">NULL</span>;</span><br><span class="line">                    result.push_back(cur-&gt;val);</span><br><span class="line">                    cur = cur-&gt;right;</span><br><span class="line">                &#125;   </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result.push_back(cur-&gt;val);</span><br><span class="line">                cur = cur-&gt;right;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å®ç°åŠç†è§£trick:ä¾‹å¦‚åœ¨çº¸ä¸Šç”»ä¸€é¢—è¿™æ ·çš„æ ‘:[1,2,3,4,5,6,null]-(ç±»ä¼¼leecodeé‡Œçš„é¢˜é‚£ä¹ˆè¡¨ç¤ºæ ‘),ç„¶åæ€è€ƒcurå’Œpreçš„ä½ç½®å˜åŒ–æƒ…å†µ,ç»“åˆè¾“å‡ºç»“æœ,[425163]æœ€å¥½å½¢è±¡ç†è§£.æƒ³è±¡è¿™é¢—æ ‘åº•ä¸‹è¿˜æœ‰å¾ˆå¤šèŠ‚ç‚¹ä¹Ÿæ˜¯ä¸€æ ·çš„.ä»£ç éƒ½æ˜¯èµ·ä½œç”¨çš„,ç„¶åå¤šå†™å‡ éå°±æ˜ç™½äº†â€¦é‡ç‚¹æ˜¯å¯¹æ•´ä¸ªè¿‡ç¨‹åœ¨è„‘æµ·ä¸­å½¢è±¡ç†è§£.ç„¶åä½“ä¼šcurå’ŒpreèŠ‚ç‚¹çš„ä½œç”¨</p>
<h3 id="å‰åº-Morris-preorder-traversal"><a href="#å‰åº-Morris-preorder-traversal" class="headerlink" title="å‰åº-Morris preorder traversal"></a>å‰åº-Morris preorder traversal</h3><p>ä»å‰åºç‰ˆæœ¬çš„Morris traversalä»£ç æ”¹è¿‡æ¥çš„,ä»£ç åªå·®äº†ä¸€è¡Œ</p>
<p>å½»åº•ç†è§£ä¸Šé¢ä¸­åºçš„è¿‡ç¨‹å,ç„¶åæ€è€ƒä¸‹,æŠŠresult.push_back(cur-&gt;val);è¿™æ ·çš„ä»£ç åˆ é™¤,æ”¹æˆå‰åºçš„å…³é”®å°±æ˜¯æŠŠresult.push_back(cur-&gt;val);çš„ä½ç½®å˜åˆ°curç¬¬ä¸€æ¬¡ç¢°åˆ°(!pre-&gt;right)çš„æ—¶å€™é‚£é‡Œ.</p>
<p>ä¹Ÿå°±æ˜¯</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; preorderTraversal(TreeNode* root) &#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; result;</span><br><span class="line">        <span class="keyword">if</span> (!root) <span class="keyword">return</span> result;</span><br><span class="line">        TreeNode *cur, *pre;</span><br><span class="line">        cur = root;</span><br><span class="line">        <span class="keyword">while</span>(cur) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cur-&gt;left) &#123;</span><br><span class="line">                pre = cur-&gt;left;</span><br><span class="line">                <span class="keyword">while</span> (pre-&gt;right &amp;&amp; pre-&gt;right != cur) pre = pre-&gt;right;</span><br><span class="line">                <span class="keyword">if</span> (!pre-&gt;right) &#123;</span><br><span class="line">                    result.push_back(cur-&gt;val);</span><br><span class="line">                    pre-&gt;right = cur;</span><br><span class="line">                    cur = cur-&gt;left;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;  <span class="comment">// pre-&gt;rightä¸ä¸ºç©º,ä»£è¡¨è¢«ç¬¬ä¸€æ¬¡åˆ°è¿™æ—¶å¡«å……è¿‡äº†,ç„¶åå»æ‰å®ƒ(è¿˜åŸ)</span></span><br><span class="line">                    pre-&gt;right = <span class="literal">NULL</span>;</span><br><span class="line">                    cur = cur-&gt;right;</span><br><span class="line">                &#125;   </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result.push_back(cur-&gt;val);</span><br><span class="line">                cur = cur-&gt;right;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>åªæœ‰ä¸€è¡Œä»£ç ä¸åŒ.å‰©ä¸‹çš„result.push_back(cur-&gt;val);æ€è€ƒä¸‹ä¸ºä»€ä¹ˆä¸ç”¨æ”¹å˜ä½ç½®?<br>è¿™ç§curèŠ‚ç‚¹ä¸å­˜åœ¨curåˆ°è¿™é‡Œä¸¤æ¬¡,åªåˆ°è¿™é‡Œä¸€æ¬¡,æ‰€ä»¥åœ¨å‰åºä¸­åºéƒ½æ˜¯åœ¨è¿™é‡Œresult.push_back(cur-&gt;val);<br>è¿™ç§èŠ‚ç‚¹å°±æ˜¯æ ‘:[1,2,3,4,5,6,null]é‡Œçš„èŠ‚ç‚¹4è¿™æ ·çš„èŠ‚ç‚¹.</p>
<p>è¿™ç§èŠ‚ç‚¹æœ‰ä»€ä¹ˆç‰¹ç‚¹?cur-&gt;leftä¸ºNULL!</p>
<h3 id="ååº-Morris-postorder-traversal"><a href="#ååº-Morris-postorder-traversal" class="headerlink" title="ååº-Morris postorder traversal"></a>ååº-Morris postorder traversal</h3><p>Morris postorder traversalå®ç°æ¯”å‰åºä¸­åºéº»çƒ¦åœ¨å¤šäº†ä¸ªreverseAddNodes()å’Œä¸€ä¸ªdummyèŠ‚ç‚¹</p>
<p>ç¨‹åºä¸»ä½“å’ŒMorris in-order traversal,Morris pre-order traversalå·®ä¸å¤š.å¤šäº†ä¸ªreverseAddNodes(cur-&gt;left, pre, result);è¿™é‡Œæœ€å¥½ç»“åˆå›¾æ¥çœ‹â€¦ä¸‹é¢ğŸ‘‡è¿™ä½æœ‹å‹ååºçš„å›¾ç”»çš„ä¸é”™,å¯ä»¥ä½œä¸ºMorris postorder traversalç†è§£çš„å‚è€ƒ</p>
<p><a href="https://www.cnblogs.com/AnnieKim/archive/2013/06/15/MorrisTraversal.html" target="_blank" rel="noopener">Annie Kimâ€™s Blog-Morris Traversalæ–¹æ³•éå†äºŒå‰æ ‘ï¼ˆéé€’å½’ï¼Œä¸ç”¨æ ˆï¼ŒO(1)ç©ºé—´ï¼‰</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; postorderTraversal(TreeNode* root) &#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; result;</span><br><span class="line">        <span class="keyword">if</span> (!root) <span class="keyword">return</span> result;</span><br><span class="line">        <span class="function">TreeNode <span class="title">dummy</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line">        dummy.left = root;</span><br><span class="line">        TreeNode *cur = &amp;dummy, *pre;</span><br><span class="line">        <span class="keyword">while</span>(cur) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cur-&gt;left) &#123;</span><br><span class="line">                pre = cur-&gt;left;</span><br><span class="line">                <span class="keyword">while</span> (pre-&gt;right &amp;&amp; pre-&gt;right != cur) pre = pre-&gt;right;</span><br><span class="line">                <span class="keyword">if</span> (!pre-&gt;right) &#123;</span><br><span class="line">                    pre-&gt;right = cur;</span><br><span class="line">                    cur = cur-&gt;left;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;  <span class="comment">// pre-&gt;rightä¸ä¸ºç©º,ä»£è¡¨è¢«ç¬¬ä¸€æ¬¡åˆ°è¿™æ—¶å¡«å……è¿‡äº†,ç„¶åå»æ‰å®ƒ(è¿˜åŸ)</span></span><br><span class="line">                    reverseAddNodes(cur-&gt;left, pre, result);</span><br><span class="line">                    pre-&gt;right = <span class="literal">NULL</span>;</span><br><span class="line">                    cur = cur-&gt;right;</span><br><span class="line">                &#125;   </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cur = cur-&gt;right;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reverseNodes</span><span class="params">(TreeNode* start, TreeNode* end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (start == end) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        TreeNode* x = start;</span><br><span class="line">        TreeNode* y = start-&gt;right;</span><br><span class="line">        TreeNode* z;</span><br><span class="line">        <span class="keyword">while</span> (x != end) &#123;</span><br><span class="line">            z = y-&gt;right;</span><br><span class="line">            y-&gt;right = x;</span><br><span class="line">            x = y;</span><br><span class="line">            y = z;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reverseAddNodes</span><span class="params">(TreeNode* start, TreeNode* end, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; result)</span> </span>&#123;</span><br><span class="line">        reverseNodes(start, end);</span><br><span class="line">        TreeNode* node = end;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            result.push_back(node-&gt;val);</span><br><span class="line">            <span class="keyword">if</span> (node == start) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            node = node-&gt;right;</span><br><span class="line">        &#125;</span><br><span class="line">        reverseNodes(end, start);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>reverseAddNodes()è¿™ä¸ªè¿‡ç¨‹,å¯ä»¥ä¸reverseå—???</p>
<p>ä¿®æ”¹æˆç”¨ä¸€ä¸ªä¸´æ—¶vectorä»£æ›¿reverseNodeså‡½æ•°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; postorderTraversal(TreeNode* root) &#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; result;</span><br><span class="line">        <span class="keyword">if</span> (!root) <span class="keyword">return</span> result;</span><br><span class="line">        <span class="function">TreeNode <span class="title">dummy</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line">        dummy.left = root;</span><br><span class="line">        TreeNode *cur = &amp;dummy, *pre;</span><br><span class="line">        <span class="keyword">while</span>(cur) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cur-&gt;left) &#123;</span><br><span class="line">                pre = cur-&gt;left;</span><br><span class="line">                <span class="keyword">while</span> (pre-&gt;right &amp;&amp; pre-&gt;right != cur) pre = pre-&gt;right;</span><br><span class="line">                <span class="keyword">if</span> (!pre-&gt;right) &#123;</span><br><span class="line">                    pre-&gt;right = cur;</span><br><span class="line">                    cur = cur-&gt;left;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;  <span class="comment">// pre-&gt;rightä¸ä¸ºç©º,ä»£è¡¨è¢«ç¬¬ä¸€æ¬¡åˆ°è¿™æ—¶å¡«å……è¿‡äº†,ç„¶åå»æ‰å®ƒ(è¿˜åŸ)</span></span><br><span class="line">                    reverseAddNodes(cur-&gt;left, pre, result);</span><br><span class="line">                    pre-&gt;right = <span class="literal">NULL</span>;</span><br><span class="line">                    cur = cur-&gt;right;</span><br><span class="line">                &#125;   </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cur = cur-&gt;right;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reverseAddNodes</span><span class="params">(TreeNode* start, TreeNode* end, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; result)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; temp;</span><br><span class="line">        TreeNode* node = start;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            temp.push_back(node-&gt;val);</span><br><span class="line">            <span class="keyword">if</span> (node == end) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            node = node-&gt;right;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> iter = temp.rbegin(); iter != temp.rend(); ++iter) &#123;</span><br><span class="line">            result.push_back(*iter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<hr>
<p>morrisæ˜¯è°?</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://mojiajun.github.io/post/3b45df5e.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mojiajun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mojiajun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/3b45df5e.html" itemprop="url">C++-è™šå‡½æ•°æœºåˆ¶-01</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-22T00:00:00+08:00">
                2019-07-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C++</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<p>è¿™ç¯‡æ˜¯è™šå‡½æ•°è¡¨vtblå’Œè™šè¡¨æŒ‡é’ˆvptrçš„åŸºç¡€.åŸºæœ¬è®¤çŸ¥,é‡‡ç”¨çš„æ˜¯è°ƒè¯•å™¨åæ±‡ç¼–çœ‹åº•å±‚çš„æ–¹å¼.é¢å¤–æäº†ä¸‹ç©ºç±».</p>
<p>æµ‹è¯•ç¯å¢ƒ:<br>x86-64<br>Ubuntu 18.04.2 LTS<br>cat /proc/version</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Linux version 4.15.0-48-generic (buildd@lgw01-amd64-036) (gcc version 7.3.0 (Ubuntu 7.3.0-16ubuntu3)) <span class="comment">#51-Ubuntu SMP Wed Apr 3 08:28:49 UTC 2019</span></span><br></pre></td></tr></table></figure>
<h3 id="è™šå‡½æ•°è¡¨"><a href="#è™šå‡½æ•°è¡¨" class="headerlink" title="è™šå‡½æ•°è¡¨"></a>è™šå‡½æ•°è¡¨</h3><p>è™šå‡½æ•°æœºåˆ¶(æ²¡åˆ†æç»§æ‰¿)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">virtual_func_test01.cc</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CVirtual</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">GetNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> _nNumber;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetNumber</span><span class="params">(<span class="keyword">int</span> nNumber)</span> </span>&#123;</span><br><span class="line">      _nNumber = nNumber;</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">int</span> _nNumber;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> nSizeOfCVirtual = <span class="keyword">sizeof</span>(CVirtual);</span><br><span class="line">    <span class="keyword">int</span> nSizeOfPointer = <span class="keyword">sizeof</span>(<span class="keyword">int</span> *);</span><br><span class="line">    <span class="comment">//printf("the size of CVirtual (in BYTE) is : %d\n", nSizeOfCVirtual);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘:g++ -g -o virtual_func_test01 virtual_func_test01.cc<br>è°ƒè¯•:lldb ./virtual_func_test01</p>
<p>mainè¿™é‡Œæ‰“ä¸ªæ–­ç‚¹.ç„¶ååæ±‡ç¼–ä¸€ä¸‹.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(lldb) dis</span><br><span class="line">virtual_func_test01`main:</span><br><span class="line">    0x5555555545fa &lt;+0&gt;:  pushq  %rbp</span><br><span class="line">    0x5555555545fb &lt;+1&gt;:  movq   %rsp, %rbp</span><br><span class="line">    0x5555555545fe &lt;+4&gt;:  movl   $0x10, -0x8(%rbp)</span><br><span class="line">    0x555555554605 &lt;+11&gt;: movl   $0x8, -0x4(%rbp)</span><br><span class="line">-&gt;  0x55555555460c &lt;+18&gt;: movl   $0x0, %eax</span><br><span class="line">    0x555555554611 &lt;+23&gt;: popq   %rbp</span><br><span class="line">    0x555555554612 &lt;+24&gt;: retq</span><br></pre></td></tr></table></figure>
<p>ç»“æœåˆ†åˆ«æ˜¯(åè¿›åˆ¶)16å’Œ8<br>æ¶‰åŠ rbp,rsp æ ˆå‘ä½åœ°å€ç”Ÿé•¿,eax(è¿”å›å€¼å¸¸ç”¨çš„å¯„å­˜å™¨,è§CSAPPç¬¬ä¸‰ç« ),ATTæ ¼å¼æ±‡ç¼–ç­‰åŸºç¡€.è¿™é‡Œä¸æäº†.</p>
<hr>
<p>ä¿®æ”¹ä¸€ä¸‹ä»£ç ,åˆ›å»ºä¸€ä¸ªæ ˆä¸Šçš„å¯¹è±¡testObj.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">CVirtual <span class="title">testObj</span><span class="params">(<span class="number">10324</span>)</span></span>;</span><br><span class="line">    testObj.SetNumber(<span class="number">200</span>);</span><br><span class="line">    testObj.GetNumber();</span><br><span class="line">    CVirtual *ptestObj = &amp;testObj;</span><br><span class="line">    <span class="keyword">int</span> nSizeOfCVirtual = <span class="keyword">sizeof</span>(CVirtual);</span><br><span class="line">    <span class="keyword">int</span> nSizeOfPointer = <span class="keyword">sizeof</span>(<span class="keyword">int</span> *);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è²Œä¼¼lldbæ²¡æ‰¾åˆ°gdb info vtblç±»ä¼¼çš„å‘½ä»¤,æ‰€ä»¥åœ¨è¿™é‡Œç”¨gdbæŸ¥çœ‹ä¸€ä¸‹vtbl(è¦ç­‰CVirtualçš„æ„é€ å‡½æ•°æ‰§è¡Œå®Œ,å¦åˆ™vtblé‡Œé¢çš„åœ°å€ä¸å¯¹,ç›¸å½“äºè¿˜æ²¡åˆå§‹åŒ–å¥½.).</p>
<p>ç„¶ååæ±‡ç¼–mainå‡½æ•°,é¡ºä¾¿ç”¨info vtbl testObjæŸ¥çœ‹ä¸€ä¸‹è™šå‡½æ•°è¡¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble main</span><br><span class="line">Dump of assembler code for function main():</span><br><span class="line">   0x000055555555475a &lt;+0&gt;:	push   %rbp</span><br><span class="line">   0x000055555555475b &lt;+1&gt;:	mov    %rsp,%rbp</span><br><span class="line">   0x000055555555475e &lt;+4&gt;:	sub    $0x30,%rsp</span><br><span class="line">   0x0000555555554762 &lt;+8&gt;:	mov    %fs:0x28,%rax</span><br><span class="line">   0x000055555555476b &lt;+17&gt;:	mov    %rax,-0x8(%rbp)</span><br><span class="line">   0x000055555555476f &lt;+21&gt;:	xor    %eax,%eax</span><br><span class="line">   0x0000555555554771 &lt;+23&gt;:	lea    -0x20(%rbp),%rax</span><br><span class="line">   0x0000555555554775 &lt;+27&gt;:	mov    $0x2854,%esi</span><br><span class="line">   0x000055555555477a &lt;+32&gt;:	mov    %rax,%rdi</span><br><span class="line">   0x000055555555477d &lt;+35&gt;:	callq  0x5555555547d0 &lt;CVirtual::CVirtual(int)&gt;</span><br><span class="line">   0x0000555555554782 &lt;+40&gt;:	lea    -0x20(%rbp),%rax</span><br><span class="line">   0x0000555555554786 &lt;+44&gt;:	mov    $0xc8,%esi</span><br><span class="line">   0x000055555555478b &lt;+49&gt;:	mov    %rax,%rdi</span><br><span class="line">   0x000055555555478e &lt;+52&gt;:	callq  0x555555554808 &lt;CVirtual::SetNumber(int)&gt;</span><br><span class="line">   0x0000555555554793 &lt;+57&gt;:	lea    -0x20(%rbp),%rax</span><br><span class="line">   0x0000555555554797 &lt;+61&gt;:	mov    %rax,%rdi</span><br><span class="line">   0x000055555555479a &lt;+64&gt;:	callq  0x5555555547f6 &lt;CVirtual::GetNumber()&gt;</span><br><span class="line">   0x000055555555479f &lt;+69&gt;:	lea    -0x20(%rbp),%rax</span><br><span class="line">   0x00005555555547a3 &lt;+73&gt;:	mov    %rax,-0x28(%rbp)</span><br><span class="line">   0x00005555555547a7 &lt;+77&gt;:	movl   $0x10,-0x30(%rbp)</span><br><span class="line">   0x00005555555547ae &lt;+84&gt;:	movl   $0x8,-0x2c(%rbp)</span><br><span class="line">=&gt; 0x00005555555547b5 &lt;+91&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x00005555555547ba &lt;+96&gt;:	mov    -0x8(%rbp),%rdx</span><br><span class="line">   0x00005555555547be &lt;+100&gt;:	xor    %fs:0x28,%rdx</span><br><span class="line">   0x00005555555547c7 &lt;+109&gt;:	je     0x5555555547ce &lt;main()+116&gt;</span><br><span class="line">   0x00005555555547c9 &lt;+111&gt;:	callq  0x555555554630 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">   0x00005555555547ce &lt;+116&gt;:	leaveq</span><br><span class="line">   0x00005555555547cf &lt;+117&gt;:	retq</span><br><span class="line">End of assembler dump.</span><br><span class="line"></span><br><span class="line">(gdb) info vtbl testObj</span><br><span class="line">vtable for &apos;CVirtual&apos; @ 0x555555754d98 (subobject @ 0x7fffffffe470):</span><br><span class="line">[0]: 0x5555555547f6 &lt;CVirtual::GetNumber()&gt;</span><br><span class="line">[1]: 0x555555554808 &lt;CVirtual::SetNumber(int)&gt;</span><br><span class="line">åˆšå¥½å°±æ˜¯mainé‡Œé¢callqçš„å‡½æ•°åœ°å€.// subobject @ 0x7fffffffe470 gdbæ‰“å°çš„testObjå¯¹è±¡çš„åœ°å€</span><br></pre></td></tr></table></figure>
<hr>
<p>ç„¶åçœ‹ä¸€ä¸‹è¿™ä¸ªtestObjå å¤šå¤§?å¯¹è±¡çš„åœ°å€åœ¨å“ª?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x ptestObj</span><br><span class="line"> :	0x55754d98</span><br><span class="line">//ptestObjæŒ‡é’ˆåœ¨mainå¸§é‡Œé¢,æ ˆä¸Šé¢çš„å˜é‡.è¿™ä¸ªæŒ‡é’ˆçš„å€¼æ˜¯0x7fffffffe470,ä¹Ÿå°±æ˜¯testObjçš„åœ°å€.æ³¨æ„åé¢çš„0x55754d98æ˜¯0x7fffffffe470æŒ‡å‘çš„ä½ç½®çš„å†…å®¹(ä¹Ÿå°±æ˜¯vtblçš„å€¼)</span><br></pre></td></tr></table></figure>
<p>åˆå› ä¸ºtestObjåœ¨æ ˆä¸Šå 16å­—èŠ‚<br>ç„¶åè¯»ä¸€ä¸‹è¿™å—å†…å­˜çš„å†…å®¹,æ³¨æ„è¾“å‡ºæ˜¯å°ç«¯.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/16xb 0x7fffffffe470</span><br><span class="line">0x7fffffffe470:	0x98	0x4d	0x75	0x55	0x55	0x55	0x00	0x00</span><br><span class="line">0x7fffffffe478:	0xc8	0x00	0x00	0x00	0x55	0x55	0x00	0x00</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºsizeof(int) == 4å­—èŠ‚.åœ¨ç›®å‰çš„æœºå™¨çš„å®ç°ä¸Šå‰8ä¸ªå­—èŠ‚å­˜çš„æ˜¯æŒ‡å‘vtblçš„vptr.<br>vptrå­˜çš„åœ°å€æ˜¯0x00005555 55754d98.<br>0xc8 0x00 0x00 0x00æ˜¯åé¢è°ƒç”¨testObj.SetNumber(200);å­˜å…¥çš„200,è¿˜æœ‰å››ä¸ªå­—èŠ‚ä¼°è®¡å’Œå¯¹é½æœ‰å…³?</p>
<p>ç„¶åæŠŠè™šå‡½æ•°è¡¨é‡Œé¢çš„å†…å®¹è¯»å‡ºæ¥çœ‹çœ‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/32xb 0x0000555555754d98</span><br><span class="line">0x555555754d98 &lt;_ZTV8CVirtual+16&gt;:	0xf6	0x47	0x55	0x55	0x55	0x55	0x00	0x00</span><br><span class="line">0x555555754da0 &lt;_ZTV8CVirtual+24&gt;:	0x08	0x48	0x55	0x55	0x55	0x55	0x00	0x00</span><br><span class="line">0x555555754da8 &lt;_ZTI8CVirtual&gt;:	0xf8	0x67	0xdc	0xf7	0xff	0x7f	0x00	0x00</span><br><span class="line">0x555555754db0 &lt;_ZTI8CVirtual+8&gt;:	0xa8	0x48	0x55	0x55	0x55	0x55	0x00	0x00</span><br></pre></td></tr></table></figure>
<p>å‰ä¸¤é¡¹è¾“å‡ºå’Œgdb info vtalç»“æœä¸€æ ·.</p>
<p>æœ€åçœ‹çœ‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[0]: 0x5555555547f6 &lt;CVirtual::GetNumber()&gt;</span><br><span class="line">[1]: 0x555555554808 &lt;CVirtual::SetNumber(int)&gt;</span><br><span class="line">è¿™ä¸¤ä¸ªå‡½æ•°çš„å†…å®¹å­˜åœ¨å“ªäº†.</span><br></pre></td></tr></table></figure>
<p>disassemble 0x5555555547f6 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/64x 0x5555555547f6</span><br><span class="line">0x5555555547f6 &lt;CVirtual::GetNumber()&gt;:	0x55	0x48	0x89	0xe5	0x48	0x89	0x7d	0xf8</span><br><span class="line">0x5555555547fe &lt;CVirtual::GetNumber()+8&gt;:	0x48	0x8b	0x45	0xf8	0x8b	0x40	0x08	0x5d</span><br><span class="line">0x555555554806 &lt;CVirtual::GetNumber()+16&gt;:	0xc3	0x90	0x55	0x48	0x89	0xe5	0x48	0x89</span><br><span class="line">0x55555555480e &lt;CVirtual::SetNumber(int)+6&gt;:	0x7d	0xf8	0x89	0x75	0xf4	0x48	0x8b	0x45</span><br><span class="line">0x555555554816 &lt;CVirtual::SetNumber(int)+14&gt;:	0xf8	0x8b	0x55	0xf4	0x89	0x50	0x08	0x90</span><br><span class="line">0x55555555481e &lt;CVirtual::SetNumber(int)+22&gt;:	0x5d	0xc3	0x41	0x57	0x41	0x56	0x49	0x89</span><br><span class="line">0x555555554826 &lt;__libc_csu_init+6&gt;:	0xd7	0x41	0x55	0x41	0x54	0x4c	0x8d	0x25</span><br><span class="line">0x55555555482e &lt;__libc_csu_init+14&gt;:	0x46	0x05	0x20	0x00	0x55	0x48	0x8d	0x2d</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble 0x5555555547f6</span><br><span class="line">Dump of assembler code for function CVirtual::GetNumber():</span><br><span class="line">   0x00005555555547f6 &lt;+0&gt;:		push   %rbp</span><br><span class="line">   0x00005555555547f7 &lt;+1&gt;:		mov    %rsp,%rbp</span><br><span class="line">   0x00005555555547fa &lt;+4&gt;:		mov    %rdi,-0x8(%rbp)</span><br><span class="line">   0x00005555555547fe &lt;+8&gt;:		mov    -0x8(%rbp),%rax</span><br><span class="line">   0x0000555555554802 &lt;+12&gt;:	mov    0x8(%rax),%eax</span><br><span class="line">   0x0000555555554805 &lt;+15&gt;:	pop    %rbp</span><br><span class="line">   0x0000555555554806 &lt;+16&gt;:	retq</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>
<p>åŒç†[1]: 0x555555554808 <a href="CVirtual::SetNumber(int)" target="_blank" rel="noopener">CVirtual::SetNumber(int)</a>ä¸åœ¨è¿™é‡Œåˆ—ä¸¾äº†.<br>æœ€åçš„æœ€å,çœ‹çœ‹åœ¨ELFæ–‡ä»¶é‡Œé¢è¿™ä¸¤å‡½æ•°åœ¨å“ª.readelfå‘½ä»¤çœ‹,ä½†æ˜¯æ˜¾ç¤ºçš„åŠ è½½åœ°å€éƒ½æ¯”è¾ƒå°.ä¸è°ƒè¯•å™¨é‡Œé¢çš„ä¸ç¬¦.1.<a href="https://www.martinkysel.com/demystifying-virtual-tables-in-c-part-1-trivial-constructors/" target="_blank" rel="noopener">Demystifying Virtual Tables In C++</a>è¿™ä¸ªäººåˆ†æå´æ˜¯ä¸€æ ·çš„.è€ç‰ˆæœ¬çš„ä¸æ˜¯è¿™æ ·çš„å•Š.ä»€ä¹ˆæƒ…å†µâ€¦åŠ è½½å™¨éƒ½å¹²äº†äº›ä»€ä¹ˆâ€¦ç®—äº†,å…ˆä¸åˆ†æè¿™é‡Œäº†.åç»­å†çœ‹äº†.</p>
<h3 id="ç©ºç±»"><a href="#ç©ºç±»" class="headerlink" title="ç©ºç±»"></a>ç©ºç±»</h3><p>å‚è€ƒ<a href="http://www.stroustrup.com/bs_faq2.html#sizeof-empty" target="_blank" rel="noopener">Bjarne Stroustrup-Why is the size of an empty class not zero?</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Empty</span> &#123;</span> &#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Empty a, b;</span><br><span class="line">	Empty *pa = &amp;a;</span><br><span class="line">	Empty *pb = &amp;b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    f();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(lldb) frame variable</span><br><span class="line">(Empty) a = &#123;&#125;</span><br><span class="line">(Empty) b = &#123;&#125;</span><br><span class="line">(Empty *) pa = 0x00007fffffffe4a6</span><br><span class="line">(Empty *) pb = 0x00007fffffffe4a7</span><br><span class="line">(lldb) expression &amp;a</span><br><span class="line">(Empty *) <span class="variable">$0</span> = 0x00007fffffffe4a6</span><br><span class="line">(lldb) expression &amp;b</span><br><span class="line">(Empty *) <span class="variable">$1</span> = 0x00007fffffffe4a7</span><br><span class="line">(lldb) memory <span class="built_in">read</span> --size 1 --format x --count 1 0x00007fffffffe4a6</span><br><span class="line">0x7fffffffe4a6: 0x00</span><br><span class="line">(lldb) memory <span class="built_in">read</span> --size 1 --format x --count 1 0x00007fffffffe4a7</span><br><span class="line">0x7fffffffe4a7: 0x00</span><br></pre></td></tr></table></figure>
<p>åœ¨æˆ‘çš„è¿™å°æœºå™¨ä¸Šç©ºç±»çš„å¯¹è±¡å ä¸€ä¸ªå­—èŠ‚.å­—èŠ‚å†…å®¹æŸ¥çœ‹æ˜¯0x00.<br>å¾ˆå¥‡æ€ªçš„ä¸€ç‚¹æ˜¯,æ²¡æœ‰Empty <em>pa = &a;Empty </em>pb = &b;è¿™ä¸¤è¡Œçš„è¯ç”¨è°ƒè¯•å™¨çœ‹expression &amp;aå’Œexpression &amp;bæ˜¯ä¸€æ ·çš„?</p>
<p>1.å¦‚æœæ˜¯å§åœ°å€å–å‡ºæ¥Empty <em>pa = &a;Empty </em>pb = &b;åƒè¿™æ ·,ä¸ç®¡è°ƒè¯•å™¨è¿˜æ˜¯ç›´æ¥æ‰“å°å‡ºæ¥,paå’Œpbéƒ½ä¼šæ˜¯ä¸åŒçš„åœ°å€.<br>2.å¦‚æœæŒ‰Bjarne Stroustrupç»™çš„ä¾‹å­,è¿›è¡Œifæµ‹è¯•,ä¹Ÿæ˜¯ä¸ä¼šç›¸åŒçš„.</p>
<hr>
<p>ä½†æ˜¯å¦‚æœæ˜¯empty base class,é‚£ä¹ˆä¼šæœ‰ä¸€ä¸ªç¼–è¯‘å™¨çš„ä¼˜åŒ–,å«åšempty base class optimization</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cout</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Empty</span> &#123;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">X</span> :</span> Empty &#123;</span><br><span class="line">        <span class="keyword">int</span> a;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(X* p)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">void</span>* p1 = p;</span><br><span class="line">        <span class="keyword">void</span>* p2 = &amp;p-&gt;a;</span><br><span class="line">        <span class="keyword">if</span> (p1 == p2) <span class="built_in">cout</span> &lt;&lt; <span class="string">"nice: good optimizer\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    X testObj;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"sizeof X %d\n"</span>, <span class="keyword">sizeof</span>(X));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"sizeof testObj %d\n"</span>, <span class="keyword">sizeof</span>(testObj));</span><br><span class="line">    f(&amp;testObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º:</p>
<p>sizeof X 4<br>sizeof testObj 4<br>nice: good optimizer</p>
<hr>
<p>å‚è€ƒ:</p>
<p>1.<a href="https://www.martinkysel.com/demystifying-virtual-tables-in-c-part-1-trivial-constructors/" target="_blank" rel="noopener">Demystifying Virtual Tables In C++</a></p>
<p>2.<a href="http://www.stroustrup.com/bs_faq2.html#sizeof-empty" target="_blank" rel="noopener">Bjarne Stroustrup-Why is the size of an empty class not zero?</a></p>
<p>3.åæ±‡ç¼–ä¸é€†å‘åˆ†ææŠ€æœ¯æ­ç§˜</p>
<p>4.æ·±å…¥æ¢ç´¢C++å¯¹è±¡æ¨¡å‹</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://mojiajun.github.io/post/a24c8ee4.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mojiajun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mojiajun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/a24c8ee4.html" itemprop="url">C++-è™šå‡½æ•°æœºåˆ¶-02</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-22T00:00:00+08:00">
                2019-07-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C++</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>åæ±‡ç¼–ä¸é€†å‘åˆ†ææŠ€æœ¯æ­ç§˜ç¬¬åä¸€ç« è™šå‡½æ•°<br>é˜…è¯»åŠç”¨x86-64-g++å¹³å°åˆ†æ</p>
<p>è¿™ç¯‡ä¸»è¦æ˜¯æ„é€ å‡½æ•°å’Œææ„å‡½æ•°å’Œvtbl,vptrçš„è”ç³».(å°±æ˜¯æŠŠåæ±‡ç¼–ä¸é€†å‘åˆ†ææŠ€æœ¯æ­ç§˜ç¬¬åä¸€ç« è™šå‡½æ•°11.1èŠ‚ç”¨x86-64 linux ATTæ±‡ç¼–æ ¼å¼è¿‡äº†ä¸€éâ€¦)</p>
<p>è¿™ç¯‡è¿˜æ²¡æ¶‰åŠç»§æ‰¿â€¦</p>
<p>[TOC]</p>
<h3 id="æ„é€ å‡½æ•°å’Œvptr"><a href="#æ„é€ å‡½æ•°å’Œvptr" class="headerlink" title="æ„é€ å‡½æ•°å’Œvptr"></a>æ„é€ å‡½æ•°å’Œvptr</h3><hr>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CVirtual</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">GetNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> _nNumber;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetNumber</span><span class="params">(<span class="keyword">int</span> nNumber)</span> </span>&#123;</span><br><span class="line">      _nNumber = nNumber;</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">int</span> _nNumber;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CVirtual testObj;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble main</span><br><span class="line">Dump of assembler code for function main():</span><br><span class="line">   0x000055555555475a &lt;+0&gt;:	push   %rbp</span><br><span class="line">   0x000055555555475b &lt;+1&gt;:	mov    %rsp,%rbp</span><br><span class="line">   0x000055555555475e &lt;+4&gt;:	sub    $0x20,%rsp</span><br><span class="line">   0x0000555555554762 &lt;+8&gt;:	mov    %fs:0x28,%rax</span><br><span class="line">   0x000055555555476b &lt;+17&gt;:	mov    %rax,-0x8(%rbp)</span><br><span class="line">   0x000055555555476f &lt;+21&gt;:	xor    %eax,%eax</span><br><span class="line">   0x0000555555554771 &lt;+23&gt;:	lea    -0x20(%rbp),%rax</span><br><span class="line">=&gt; 0x0000555555554775 &lt;+27&gt;:	mov    %rax,%rdi</span><br><span class="line">   0x0000555555554778 &lt;+30&gt;:	callq  0x5555555547c2 &lt;CVirtual::CVirtual()&gt;</span><br><span class="line">   0x000055555555477d &lt;+35&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x0000555555554782 &lt;+40&gt;:	mov    -0x8(%rbp),%rdx</span><br><span class="line">   0x0000555555554786 &lt;+44&gt;:	xor    %fs:0x28,%rdx</span><br><span class="line">   0x000055555555478f &lt;+53&gt;:	je     0x555555554796 &lt;main()+60&gt;</span><br><span class="line">   0x0000555555554791 &lt;+55&gt;:	callq  0x555555554630 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">   0x0000555555554796 &lt;+60&gt;:	leaveq</span><br><span class="line">   0x0000555555554797 &lt;+61&gt;:	retq</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x $rax  # testObjå¯¹è±¡åœ°å€</span><br><span class="line">0x7fffffffe470:	0xe0</span><br><span class="line">(gdb) info vtbl testObj</span><br><span class="line">vtable for &apos;CVirtual&apos; @ 0x5555555547e0 (subobject @ 0x7fffffffe470):</span><br><span class="line">[0]: 0x41d7894956415741</span><br><span class="line">[1]: 0x586258d4c544155</span><br><span class="line"># @ 0x5555555547e0æ˜¯ä¸èƒ½ç”¨çš„.å› ä¸ºè¿˜æ²¡æœ‰æ‰§è¡Œå®Œcallq  0x5555555547c2 &lt;CVirtual::CVirtual()&gt;,</span><br><span class="line"># åªæœ‰å½“æ‰§è¡Œå®Œ&lt;CVirtual::CVirtual()&gt;,æ‰ç®—æ˜¯å®Œæ•´çš„æ„é€ å¥½äº†å¯¹è±¡.å¦åˆ™,åˆ«ç”¨gdb info vtbl.</span><br><span class="line"># æ„é€ å®Œæˆä¹‹åè°ƒç”¨info vtbl testObjçš„ç»“æœ,å‘ç°@ 0x555555754d98æ‰æ˜¯vptræ­£ç¡®çš„å€¼!!!</span><br><span class="line">(gdb) info vtbl testObj</span><br><span class="line">vtable for &apos;CVirtual&apos; @ 0x555555754d98 (subobject @ 0x7fffffffe470):</span><br><span class="line">[0]: 0x555555554798 &lt;CVirtual::GetNumber()&gt;</span><br><span class="line">[1]: 0x5555555547aa &lt;CVirtual::SetNumber(int)&gt;</span><br></pre></td></tr></table></figure>
<p>åœ¨callq  0x5555555547c2 <a href="CVirtual::CVirtual()" target="_blank" rel="noopener">CVirtual::CVirtual()</a>ä¹‹å‰,éœ€è¦æŠŠtestObjçš„åœ°å€(å¤„äºå¯¹è±¡å·²ç»æœ‰å†…å­˜äº†,ä½†æ˜¯vptrè¿˜æ²¡åˆå§‹åŒ–çš„çŠ¶æ€,å³[åŠå®Œæˆå“]å¯¹è±¡)æ”¾å…¥%rdi.è¿™ä¸ªåœ°æ–¹è°ƒç”¨çš„åˆæˆçš„é»˜è®¤æ„é€ å‡½æ•°.ä¹Ÿå°±æ˜¯åœ¨callq CVirtual::CVirtual(),éœ€è¦å…ˆæ‹¿åˆ°thisæŒ‡é’ˆé€åˆ°%rdiå¯„å­˜å™¨.</p>
<p>ç„¶åæ˜¯åˆæˆçš„é»˜è®¤æ„é€ å‡½æ•°å†…å®¹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble 0x5555555547c2</span><br><span class="line">Dump of assembler code for function CVirtual::CVirtual():</span><br><span class="line">   0x00005555555547c2 &lt;+0&gt;:	push   %rbp</span><br><span class="line">   0x00005555555547c3 &lt;+1&gt;:	mov    %rsp,%rbp</span><br><span class="line">   0x00005555555547c6 &lt;+4&gt;:	mov    %rdi,-0x8(%rbp)  #æŠŠ%rdié‡Œé¢çš„thisæŒ‡é’ˆå­˜åˆ°-0x8(%rbp)</span><br><span class="line">   0x00005555555547ca &lt;+8&gt;:	lea    0x2005c7(%rip),%rdx        # 0x555555754d98 &lt;_ZTV8CVirtual+16&gt;          # æŠŠ0x555555754d98è¿™ä¸ªè™šå‡½æ•°è¡¨çš„åœ°å€é€åˆ°%rdx</span><br><span class="line">   0x00005555555547d1 &lt;+15&gt;:	mov    -0x8(%rbp),%rax</span><br><span class="line">   0x00005555555547d5 &lt;+19&gt;:	mov    %rdx,(%rax)  # æŠŠè™šå‡½æ•°è¡¨åœ°å€0x555555754d98å¡«å…¥thisæŒ‡é’ˆçš„å¯¹è±¡çš„å‰8ä¸ªå­—èŠ‚(ä¹Ÿå³å­˜å…¥è™šè¡¨æŒ‡é’ˆé‡Œ).</span><br><span class="line">   0x00005555555547d8 &lt;+22&gt;:	nop</span><br><span class="line">   0x00005555555547d9 &lt;+23&gt;:	pop    %rbp</span><br><span class="line">   0x00005555555547da &lt;+24&gt;:	retq</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªåˆæˆçš„é»˜è®¤æ„é€ å‡½æ•°åªå¹²äº†ä¸€ä»¶äº‹,é‚£å°±æ˜¯æŠŠclass CVirtualçš„è™šè¡¨åœ°å€å¡«å…¥å¯¹è±¡çš„vptræŒ‡é’ˆ.</p>
<p>ä¸ç®¡testObjå¯¹è±¡åˆ›å»ºä¸åˆ›å»º.class CVirtualçš„è™šè¡¨åœ¨ç¨‹åºåŠ è½½å¥½äº†ä¹‹åå°±åœ¨å†…å­˜é‡Œäº†.<br>é€šè¿‡x/16xb 0x555555754d98(è™šè¡¨åœ°å€)å°±èƒ½æŸ¥çœ‹è™šè¡¨çš„å†…å®¹.ä¸€ä¸ªç±»çš„å¤šä¸ªä¸åŒå¯¹è±¡æ˜¯å…±äº«åŒä¸€å¼ è™šè¡¨çš„.åªéœ€è¦åœ¨è°ƒç”¨æ„é€ å‡½æ•°çš„æ—¶å€™æŠŠè™šè¡¨åœ°å€å¡«å…¥å¯¹è±¡çš„vptrå³å¯.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/16xb 0x555555754d98</span><br><span class="line">0x555555754d98 &lt;_ZTV8CVirtual+16&gt;:	0x98	0x47	0x55	0x55	0x55	0x55	0x00	0x00</span><br><span class="line">0x555555754da0 &lt;_ZTV8CVirtual+24&gt;:	0xaa	0x47	0x55	0x55	0x55	0x55	0x00	0x00</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="objectç›´æ¥è°ƒç”¨-ç”¨â€™-â€™"><a href="#objectç›´æ¥è°ƒç”¨-ç”¨â€™-â€™" class="headerlink" title="objectç›´æ¥è°ƒç”¨(ç”¨â€™.â€™)"></a>objectç›´æ¥è°ƒç”¨(ç”¨â€™.â€™)</h3><p>å¦‚æœæ˜¯testObj.SetNumber(200)å’ŒtestObj.GetNumber()</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CVirtual testObj;</span><br><span class="line">    testObj.SetNumber(<span class="number">200</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\r\n"</span>, testObj.GetNumber());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble main</span><br><span class="line">Dump of assembler code for function main():</span><br><span class="line">   0x00005555555547aa &lt;+0&gt;:	push   %rbp</span><br><span class="line">   0x00005555555547ab &lt;+1&gt;:	mov    %rsp,%rbp</span><br><span class="line">   0x00005555555547ae &lt;+4&gt;:	sub    $0x20,%rsp</span><br><span class="line">=&gt; 0x00005555555547b2 &lt;+8&gt;:	mov    %fs:0x28,%rax</span><br><span class="line">   0x00005555555547bb &lt;+17&gt;:	mov    %rax,-0x8(%rbp)</span><br><span class="line">   0x00005555555547bf &lt;+21&gt;:	xor    %eax,%eax</span><br><span class="line">   0x00005555555547c1 &lt;+23&gt;:	lea    -0x20(%rbp),%rax</span><br><span class="line">   0x00005555555547c5 &lt;+27&gt;:	mov    %rax,%rdi</span><br><span class="line">   0x00005555555547c8 &lt;+30&gt;:	callq  0x555555554842 &lt;CVirtual::CVirtual()&gt;</span><br><span class="line">   0x00005555555547cd &lt;+35&gt;:	lea    -0x20(%rbp),%rax  # thisæŒ‡é’ˆæ”¾å…¥%rax</span><br><span class="line">   0x00005555555547d1 &lt;+39&gt;:	mov    $0xc8,%esi  # 200æ”¾å…¥%esi</span><br><span class="line">   0x00005555555547d6 &lt;+44&gt;:	mov    %rax,%rdi  # %raxä¸­çš„thisæŒ‡é’ˆè½¬ç§»åˆ°%rdi </span><br><span class="line">   0x00005555555547d9 &lt;+47&gt;:	callq  0x55555555482a &lt;CVirtual::SetNumber(int)&gt;</span><br><span class="line">   0x00005555555547de &lt;+52&gt;:	lea    -0x20(%rbp),%rax</span><br><span class="line">   0x00005555555547e2 &lt;+56&gt;:	mov    %rax,%rdi</span><br><span class="line">   0x00005555555547e5 &lt;+59&gt;:	callq  0x555555554818 &lt;CVirtual::GetNumber()&gt;</span><br><span class="line">   0x00005555555547ea &lt;+64&gt;:	mov    %eax,%esi</span><br><span class="line">   0x00005555555547ec &lt;+66&gt;:	lea    0xf1(%rip),%rdi        # 0x5555555548e4</span><br><span class="line">   0x00005555555547f3 &lt;+73&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x00005555555547f8 &lt;+78&gt;:	callq  0x555555554670 &lt;printf@plt&gt;</span><br><span class="line">   0x00005555555547fd &lt;+83&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x0000555555554802 &lt;+88&gt;:	mov    -0x8(%rbp),%rdx</span><br><span class="line">   0x0000555555554806 &lt;+92&gt;:	xor    %fs:0x28,%rdx</span><br><span class="line">   0x000055555555480f &lt;+101&gt;:	je     0x555555554816 &lt;main()+108&gt;</span><br><span class="line">   0x0000555555554811 &lt;+103&gt;:	callq  0x555555554680 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">   0x0000555555554816 &lt;+108&gt;:	leaveq</span><br><span class="line">   0x0000555555554817 &lt;+109&gt;:	retq</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„testObj.SetNumber(200)å’ŒtestObj.GetNumber()çš„è°ƒç”¨éƒ½æ˜¯ç›´æ¥è°ƒç”¨,ç”¨çš„<br>callq  0x55555555482aå’Œcallq  0x555555554818.</p>
<blockquote>
<p>  ç›´æ¥è°ƒç”¨è¿™æ ·ä¸èƒ½å¤šæ€,ä¸¾ä¸€ä¸ªæœ‰ç»§æ‰¿çš„ä¾‹å­,overrideè™šå‡½æ•°çš„ä¾‹å­?</p>
</blockquote>
<p>CVirtual::SetNumber(int)çš„æ±‡ç¼–åˆ†æ,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble 0x55555555482a</span><br><span class="line">Dump of assembler code for function CVirtual::SetNumber(int):</span><br><span class="line">   0x000055555555482a &lt;+0&gt;:	push   %rbp</span><br><span class="line">   0x000055555555482b &lt;+1&gt;:	mov    %rsp,%rbp</span><br><span class="line">   0x000055555555482e &lt;+4&gt;:	mov    %rdi,-0x8(%rbp)  # ç¬¬ä¸€ä¸ªå‚æ•°thisæŒ‡é’ˆæ”¾å…¥-0x8(%rbp)</span><br><span class="line">   0x0000555555554832 &lt;+8&gt;:	mov    %esi,-0xc(%rbp)  # %esiæ˜¯ç¬¬äºŒä¸ªå‚æ•°,å¦‚æœæ˜¯</span><br><span class="line">   													  	# SetNumerber(200),%esié‡Œé¢å°±æ˜¯200</span><br><span class="line">   0x0000555555554835 &lt;+11&gt;:	mov    -0x8(%rbp),%rax  </span><br><span class="line">   0x0000555555554839 &lt;+15&gt;:	mov    -0xc(%rbp),%edx</span><br><span class="line">   0x000055555555483c &lt;+18&gt;:	mov    %edx,0x8(%rax)  # æŠŠç¬¬äºŒä¸ªå‚æ•°é‡Œé¢è¦è®¾ç½®çš„å€¼æ”¾å…¥</span><br><span class="line">   												# 0x8(%rax), å³å¯¹è±¡çš„é¦–åœ°å€åç§»8ä¸ªå­—èŠ‚çš„ä½ç½®.</span><br><span class="line">   												# å³privateå˜é‡_nNumberçš„ä½ç½®.</span><br><span class="line">   0x000055555555483f &lt;+21&gt;:	nop</span><br><span class="line">   0x0000555555554840 &lt;+22&gt;:	pop    %rbp</span><br><span class="line">   0x0000555555554841 &lt;+23&gt;:	retq</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>
<h3 id="objectæŒ‡é’ˆ-ç”¨â€™-gt-â€™-å’Œå¼•ç”¨-â€˜ref-â€™-è°ƒç”¨"><a href="#objectæŒ‡é’ˆ-ç”¨â€™-gt-â€™-å’Œå¼•ç”¨-â€˜ref-â€™-è°ƒç”¨" class="headerlink" title="objectæŒ‡é’ˆ(ç”¨â€™-&gt;â€™)å’Œå¼•ç”¨(â€˜ref.â€™)è°ƒç”¨"></a>objectæŒ‡é’ˆ(ç”¨â€™-&gt;â€™)å’Œå¼•ç”¨(â€˜ref.â€™)è°ƒç”¨</h3><p>ä¸‹é¢æ¯”è¾ƒä¸‹ç›´æ¥å¯¹è±¡è°ƒç”¨(ç”¨â€™.â€™)å’ŒæŒ‡é’ˆè°ƒç”¨å’Œå¼•ç”¨è°ƒç”¨çš„åŒºåˆ«?</p>
<h4 id="æŒ‡é’ˆè°ƒç”¨"><a href="#æŒ‡é’ˆè°ƒç”¨" class="headerlink" title="æŒ‡é’ˆè°ƒç”¨"></a>æŒ‡é’ˆè°ƒç”¨</h4><p>å…ˆæŒ‡é’ˆè°ƒç”¨åˆ†æ</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CVirtual</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">GetNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> _nNumber;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetNumber</span><span class="params">(<span class="keyword">int</span> nNumber)</span> </span>&#123;</span><br><span class="line">      _nNumber = nNumber;</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">int</span> _nNumber;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CVirtual *ptestObj = <span class="keyword">new</span> CVirtual();</span><br><span class="line">    ptestObj-&gt;SetNumber(<span class="number">200</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\r\n"</span>, ptestObj-&gt;GetNumber());</span><br><span class="line">    <span class="keyword">delete</span> ptestObj;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble main</span><br><span class="line">Dump of assembler code for function main():</span><br><span class="line">   0x00005555555547fa &lt;+0&gt;:	push   %rbp</span><br><span class="line">   0x00005555555547fb &lt;+1&gt;:	mov    %rsp,%rbp</span><br><span class="line">   0x00005555555547fe &lt;+4&gt;:	push   %rbx</span><br><span class="line">   0x00005555555547ff &lt;+5&gt;:	sub    $0x18,%rsp</span><br><span class="line">=&gt; 0x0000555555554803 &lt;+9&gt;:	mov    $0x10,%edi</span><br><span class="line">   0x0000555555554808 &lt;+14&gt;:	callq  0x5555555546c0 &lt;_Znwm@plt&gt;</span><br><span class="line">   0x000055555555480d &lt;+19&gt;:	mov    %rax,%rbx</span><br><span class="line">   0x0000555555554810 &lt;+22&gt;:	movq   $0x0,(%rbx)</span><br><span class="line">   0x0000555555554817 &lt;+29&gt;:	movl   $0x0,0x8(%rbx)</span><br><span class="line">   0x000055555555481e &lt;+36&gt;:	mov    %rbx,%rdi</span><br><span class="line">   0x0000555555554821 &lt;+39&gt;:	callq  0x5555555548b4 &lt;CVirtual::CVirtual()&gt;</span><br><span class="line">   0x0000555555554826 &lt;+44&gt;:	mov    %rbx,-0x18(%rbp)   # thisæŒ‡é’ˆ</span><br><span class="line">   0x000055555555482a &lt;+48&gt;:	mov    -0x18(%rbp),%rax	  # %raxç°åœ¨å­˜çš„æ˜¯å¯¹è±¡çš„é¦–åœ°å€</span><br><span class="line">   0x000055555555482e &lt;+52&gt;:	mov    (%rax),%rax		  # æŠŠå¯¹è±¡é¦–åœ°å€æŒ‡å‘çš„ä¸œè¥¿(å³vptr)æ”¾å…¥rax</span><br><span class="line">   0x0000555555554831 &lt;+55&gt;:	add    $0x8,%rax		  # vptr + 8, </span><br><span class="line">   # åŸå› åœ¨äºSetNumber(int)ç±»ä¸­å£°æ˜é¡ºåºåœ¨GetNumber()åé¢,æ‰€ä»¥åœ¨vtblé‡Œåœ¨GetNumber()åé¢,</span><br><span class="line">   # è€Œvtblæ˜¯ä¸€ä¸ªä¸ªå‡½æ•°æŒ‡é’ˆç»„æˆçš„åˆ—è¡¨.x86-64ä¸€ä¸ªæŒ‡é’ˆå 8å­—èŠ‚,æ‰€ä»¥vptr + 8</span><br><span class="line">   0x0000555555554835 &lt;+59&gt;:	mov    (%rax),%rax		  # æ‰¾åˆ°ä½ç½®äº†,ç„¶åæŠŠvptr + 8è¿™ä¸ªä½ç½®çš„å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆå–å‡ºæ¥æ”¾å…¥rax</span><br><span class="line">   0x0000555555554838 &lt;+62&gt;:	mov    -0x18(%rbp),%rdx</span><br><span class="line">   0x000055555555483c &lt;+66&gt;:	mov    $0xc8,%esi		  # ç¬¬äºŒä¸ªå‚æ•°200å³0xc8</span><br><span class="line">   0x0000555555554841 &lt;+71&gt;:	mov    %rdx,%rdi		  # thisæŒ‡é’ˆé€å…¥%rdi</span><br><span class="line">   0x0000555555554844 &lt;+74&gt;:	callq  *%rax # è°ƒç”¨SetNumber(int)</span><br><span class="line">   0x0000555555554846 &lt;+76&gt;:	mov    -0x18(%rbp),%rax</span><br><span class="line">   0x000055555555484a &lt;+80&gt;:	mov    (%rax),%rax   # æŠŠå¯¹è±¡é¦–åœ°å€æŒ‡å‘çš„ä¸œè¥¿(å³vptr)æ”¾å…¥rax</span><br><span class="line">   0x000055555555484d &lt;+83&gt;:	mov    (%rax),%rax   # æŠŠvptr + 0è¿™ä¸ªä½ç½®çš„å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆå–å‡ºæ¥æ”¾å…¥rax, å³GetNumber()</span><br><span class="line">   0x0000555555554850 &lt;+86&gt;:	mov    -0x18(%rbp),%rdx</span><br><span class="line">   0x0000555555554854 &lt;+90&gt;:	mov    %rdx,%rdi</span><br><span class="line">   0x0000555555554857 &lt;+93&gt;:	callq  *%rax</span><br><span class="line">   0x0000555555554859 &lt;+95&gt;:	mov    %eax,%esi</span><br><span class="line">   0x000055555555485b &lt;+97&gt;:	lea    0xf2(%rip),%rdi        # 0x555555554954</span><br><span class="line">   0x0000555555554862 &lt;+104&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x0000555555554867 &lt;+109&gt;:	callq  0x5555555546b0 &lt;printf@plt&gt;</span><br><span class="line">   0x000055555555486c &lt;+114&gt;:	mov    -0x18(%rbp),%rax</span><br><span class="line">   0x0000555555554870 &lt;+118&gt;:	mov    $0x10,%esi</span><br><span class="line">   0x0000555555554875 &lt;+123&gt;:	mov    %rax,%rdi</span><br><span class="line">   0x0000555555554878 &lt;+126&gt;:	callq  0x5555555546d0 &lt;_ZdlPvm@plt&gt;</span><br><span class="line">   0x000055555555487d &lt;+131&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x0000555555554882 &lt;+136&gt;:	add    $0x18,%rsp</span><br><span class="line">   0x0000555555554886 &lt;+140&gt;:	pop    %rbx</span><br><span class="line">   0x0000555555554887 &lt;+141&gt;:	pop    %rbp</span><br><span class="line">   0x0000555555554888 &lt;+142&gt;:	retq</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>
<h4 id="å¼•ç”¨è°ƒç”¨"><a href="#å¼•ç”¨è°ƒç”¨" class="headerlink" title="å¼•ç”¨è°ƒç”¨"></a>å¼•ç”¨è°ƒç”¨</h4><p>å¼•ç”¨è°ƒç”¨åˆ†æ,</p>
<p>æœ¬æ¥ä»¥ä¸ºè¿™æ ·å°±ä¼šåƒæŒ‡é’ˆé‚£æ ·é—´æ¥è°ƒç”¨äº†.æ²¡æƒ³åˆ°ä¸æ˜¯â€¦C++ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CVirtual</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">GetNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> _nNumber;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetNumber</span><span class="params">(<span class="keyword">int</span> nNumber)</span> </span>&#123;</span><br><span class="line">      _nNumber = nNumber;</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">int</span> _nNumber;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CVirtual testObj;</span><br><span class="line">    CVirtual &amp;rtestObj = testObj;</span><br><span class="line">    rtestObj.SetNumber(<span class="number">200</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\r\n"</span>, rtestObj.GetNumber());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åæ±‡ç¼–ä¹‹å,å‘ç°è¿™ä¸å’Œobjectç›´æ¥è°ƒç”¨(ç”¨â€™.â€™)å‡ ä¹ä¸€æ ·å—â€¦<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble main</span><br><span class="line">Dump of assembler code for function main():</span><br><span class="line">   0x00005555555547aa &lt;+0&gt;:	push   %rbp</span><br><span class="line">   0x00005555555547ab &lt;+1&gt;:	mov    %rsp,%rbp</span><br><span class="line">   0x00005555555547ae &lt;+4&gt;:	sub    $0x30,%rsp</span><br><span class="line">=&gt; 0x00005555555547b2 &lt;+8&gt;:	mov    %fs:0x28,%rax  # ?</span><br><span class="line">   0x00005555555547bb &lt;+17&gt;:	mov    %rax,-0x8(%rbp)</span><br><span class="line">   0x00005555555547bf &lt;+21&gt;:	xor    %eax,%eax</span><br><span class="line">   0x00005555555547c1 &lt;+23&gt;:	lea    -0x20(%rbp),%rax</span><br><span class="line">   0x00005555555547c5 &lt;+27&gt;:	mov    %rax,%rdi</span><br><span class="line">   0x00005555555547c8 &lt;+30&gt;:	callq  0x55555555484a &lt;CVirtual::CVirtual()&gt;</span><br><span class="line">   0x00005555555547cd &lt;+35&gt;:	lea    -0x20(%rbp),%rax  # objectåœ°å€é€å…¥rax</span><br><span class="line">   0x00005555555547d1 &lt;+39&gt;:	mov    %rax,-0x28(%rbp)  # å»ºç«‹å¼•ç”¨rtestObj,å³-0x28(%rbp)</span><br><span class="line">   0x00005555555547d5 &lt;+43&gt;:	mov    -0x28(%rbp),%rax  # ä¸‹é¢çš„ä»£ç ç­‰åŒäºç›´æ¥å¯¹è±¡è°ƒç”¨(ç”¨&apos;.&apos;çš„é‚£ç§)</span><br><span class="line">   0x00005555555547d9 &lt;+47&gt;:	mov    $0xc8,%esi</span><br><span class="line">   0x00005555555547de &lt;+52&gt;:	mov    %rax,%rdi</span><br><span class="line">   0x00005555555547e1 &lt;+55&gt;:	callq  0x555555554832 &lt;CVirtual::SetNumber(int)&gt;</span><br><span class="line">   0x00005555555547e6 &lt;+60&gt;:	mov    -0x28(%rbp),%rax</span><br><span class="line">   0x00005555555547ea &lt;+64&gt;:	mov    %rax,%rdi</span><br><span class="line">   0x00005555555547ed &lt;+67&gt;:	callq  0x555555554820 &lt;CVirtual::GetNumber()&gt;</span><br><span class="line">   0x00005555555547f2 &lt;+72&gt;:	mov    %eax,%esi</span><br><span class="line">   0x00005555555547f4 &lt;+74&gt;:	lea    0xf9(%rip),%rdi        # 0x5555555548f4</span><br><span class="line">   0x00005555555547fb &lt;+81&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x0000555555554800 &lt;+86&gt;:	callq  0x555555554670 &lt;printf@plt&gt;</span><br><span class="line">   0x0000555555554805 &lt;+91&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x000055555555480a &lt;+96&gt;:	mov    -0x8(%rbp),%rdx</span><br><span class="line">   0x000055555555480e &lt;+100&gt;:	xor    %fs:0x28,%rdx</span><br><span class="line">   0x0000555555554817 &lt;+109&gt;:	je     0x55555555481e &lt;main()+116&gt;</span><br><span class="line">   0x0000555555554819 &lt;+111&gt;:	callq  0x555555554680 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">   0x000055555555481e &lt;+116&gt;:	leaveq</span><br><span class="line">   0x000055555555481f &lt;+117&gt;:	retq</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure></p>
<p>ä½†æ˜¯æ”¹æˆå †å¯¹è±¡å</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CVirtual</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">GetNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> _nNumber;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetNumber</span><span class="params">(<span class="keyword">int</span> nNumber)</span> </span>&#123;</span><br><span class="line">      _nNumber = nNumber;</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">int</span> _nNumber;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CVirtual *ptestObj = <span class="keyword">new</span> CVirtual();</span><br><span class="line">    CVirtual &amp;rtestObj = *ptestObj;</span><br><span class="line">    rtestObj.SetNumber(<span class="number">200</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\r\n"</span>, rtestObj.GetNumber());</span><br><span class="line">    <span class="keyword">delete</span> ptestObj;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åæ±‡ç¼–ä¹‹å,è¿™ç§å’ŒæŒ‡é’ˆè°ƒç”¨è™šå‡½æ•°çš„æ–¹æ³•ä¸€æ ·,éƒ½æ˜¯é—´æ¥è°ƒç”¨,æ‹¿åˆ°å¯¹è±¡çš„vptræŒ‡å‘çš„å‡½æ•°æŒ‡é’ˆè¡¨é‡Œé¢çš„æŸä¸€é¡¹.ç„¶åè°ƒç”¨å®ƒ.(callq  *%rax)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble main</span><br><span class="line">Dump of assembler code for function main():</span><br><span class="line">   0x00005555555547fa &lt;+0&gt;:	push   %rbp</span><br><span class="line">   0x00005555555547fb &lt;+1&gt;:	mov    %rsp,%rbp</span><br><span class="line">   0x00005555555547fe &lt;+4&gt;:	push   %rbx</span><br><span class="line">   0x00005555555547ff &lt;+5&gt;:	sub    $0x18,%rsp</span><br><span class="line">=&gt; 0x0000555555554803 &lt;+9&gt;:	mov    $0x10,%edi</span><br><span class="line">   0x0000555555554808 &lt;+14&gt;:	callq  0x5555555546c0 &lt;_Znwm@plt&gt; # è¿™é‡Œåº”è¯¥æ˜¯åˆ†é…å †å†…å­˜çš„é‚£ä¸ªå‡½æ•°</span><br><span class="line">   0x000055555555480d &lt;+19&gt;:	mov    %rax,%rbx  # è¿”å›çš„æŒ‡é’ˆå­˜åœ¨äº†%rax,ç„¶åé€å…¥%rbx</span><br><span class="line">   0x0000555555554810 &lt;+22&gt;:	movq   $0x0,(%rbx)</span><br><span class="line">   0x0000555555554817 &lt;+29&gt;:	movl   $0x0,0x8(%rbx)</span><br><span class="line">   0x000055555555481e &lt;+36&gt;:	mov    %rbx,%rdi</span><br><span class="line">   0x0000555555554821 &lt;+39&gt;:	callq  0x5555555548bc &lt;CVirtual::CVirtual()&gt; # è°ƒç”¨æ„é€ å‡½æ•°</span><br><span class="line">   0x0000555555554826 &lt;+44&gt;:	mov    %rbx,-0x20(%rbp)  # rbxå­˜çš„å³æ˜¯ptestObjæŒ‡é’ˆå§.</span><br><span class="line">   								# -0x20(%rbp)æ˜¯rtestObjè¿™ä¸ªå¼•ç”¨å çš„8å­—èŠ‚çš„é¦–åœ°å€?</span><br><span class="line">   0x000055555555482a &lt;+48&gt;:	mov    -0x20(%rbp),%rax</span><br><span class="line">   0x000055555555482e &lt;+52&gt;:	mov    %rax,-0x18(%rbp)  </span><br><span class="line">   								# ä¸‹é¢çš„é€»è¾‘å’ŒæŒ‡é’ˆè°ƒç”¨åˆ†æçš„ä¸€æ ·äº†...æœ¬è´¨æ˜¯å› ä¸ºå¼•ç”¨å’ŒæŒ‡é’ˆåœ¨æ±‡ç¼–è¿™ä¸ªå±‚é¢çœ‹,å¼•ç”¨ç”±æŒ‡é’ˆå®ç°(æ„Ÿè§‰è¿™å¥è¯ä¸ä¸¥è°¨?æ±‡ç¼–å±‚é¢çš„æŒ‡é’ˆå°±æ˜¯ä¸€ä¸ª8å­—èŠ‚çš„åœ°å€,å…³é”®çœ‹åæ±‡ç¼–çš„ä»£ç å§.ä¸€ä¸‹å°±æ˜ç™½äº†).</span><br><span class="line">   0x0000555555554832 &lt;+56&gt;:	mov    -0x18(%rbp),%rax</span><br><span class="line">   0x0000555555554836 &lt;+60&gt;:	mov    (%rax),%rax</span><br><span class="line">   0x0000555555554839 &lt;+63&gt;:	add    $0x8,%rax</span><br><span class="line">   0x000055555555483d &lt;+67&gt;:	mov    (%rax),%rax</span><br><span class="line">   0x0000555555554840 &lt;+70&gt;:	mov    -0x18(%rbp),%rdx</span><br><span class="line">   0x0000555555554844 &lt;+74&gt;:	mov    $0xc8,%esi</span><br><span class="line">   0x0000555555554849 &lt;+79&gt;:	mov    %rdx,%rdi</span><br><span class="line">   0x000055555555484c &lt;+82&gt;:	callq  *%rax</span><br><span class="line">   0x000055555555484e &lt;+84&gt;:	mov    -0x18(%rbp),%rax</span><br><span class="line">   0x0000555555554852 &lt;+88&gt;:	mov    (%rax),%rax</span><br><span class="line">   0x0000555555554855 &lt;+91&gt;:	mov    (%rax),%rax</span><br><span class="line">   0x0000555555554858 &lt;+94&gt;:	mov    -0x18(%rbp),%rdx</span><br><span class="line">   0x000055555555485c &lt;+98&gt;:	mov    %rdx,%rdi</span><br><span class="line">   0x000055555555485f &lt;+101&gt;:	callq  *%rax</span><br><span class="line">   0x0000555555554861 &lt;+103&gt;:	mov    %eax,%esi</span><br><span class="line">   0x0000555555554863 &lt;+105&gt;:	lea    0xfa(%rip),%rdi        # 0x555555554964</span><br><span class="line">   0x000055555555486a &lt;+112&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x000055555555486f &lt;+117&gt;:	callq  0x5555555546b0 &lt;printf@plt&gt;</span><br><span class="line">   0x0000555555554874 &lt;+122&gt;:	mov    -0x20(%rbp),%rax</span><br><span class="line">   0x0000555555554878 &lt;+126&gt;:	mov    $0x10,%esi</span><br><span class="line">   0x000055555555487d &lt;+131&gt;:	mov    %rax,%rdi</span><br><span class="line">   0x0000555555554880 &lt;+134&gt;:	callq  0x5555555546d0 &lt;_ZdlPvm@plt&gt; # delete</span><br><span class="line">   0x0000555555554885 &lt;+139&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x000055555555488a &lt;+144&gt;:	add    $0x18,%rsp</span><br><span class="line">   0x000055555555488e &lt;+148&gt;:	pop    %rbx</span><br><span class="line">   0x000055555555488f &lt;+149&gt;:	pop    %rbp</span><br><span class="line">   0x0000555555554890 &lt;+150&gt;:	retq</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆå°±ä¸¤ç§è°ƒç”¨æ–¹å¼.</p>
<p>callq  0x555555554832 å’Œ callq  *%rax</p>
<p>åˆ†åˆ«æ˜¯ç›´æ¥è°ƒç”¨å’Œé—´æ¥è°ƒç”¨,åªæœ‰callq  *%raxè¿™ç§é—´æ¥æ–¹å¼æ˜¯æŸ¥vptræŒ‡å‘çš„è™šå‡½æ•°è¡¨,ç„¶åæ‰¾åˆ°å‡½æ•°æŒ‡é’ˆåè°ƒç”¨ç›¸åº”å‡½æ•°çš„,ä¹Ÿå°±æ˜¯è™šå‡½æ•°å®ç°C++å¤šæ€çš„å…³é”®â€¦(æœ‰ä¸ªé—®é¢˜,è¿™ä¹ˆåšçš„è¯,æ€§èƒ½ä¸Šæ‰“æŠ˜æ‰£å—???)</p>
<hr>
<h3 id="ææ„å‡½æ•°ä¸vptr"><a href="#ææ„å‡½æ•°ä¸vptr" class="headerlink" title="ææ„å‡½æ•°ä¸vptr"></a>ææ„å‡½æ•°ä¸vptr</h3><blockquote>
<p>  åæ±‡ç¼–ä¸é€†å‘åˆ†ææŠ€æœ¯æ­ç§˜11.1èŠ‚P261æœ€åå‡ æ®µè¯,æ²¡å¤ªæ˜ç™½,å…³é”®åº”è¯¥æ˜¯è¦ç»“åˆç»§æ‰¿æ¥åˆ†æâ€¦å¾…çœ‹å§â€¦</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CVirtual</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">GetNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> _nNumber;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetNumber</span><span class="params">(<span class="keyword">int</span> nNumber)</span> </span>&#123;</span><br><span class="line">      _nNumber = nNumber;</span><br><span class="line">  &#125;</span><br><span class="line">  ~CVirtual() &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"~CVirtual()\n"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">int</span> _nNumber;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CVirtual testObj;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble main</span><br><span class="line">Dump of assembler code for function main():</span><br><span class="line">   0x00005555555547ea &lt;+0&gt;:	push   %rbp</span><br><span class="line">   0x00005555555547eb &lt;+1&gt;:	mov    %rsp,%rbp</span><br><span class="line">   0x00005555555547ee &lt;+4&gt;:	push   %rbx</span><br><span class="line">   0x00005555555547ef &lt;+5&gt;:	sub    $0x28,%rsp</span><br><span class="line">=&gt; 0x00005555555547f3 &lt;+9&gt;:	mov    %fs:0x28,%rax</span><br><span class="line">   0x00005555555547fc &lt;+18&gt;:	mov    %rax,-0x18(%rbp)</span><br><span class="line">   0x0000555555554800 &lt;+22&gt;:	xor    %eax,%eax</span><br><span class="line">   0x0000555555554802 &lt;+24&gt;:	lea    -0x30(%rbp),%rax</span><br><span class="line">   0x0000555555554806 &lt;+28&gt;:	mov    %rax,%rdi</span><br><span class="line">   0x0000555555554809 &lt;+31&gt;:	callq  0x555555554890 &lt;CVirtual::CVirtual()&gt;</span><br><span class="line">   0x000055555555480e &lt;+36&gt;:	mov    $0x0,%ebx</span><br><span class="line">   0x0000555555554813 &lt;+41&gt;:	lea    -0x30(%rbp),%rax</span><br><span class="line">   0x0000555555554817 &lt;+45&gt;:	mov    %rax,%rdi  # thisæŒ‡é’ˆ</span><br><span class="line">   0x000055555555481a &lt;+48&gt;:	callq  0x555555554866 &lt;CVirtual::~CVirtual()&gt;</span><br><span class="line">   0x000055555555481f &lt;+53&gt;:	mov    %ebx,%eax</span><br><span class="line">   0x0000555555554821 &lt;+55&gt;:	mov    -0x18(%rbp),%rdx  # åé¢çš„è¿™äº›ä»€ä¹ˆä½œç”¨?</span><br><span class="line">   0x0000555555554825 &lt;+59&gt;:	xor    %fs:0x28,%rdx</span><br><span class="line">   0x000055555555482e &lt;+68&gt;:	je     0x555555554835 &lt;main()+75&gt;</span><br><span class="line">   0x0000555555554830 &lt;+70&gt;:	callq  0x5555555546b0 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">   0x0000555555554835 &lt;+75&gt;:	add    $0x28,%rsp</span><br><span class="line">   0x0000555555554839 &lt;+79&gt;:	pop    %rbx</span><br><span class="line">   0x000055555555483a &lt;+80&gt;:	pop    %rbp</span><br><span class="line">   0x000055555555483b &lt;+81&gt;:	retq</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble 0x555555554866  # callq  0x555555554866 &lt;CVirtual::~CVirtual()&gt;</span><br><span class="line">Dump of assembler code for function CVirtual::~CVirtual():</span><br><span class="line">   0x0000555555554866 &lt;+0&gt;:	push   %rbp</span><br><span class="line">   0x0000555555554867 &lt;+1&gt;:	mov    %rsp,%rbp</span><br><span class="line">   0x000055555555486a &lt;+4&gt;:	sub    $0x10,%rsp</span><br><span class="line">   0x000055555555486e &lt;+8&gt;:	mov    %rdi,-0x8(%rbp)  # thisæŒ‡é’ˆå­˜å…¥-0x8(%rbp)</span><br><span class="line">   0x0000555555554872 &lt;+12&gt;:	lea    0x200517(%rip),%rdx        # 0x555555754d90 &lt;_ZTV8CVirtual+16&gt;									   # è™šè¡¨åœ°å€æ”¾å…¥%rdx</span><br><span class="line">   														# 0x555555754d90æ˜¯è™šè¡¨åœ°å€</span><br><span class="line">   0x0000555555554879 &lt;+19&gt;:	mov    -0x8(%rbp),%rax</span><br><span class="line">   0x000055555555487d &lt;+23&gt;:	mov    %rdx,(%rax)		# è™šè¡¨åœ°å€æ”¾å…¥thisæŒ‡é’ˆæŒ‡çš„é‚£ä¸ªå¯¹è±¡çš„vptr?å•¥?é‚£å²‚ä¸æ˜¯å’Œæ„é€ å‡½æ•°å¹²äº†ä¸€æ ·çš„äº‹æƒ…?</span><br><span class="line">   # åˆæ˜¯æŠŠè™šè¡¨é¦–åœ°å€èµ‹å€¼åˆ°å¯¹åº”å¯¹è±¡çš„è™šè¡¨æŒ‡é’ˆä¸­</span><br><span class="line">   0x0000555555554880 &lt;+26&gt;:	lea    0xad(%rip),%rdi        # 0x555555554934</span><br><span class="line">   0x0000555555554887 &lt;+33&gt;:	callq  0x5555555546c0 &lt;puts@plt&gt;</span><br><span class="line">   0x000055555555488c &lt;+38&gt;:	nop</span><br><span class="line">   0x000055555555488d &lt;+39&gt;:	leaveq</span><br><span class="line">   0x000055555555488e &lt;+40&gt;:	retq</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªææ„çš„æ±‡ç¼–åˆ†æå°¤å…¶æ˜¯å†™å…¥è™šè¡¨æŒ‡é’ˆé‚£é‡Œ,ä¸æ˜ç™½!!!è¿™é‡Œçš„å¼„æ¸…æ¥šçš„çº¿ç´¢åœ¨åæ±‡ç¼–ä¸é€†å‘åˆ†ææŠ€æœ¯æ­ç§˜11.1èŠ‚æœ€åå‡ æ®µè¯.å…³é”®åº”è¯¥æ˜¯è¦ç»“åˆç»§æ‰¿æ¥åˆ†æâ€¦</p>
<p>æœ‰åˆæˆçš„ææ„å‡½æ•°å§?æœ‰,è§C++Primer13.1.3.ä¹‹å‰è§è¿‡,è®°ä¸å¾—äº†â€¦<br>å¦‚æœæ”¹æˆ</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CVirtual</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">GetNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> _nNumber;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetNumber</span><span class="params">(<span class="keyword">int</span> nNumber)</span> </span>&#123;</span><br><span class="line">      _nNumber = nNumber;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//~CVirtual() &#123;</span></span><br><span class="line">  <span class="comment">//    printf("~CVirtual()\n");</span></span><br><span class="line">  <span class="comment">//&#125;</span></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">int</span> _nNumber;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CVirtual testObj;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å›åˆ°ä¸æ˜¾å¼å®šä¹‰ææ„å‡½æ•°çš„æ—¶å€™.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble main</span><br><span class="line">Dump of assembler code for function main():</span><br><span class="line">   0x000055555555475a &lt;+0&gt;:	push   %rbp</span><br><span class="line">   0x000055555555475b &lt;+1&gt;:	mov    %rsp,%rbp</span><br><span class="line">   0x000055555555475e &lt;+4&gt;:	sub    $0x20,%rsp</span><br><span class="line">=&gt; 0x0000555555554762 &lt;+8&gt;:	mov    %fs:0x28,%rax</span><br><span class="line">   0x000055555555476b &lt;+17&gt;:	mov    %rax,-0x8(%rbp)</span><br><span class="line">   0x000055555555476f &lt;+21&gt;:	xor    %eax,%eax</span><br><span class="line">   0x0000555555554771 &lt;+23&gt;:	lea    -0x20(%rbp),%rax</span><br><span class="line">   0x0000555555554775 &lt;+27&gt;:	mov    %rax,%rdi</span><br><span class="line">   0x0000555555554778 &lt;+30&gt;:	callq  0x5555555547c2 &lt;CVirtual::CVirtual()&gt;</span><br><span class="line">   0x000055555555477d &lt;+35&gt;:	mov    $0x0,%eax</span><br><span class="line">   0x0000555555554782 &lt;+40&gt;:	mov    -0x8(%rbp),%rdx</span><br><span class="line">   0x0000555555554786 &lt;+44&gt;:	xor    %fs:0x28,%rdx</span><br><span class="line">   0x000055555555478f &lt;+53&gt;:	je     0x555555554796 &lt;main()+60&gt;</span><br><span class="line">   0x0000555555554791 &lt;+55&gt;:	callq  0x555555554630 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">   0x0000555555554796 &lt;+60&gt;:	leaveq</span><br><span class="line">   0x0000555555554797 &lt;+61&gt;:	retq</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>
<p>åœ¨mainé‡Œé¢æ²¡è°ƒç”¨ææ„å‡½æ•°?è¢«ç¼–è¯‘å™¨ä¼˜åŒ–äº†???å…³ä¼˜åŒ–è¯•è¯•.<br>ææ„è¿™é‡Œæœ‰æ²¡æœ‰ç±»ä¼¼æ„é€ çš„RVOçš„g++ -fno-elide-constructorsè¿™æ ·çš„ä¸œè¥¿?å¼ºåˆ¶ä¸ä¼˜åŒ–,æ‰§è¡Œææ„å‡½æ•°.<br>è¿™é‡Œç»“åˆEffective Modern C++çš„æœ‰ä¸€å°èŠ‚æ¥çœ‹(è®²ç¼–è¯‘å™¨åœ¨èƒŒåå¸®ä½ å®ç°äº†å“ªäº›copy controlå‡½æ•°é‚£èŠ‚,ä¸»è¦è¿™é‡Œæœ‰C++11çš„,è€ŒEffective C++é‡Œé¢åªæ²¡æœ‰ç§»åŠ¨ç‰ˆæœ¬copy controlå‡½æ•°çš„åˆ†æ).å…ˆæ”¾ç€å§â€¦</p>
<p>å‚è€ƒ:</p>
<p>1.åæ±‡ç¼–ä¸é€†å‘åˆ†ææŠ€æœ¯æ­ç§˜</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://mojiajun.github.io/post/18ee0c7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mojiajun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mojiajun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/18ee0c7.html" itemprop="url">mit6828-å†…è”æ±‡ç¼–-xv6-xchg-spinlock</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-10T00:00:00+08:00">
                2019-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OS/" itemprop="url" rel="index">
                    <span itemprop="name">OS</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OS/xv6/" itemprop="url" rel="index">
                    <span itemprop="name">xv6</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<h2 id="inline-assembly"><a href="#inline-assembly" class="headerlink" title="inline assembly"></a>inline assembly</h2><p>å…¥é—¨:<a href="https://blog.csdn.net/slvher/article/details/8864996" target="_blank" rel="noopener">ã€Linuxå­¦ä¹ ç¬”è®°ã€‘Linux Cä¸­å†…è”æ±‡ç¼–çš„è¯­æ³•æ ¼å¼åŠä½¿ç”¨æ–¹æ³•ï¼ˆInline Assembly in Linux Cï¼‰</a>è¿™ä¸ªè®²çš„æ¯”è¾ƒå¥½äº†.æ›´å…¨é¢çš„å¾—æŸ¥ç±»ä¼¼<a href="http://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html#ss5.1" target="_blank" rel="noopener">GCC-Inline-Assembly-HOWTO</a>è¿™ç§</p>
<p>inline assemblyæ„Ÿè§‰ç»†èŠ‚å¥½å¤šâ€¦ä¸‹æ¬¡çœ‹ä¼°è®¡åˆå¿˜äº†â€¦</p>
<hr>
<p>ç”¨1å¯¹åŒå¼•å·å°†å¤šè¡Œå‘½ä»¤æ‹¬èµ·æ¥ åŠ â€;â€åˆ†å·?<br>clobbered registerä¿®é¥°å¯„å­˜å™¨?ä¿®é¥°?<br><a href="https://en.wikipedia.org/wiki/Inline_assembler" target="_blank" rel="noopener">Inline assembler</a>é‡Œé¢æœ‰ä¸ªç”¨æ±‡ç¼–æ±‚tan(x)çš„ä¾‹å­,å¾…çœ‹,æ„Ÿè§‰æŒºæœ‰è¶£.</p>
<hr>
<p>å½“æˆ‘ä»¬ä¸æƒ³é€šè¿‡å¯„å­˜å™¨ä¸­è½¬ï¼Œè€Œæ˜¯ç›´æ¥æ“ä½œå†…å­˜æ—¶ï¼Œå¯ä»¥ç”¨â€mâ€æ¥çº¦æŸã€‚ä¾‹å¦‚ï¼š<br>asm volatile ( â€œlock; decl %0â€ : â€œ=mâ€ (counter) : â€œmâ€ (counter));<br>è¯¥æŒ‡ä»¤å®ç°åŸå­å‡ä¸€æ“ä½œï¼Œè¾“å…¥ã€è¾“å‡ºæ“ä½œæ•°å‡ç›´æ¥æ¥è‡ªå†…å­˜ï¼ˆ<strong>ä¹Ÿæ­£å› å¦‚æ­¤ï¼Œæ‰èƒ½ä¿è¯æ“ä½œçš„åŸå­æ€§</strong>ï¼‰ã€‚ </p>
<blockquote>
<p>  ä¹Ÿæ­£å› å¦‚æ­¤ï¼Œæ‰èƒ½ä¿è¯æ“ä½œçš„åŸå­æ€§,æ›´åº•å±‚ç»†èŠ‚?è¿™æ˜¯æ˜¯ä¿è¯åŸå­æ€§çš„å…³é”®å—?ç»“åˆåé¢çš„xv6çš„xchgå‡½æ•°å®ç°.<br>  3ä¸ªä¸œè¥¿.1æ˜¯lockå‰ç¼€,2æ˜¯+ä»£è¡¨read-modify-write,3æ˜¯â€mâ€ç›´æ¥æ“ä½œå†…å­˜</p>
</blockquote>
<p>â€œ=çš„æ„æ€â€ output operandåº”è¯¥æœ‰ä¸ªâ€=â€,1.è¯´æ˜è¿™ä¸ªæ˜¯è¾“å‡ºæ“ä½œæ•°,2.write-only</p>
<ul>
<li>â€œrâ€ is a constraint on the operands. Weâ€™ll see constraints in detail later. For the time being, â€œrâ€ says to GCC to use any register for storing the operands. output operand constraint should have a constraint modifier â€œ=â€. And this modifier says that it is the output operand and is write-only.</li>
</ul>
<p>â€œccâ€çš„æ„æ€</p>
<p>If our instruction can alter the condition code register, we have to add â€œccâ€ to the list of clobbered registers.s</p>
<hr>
<h2 id="xv6çš„xchgå‡½æ•°"><a href="#xv6çš„xchgå‡½æ•°" class="headerlink" title="xv6çš„xchgå‡½æ•°"></a>xv6çš„xchgå‡½æ•°</h2><p>static inline uint<br>xchg(volatile uint <em>addr, uint newval)
</em>äº¤æ¢<em>addrå’Œnewval,ç„¶åæŠŠ</em>addrçš„åŸå…ˆçš„å€¼ä½œä¸ºresultè¿”å›!!!è¿™åªæ˜¯ä»Cå±‚é¢å¯ä»¥è¿™ä¹ˆä»é€»è¾‘ä¸Šç†è§£.å®é™…ç¼–è¯‘å™¨å¹²çš„æœ‰äº›åŒºåˆ«,ä½†æ˜¯æœ€ç»ˆç»“æœä¸€è‡´.<br>èŒƒä¾‹:è§åé¢</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint</span><br><span class="line">xchg(<span class="keyword">volatile</span> uint *addr, uint newval)</span><br><span class="line">&#123;</span><br><span class="line">  uint result;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The + in "+m" denotes a read-modify-write operand.</span></span><br><span class="line">  <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">"lock; xchgl %0, %1"</span> :</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="string">"+m"</span> (*addr), <span class="string">"=a"</span> (result) :</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="string">"1"</span> (newval) :</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="string">"cc"</span>)</span></span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¿™ä¸ª"1"æ„Ÿè§‰æ˜¯ä»£è¡¨å¯¹åº”å‰é¢çš„%1,æŒ‡å®šä½ç½®çš„ä½œç”¨?æ²¡ä»”ç»†æŸ¥...çŒœçš„</span></span><br><span class="line">kernel.<span class="keyword">asm</span>:</span><br><span class="line"> <span class="number">8515</span>   <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">"lock; xchgl %0, %1"</span> :</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8516</span> <span class="number">80104373</span>:       ba <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x1</span>,%edx</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8517</span> <span class="number">80104378</span>:       eb <span class="number">09</span>                   jmp    <span class="number">80104383</span> &lt;acquire+<span class="number">0x33</span>&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8518</span> <span class="number">8010437</span>a:       <span class="number">8</span>d b6 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       lea    <span class="number">0x0</span>(%esi),%esi</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8519</span> <span class="number">80104380</span>:       <span class="number">8b</span> <span class="number">5</span>d <span class="number">08</span>                mov    <span class="number">0x8</span>(%ebp),%ebx</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8520</span> <span class="number">80104383</span>:       <span class="number">89</span> d0                   mov    %edx,%eax</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8521</span> <span class="number">80104385</span>:       f0 <span class="number">87</span> <span class="number">03</span>                lock xchg %eax,(%ebx)</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8522</span>   <span class="keyword">while</span>(xchg(&amp;lk-&gt;locked, <span class="number">1</span>) != <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8523</span> <span class="number">80104388</span>:       <span class="number">85</span> c0                   test   %eax,%eax</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">8524</span> <span class="number">8010438</span>a:       <span class="number">75</span> f4                   jne    <span class="number">80104380</span> &lt;acquire+<span class="number">0x30</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>åœ¨å®é™…è¿è¡Œçš„æ±‡ç¼–ä»£ç é‡Œé¢ä¸ºä»€ä¹ˆé¡ºåºåˆå˜äº†?å‰åçš„é¡ºåº?<br>çŒœæµ‹:è¿™éƒ¨åˆ†ä»£ç è¿˜æ˜¯å¾—æ ¹æ®å®é™…è¿è¡Œçš„æƒ…å†µæ¥çœ‹,test   %eax,%eax,å³æµ‹è¯•çš„æ˜¯eax,è€Œä¸”â€=aâ€ (result) :<br>æ‰€ä»¥eaxå­˜çš„æ˜¯äº¤æ¢ä¹‹åçš„å€¼,é‚£ä¹ˆåœ¨äº¤æ¢ä¹‹å‰,å­˜åœ¨æ˜¯newval<br>æ ¹æ®lock; xchgl (<em>addr), newvalå­—é¢æ¥å¥—æ˜¯è¿™æ ·çš„.å› ä¸ºeaxå¾—å­˜äº¤æ¢åçš„å€¼,æ‰€ä»¥eaxäº¤æ¢å‰å­˜çš„æ˜¯newval<br>æ‰€ä»¥lock; xchgl (</em>addr), eax,ç„¶åå°±å’Œå®é™…è¿è¡Œçœ‹åˆ°çš„ç›¸åäº†â€¦è¿™ä¸ªè¿‡ç¨‹æ˜¯ç¼–è¯‘å™¨ç»™åšçš„.å¹¶ä¸å¤ªæ¸…æ¥šç¼–è¯‘å™¨å¯„å­˜å™¨åˆ†é…<br>è§„åˆ™â€¦</p>
<p>é™„ä¸Šå‰åçš„å…¶ä»–ä¸œè¥¿,ä¾¿äºæ•°é‚£ä¸ª&lt;acquire+0x30&gt;çš„ä½ç½®åè¿›åˆ¶æ•°åç§»48,jne    80104380 &lt;acquire+0x30&gt;è·³è½¬åˆ°lea    0x0(%esi),%esi</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">8498</span> <span class="number">80104350</span> &lt;acquire&gt;:</span><br><span class="line"><span class="number">8499</span> &#123;</span><br><span class="line"><span class="number">8500</span> <span class="number">80104350</span>:       <span class="number">55</span>                      push   %ebp</span><br><span class="line"><span class="number">8501</span> <span class="number">80104351</span>:       <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line"><span class="number">8502</span> <span class="number">80104353</span>:       <span class="number">56</span>                      push   %esi</span><br><span class="line"><span class="number">8503</span> <span class="number">80104354</span>:       <span class="number">53</span>                      push   %ebx</span><br><span class="line"><span class="number">8504</span>   pushcli(); <span class="comment">// disable interrupts to avoid deadlock.</span></span><br><span class="line"><span class="number">8505</span> <span class="number">80104355</span>:       e8 <span class="number">26</span> ff ff ff          call   <span class="number">80104280</span> &lt;pushcli&gt;</span><br><span class="line"><span class="number">8506</span>   <span class="keyword">if</span>(holding(lk))</span><br><span class="line"><span class="number">8507</span> <span class="number">8010435</span>a:       <span class="number">8b</span> <span class="number">5</span>d <span class="number">08</span>                mov    <span class="number">0x8</span>(%ebp),%ebx</span><br><span class="line"><span class="number">8508</span> <span class="number">8010435</span>d:       <span class="number">83</span> ec <span class="number">0</span>c                sub    $<span class="number">0xc</span>,%esp</span><br><span class="line"><span class="number">8509</span> <span class="number">80104360</span>:       <span class="number">53</span>                      push   %ebx</span><br><span class="line"><span class="number">8510</span> <span class="number">80104361</span>:       e8 ba ff ff ff          call   <span class="number">80104320</span> &lt;holding&gt;</span><br><span class="line"><span class="number">8511</span> <span class="number">80104366</span>:       <span class="number">83</span> c4 <span class="number">10</span>                add    $<span class="number">0x10</span>,%esp</span><br><span class="line"><span class="number">8512</span> <span class="number">80104369</span>:       <span class="number">85</span> c0                   test   %eax,%eax</span><br><span class="line"><span class="number">8513</span> <span class="number">8010436b</span>:       <span class="number">0f</span> <span class="number">85</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       jne    <span class="number">801043f</span>4 &lt;acquire+<span class="number">0xa4</span>&gt;</span><br><span class="line"><span class="number">8514</span> <span class="number">80104371</span>:       <span class="number">89</span> c6                   mov    %eax,%esi</span><br><span class="line"><span class="number">8515</span>   <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">"lock; xchgl %0, %1"</span> :   </span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">8516</span> <span class="number">80104373</span>:       ba <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x1</span>,%edx</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">8517</span> <span class="number">80104378</span>:       eb <span class="number">09</span>                   jmp    <span class="number">80104383</span> &lt;acquire+<span class="number">0x33</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h2 id="xchg-ä½¿ç”¨æ¡ˆä¾‹-xv6çš„spinlockçš„acquireå’Œrelease"><a href="#xchg-ä½¿ç”¨æ¡ˆä¾‹-xv6çš„spinlockçš„acquireå’Œrelease" class="headerlink" title="xchg()ä½¿ç”¨æ¡ˆä¾‹,xv6çš„spinlockçš„acquireå’Œrelease"></a>xchg()ä½¿ç”¨æ¡ˆä¾‹,xv6çš„spinlockçš„acquireå’Œrelease</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">acquire(struct spinlock *lk)</span><br><span class="line">&#123;</span><br><span class="line">  pushcli(); <span class="comment">// disable interrupts to avoid deadlock.</span></span><br><span class="line">  <span class="keyword">if</span>(holding(lk))</span><br><span class="line">    panic(<span class="string">"acquire"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The xchg is atomic.</span></span><br><span class="line">  <span class="keyword">while</span>(xchg(&amp;lk-&gt;locked, <span class="number">1</span>) != <span class="number">0</span>)</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Tell the C compiler and the processor to not move loads or stores</span></span><br><span class="line">  <span class="comment">// past this point, to ensure that the critical section's memory</span></span><br><span class="line">  <span class="comment">// references happen after the lock is acquired.</span></span><br><span class="line">  __sync_synchronize();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Record info about lock acquisition for debugging.</span></span><br><span class="line">  lk-&gt;cpu = mycpu();</span><br><span class="line">  getcallerpcs(&amp;lk, lk-&gt;pcs);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Release the lock.</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">release(struct spinlock *lk)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span>(!holding(lk))</span><br><span class="line">    panic(<span class="string">"release"</span>);</span><br><span class="line"></span><br><span class="line">  lk-&gt;pcs[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  lk-&gt;cpu = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  __sync_synchronize();</span><br><span class="line">  <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">"movl $0, %0"</span> : <span class="string">"+m"</span> (lk-&gt;locked) : )</span></span>;</span><br><span class="line"></span><br><span class="line">  popcli();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">8516</span> <span class="number">80104373</span>:       ba <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x1</span>,%edx</span><br><span class="line"> <span class="number">8517</span> <span class="number">80104378</span>:       eb <span class="number">09</span>                   jmp    <span class="number">80104383</span> &lt;acquire+<span class="number">0x33</span>&gt;</span><br><span class="line"> <span class="number">8518</span> <span class="number">8010437</span>a:       <span class="number">8</span>d b6 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       lea    <span class="number">0x0</span>(%esi),%esi</span><br><span class="line"> <span class="number">8519</span> <span class="number">80104380</span>:       <span class="number">8b</span> <span class="number">5</span>d <span class="number">08</span>                mov    <span class="number">0x8</span>(%ebp),%ebx</span><br><span class="line"> <span class="number">8520</span> <span class="number">80104383</span>:       <span class="number">89</span> d0                   mov    %edx,%eax</span><br><span class="line"> <span class="number">8521</span> <span class="number">80104385</span>:       f0 <span class="number">87</span> <span class="number">03</span>                lock xchg %eax,(%ebx)</span><br><span class="line"> <span class="number">8523</span> <span class="number">80104388</span>:       <span class="number">85</span> c0                   test   %eax,%eax</span><br><span class="line"> <span class="number">8524</span> <span class="number">8010438</span>a:       <span class="number">75</span> f4                   jne    <span class="number">80104380</span> &lt;acquire+<span class="number">0x30</span>&gt;</span><br><span class="line"><span class="comment">// è¿™å…«è¡Œæ±‡ç¼–æ˜¯åº•ä¸‹çš„è¿™ä¸ªwhileå¾ªç¯è¢«ç¼–è¯‘å™¨ç¼–è¯‘åå¤„ç†çš„ç»“æœ,</span></span><br><span class="line"><span class="comment">// åœ¨kernel.asmæ‹¿åˆ°çš„.è¯¦ç»†çš„è§å‰é¢çš„åˆ†æ.jne    </span></span><br><span class="line"><span class="comment">// 80104380 &lt;acquire+0x30&gt;è·³åˆ°lea    0x0(%esi),%esi</span></span><br><span class="line">  <span class="keyword">while</span>(xchg(&amp;lk-&gt;locked, <span class="number">1</span>) != <span class="number">0</span>)</span><br><span class="line">    ;</span><br><span class="line"><span class="comment">// è¿™ä¸ªå°±æ˜¯æ“ä½œç³»ç»Ÿæ•™æé‡Œé¢çˆ±æçš„æ¦‚å¿µbusy wait?</span></span><br><span class="line"><span class="comment">// åœ¨æ±‡ç¼–å±‚é¢å®é™…æ‰§è¡Œçš„å¾ªç¯æ˜¯:</span></span><br><span class="line"> <span class="number">8518</span> <span class="number">8010437</span>a:       <span class="number">8</span>d b6 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       lea    <span class="number">0x0</span>(%esi),%esi</span><br><span class="line"> <span class="number">8519</span> <span class="number">80104380</span>:       <span class="number">8b</span> <span class="number">5</span>d <span class="number">08</span>                mov    <span class="number">0x8</span>(%ebp),%ebx</span><br><span class="line"> <span class="number">8520</span> <span class="number">80104383</span>:       <span class="number">89</span> d0                   mov    %edx,%eax</span><br><span class="line"> <span class="number">8521</span> <span class="number">80104385</span>:       f0 <span class="number">87</span> <span class="number">03</span>                lock xchg %eax,(%ebx)</span><br><span class="line"> <span class="number">8523</span> <span class="number">80104388</span>:       <span class="number">85</span> c0                   test   %eax,%eax</span><br><span class="line"> <span class="number">8524</span> <span class="number">8010438</span>a:       <span class="number">75</span> f4                   jne    <span class="number">80104380</span> &lt;acquire+<span class="number">0x30</span>&gt;</span><br></pre></td></tr></table></figure>
<p>æ²¡æ‹¿åˆ°é”çš„æ—¶å€™,lk-&gt;lockedå­˜çš„æ˜¯0,æ‹¿åˆ°é”åå­˜çš„æ˜¯1.<br>æƒ…å†µA:å‡è®¾lkè¿™æŠŠspinlockçš„lockedåŸæ¥çš„çŠ¶æ€æ˜¯0,ä»£è¡¨å½“å‰è¿™æŠŠé”è¿˜æ²¡æœ‰è¢«æ‹¿åˆ°è¿‡,ç„¶åè¿›å…¥acquire(),xchg()æ¢lk-&gt;lockedå’Œ1,äº¤æ¢ålk-&gt;lockedå­˜çš„å˜æˆ1äº†,ä»£è¡¨é”ä¸Šäº†.ç„¶åä»Cå±‚é¢çœ‹çš„è¯,xchg()è¿”å›çš„ç»“æœæ˜¯lk-&gt;locked()äº¤æ¢ä¹‹å‰çš„å€¼.ä¹Ÿå°±æ˜¯0,æ‰€ä»¥while(0 != 0)æ¡ä»¶ä¸æ»¡è¶³,false,while(false),é‚£ä¹ˆä¸æ‰§è¡Œå¾ªç¯è¯­å¥,åœ¨è¿™é‡Œæ˜¯ç©ºè¯­å¥(;).ç„¶åæ‰§è¡Œ__sync_synchronize();.ä»£è¡¨æ‹¿åˆ°é”äº†.<br>æƒ…å†µB:å‡è®¾lkè¿™æŠŠspinlockçš„lockedåŸæ¥çš„çŠ¶æ€æ˜¯1,ä»£è¡¨å½“å‰è¿™æŠŠé”å·²ç»è¢«æ‹¿è¿‡äº†,ç„¶åè¿›å…¥acquire(),xchg()æ¢lk-&gt;lockedå’Œ1,äº¤æ¢ålk-&gt;lockedå­˜çš„ä»ç„¶æ˜¯1(1å’Œ1äº¤æ¢).ç„¶åä»Cå±‚é¢çœ‹çš„è¯,xchg()è¿”å›çš„ç»“æœæ˜¯lk-&gt;locked()äº¤æ¢ä¹‹å‰çš„å€¼.ä¹Ÿå°±æ˜¯1,æ‰€ä»¥while(1 != 0)æ¡ä»¶æ»¡è¶³,true,while(true),é‚£ä¹ˆæ‰§è¡Œå¾ªç¯è¯­å¥,åœ¨è¿™é‡Œæ˜¯ç©ºè¯­å¥(;)ç„¶åå†æ¬¡æ‰§è¡Œxchg()â€¦è¿˜æ˜¯1å’Œ1äº¤æ¢.ç„¶åå†æ¬¡æ‰§è¡Œxchg()â€¦è¿™ä¸ªå°±æ˜¯spinlockçš„æœ¬è´¨!</p>
<h2 id="é¢å¤–"><a href="#é¢å¤–" class="headerlink" title="é¢å¤–"></a>é¢å¤–</h2><p>1.read-modify-write??</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The + in "+m" denotes a read-modify-write operand.</span></span><br><span class="line">+å·åœ¨GCC-Inline-Assembly-HOWTOè¿˜æ²¡æ‰¾ç€(æ²¡ä»”ç»†æ‰¾),è¿˜æœ‰è¿™ä¸ªread-modify-write operand,æ˜¯åŸå­æ“ä½œçš„å…³é”®æ‰€åœ¨???!!!</span><br></pre></td></tr></table></figure>
<p>2.ç ”ç©¶ä¸‹busy waitå’Œsleep<br><a href="https://stackoverflow.com/questions/1107593/what-are-trade-offs-for-busy-wait-vs-sleep" target="_blank" rel="noopener">What are trade offs for â€œbusy waitâ€ vs â€œsleepâ€?</a>è¿˜æ²¡çœ‹,ä½†æ˜¯å¾…çœ‹â€¦<br>æ„Ÿè§‰busy waitæ¶ˆè€—cpuèµ„æº,sleepå¹¶æ²¡æœ‰æ¶ˆè€—cpuèµ„æº(åªæ˜¯ç²—ç•¥çš„è®²)</p>
<p>3.å®é™…è°ƒè¯•ä¸‹,æ‰“æ–­ç‚¹.åœ¨acquire()ä¸Š</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://mojiajun.github.io/post/11e7222f.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mojiajun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mojiajun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/11e7222f.html" itemprop="url">redis-é¡¹ç›®æ–‡ä»¶æ¦‚è§ˆ</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-28T00:00:00+08:00">
                2019-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/æºç é˜…è¯»/" itemprop="url" rel="index">
                    <span itemprop="name">æºç é˜…è¯»</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/æºç é˜…è¯»/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<p>åŸºäºredis-2.8</p>
<h2 id="åº•å±‚æ•°æ®ç»“æ„"><a href="#åº•å±‚æ•°æ®ç»“æ„" class="headerlink" title="åº•å±‚æ•°æ®ç»“æ„"></a>åº•å±‚æ•°æ®ç»“æ„</h2><h3 id="dict-h-c"><a href="#dict-h-c" class="headerlink" title="dict.h.c"></a>dict.h.c</h3><p>dict,hashçš„å®ç°</p>
<h3 id="adlist-h-c"><a href="#adlist-h-c" class="headerlink" title="adlist.h.c"></a>adlist.h.c</h3><p>é€šç”¨åŒå‘é“¾è¡¨?</p>
<h3 id="sds-h-c"><a href="#sds-h-c" class="headerlink" title="sds.h.c"></a>sds.h.c</h3><p>å°è£…äº†åº•å±‚çš„å­—ç¬¦ä¸²</p>
<h2 id="äº”ç§rediså¯¹è±¡-åŸºäºåº•å±‚æ•°æ®ç»“æ„"><a href="#äº”ç§rediså¯¹è±¡-åŸºäºåº•å±‚æ•°æ®ç»“æ„" class="headerlink" title="äº”ç§rediså¯¹è±¡(åŸºäºåº•å±‚æ•°æ®ç»“æ„)"></a>äº”ç§rediså¯¹è±¡(åŸºäºåº•å±‚æ•°æ®ç»“æ„)</h2><h3 id="t-list-c"><a href="#t-list-c" class="headerlink" title="t_list.c"></a>t_list.c</h3><h3 id="t-set-c"><a href="#t-set-c" class="headerlink" title="t_set.c"></a>t_set.c</h3><h3 id="t-string-c"><a href="#t-string-c" class="headerlink" title="t_string.c"></a>t_string.c</h3><h3 id="t-zset-c"><a href="#t-zset-c" class="headerlink" title="t_zset.c"></a>t_zset.c</h3><h3 id="t-hash-c"><a href="#t-hash-c" class="headerlink" title="t_hash.c"></a>t_hash.c</h3><h2 id="ç½‘ç»œæœ‰å…³"><a href="#ç½‘ç»œæœ‰å…³" class="headerlink" title="ç½‘ç»œæœ‰å…³"></a>ç½‘ç»œæœ‰å…³</h2><h3 id="networking-c"><a href="#networking-c" class="headerlink" title="networking.c"></a>networking.c</h3><p>å’Œanet,aeçš„å…³ç³»?</p>
<h3 id="anet-h-c"><a href="#anet-h-c" class="headerlink" title="anet.h.c"></a>anet.h.c</h3><p>aä»£è¡¨ä»€ä¹ˆ?å°è£…äº†åº•å±‚æ“ä½œç³»ç»Ÿçš„socket API</p>
<h3 id="ae-h-c"><a href="#ae-h-c" class="headerlink" title="ae.h.c"></a>ae.h.c</h3><p>ç®€å•çš„äº‹ä»¶é©±åŠ¨åº“,redisçš„reactoræ¨¡å¼çš„å®ç°</p>
<h4 id="ae-epoll-c-ae-evport-c-ae-kqueue-c-qe-select-c"><a href="#ae-epoll-c-ae-evport-c-ae-kqueue-c-qe-select-c" class="headerlink" title="ae_epoll.c,ae_evport.c,ae_kqueue.c,qe_select.c"></a>ae_epoll.c,ae_evport.c,ae_kqueue.c,qe_select.c</h4><p>è¿™å››ä¸ªæ–‡ä»¶ç»Ÿä¸€äº†ä¸åŒæ“ä½œç³»ç»Ÿæä¾›çš„I/O event notification.<br>æ‹¿linuxä¸‹çš„ae_epoll.cä¸¾ä¾‹å­,å…¶åœ¨åº•å±‚çš„epollä¸Šé¢å°äº†ä¸€å±‚.</p>
<p>ae.h.cä¼šä½¿ç”¨è¿™å››ç§æ“ä½œç³»ç»Ÿæä¾›çš„event notificationä¹‹ä¸€,å¯¹äºae.h.cæ¥è¯´,APIæ˜¯ç»Ÿä¸€çš„.</p>
<h2 id="ä¸Šå±‚æ•°æ®åº“"><a href="#ä¸Šå±‚æ•°æ®åº“" class="headerlink" title="ä¸Šå±‚æ•°æ®åº“"></a>ä¸Šå±‚æ•°æ®åº“</h2><h3 id="redis-h-c"><a href="#redis-h-c" class="headerlink" title="redis.h.c"></a>redis.h.c</h3><p>redisDbæ˜¯æ•°æ®åº“çš„æ ¸å¿ƒç»“æ„ä½“,å›´ç»•å®ƒæœ‰redisClient,redisServer.åˆ†é…ä»£è¡¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨,ç„¶åå†åŸºäºreactoræ¨¡å¼,å®ç°äº†ä¸¤è€…ä¹‹é—´çš„é€šä¿¡,å…¸å‹çš„C/Sæ¶æ„.</p>
<p>redis.hé‡Œé¢çš„å¾ˆå¤šAPIå‡½æ•°æ˜¯åœ¨å…¶ä»–çš„ä¸€äº›.cé‡Œå®ç°çš„,ä¸ä¸€å®šåœ¨redis.cé‡Œ.ä¾‹å¦‚redisDbçš„APIå‡½æ•°å°±æ˜¯åœ¨db.cé‡Œå®ç°çš„.</p>
<h2 id="é€šç”¨"><a href="#é€šç”¨" class="headerlink" title="é€šç”¨"></a>é€šç”¨</h2><h3 id="zmalloc-h-c"><a href="#zmalloc-h-c" class="headerlink" title="zmalloc.h.c"></a>zmalloc.h.c</h3><p>å°è£…äº†åº•å±‚çš„malloc,calloc,remalloc,freeå››ä¸ªå‡½æ•°.æä¾›äº†å¯ä»¥è¿›è¡Œå†…å­˜åˆ†é…ç»Ÿè®¡çš„èƒ½åŠ›.</p>
<blockquote>
<p>  å¯ä»¥æ›¿æ¢æ‰glibcçš„å†…å­˜åˆ†é…å‡½æ•°,ä¾‹å¦‚å¯ä»¥ç”¨jemallocåº“ä»£æ›¿.æœ‰å•¥ä¼˜ç‚¹?</p>
</blockquote>
<h2 id="æ‚é¡¹"><a href="#æ‚é¡¹" class="headerlink" title="æ‚é¡¹"></a>æ‚é¡¹</h2><h3 id="version-h"><a href="#version-h" class="headerlink" title="version.h"></a>version.h</h3><p>ç‰ˆæœ¬å·</p>
<h3 id="asciilogo-h"><a href="#asciilogo-h" class="headerlink" title="asciilogo.h"></a>asciilogo.h</h3><p>redisçš„asciiæ ¼å¼çš„logo,åœ¨æœåŠ¡å™¨å¯åŠ¨çš„æ—¶å€™ä¼šæ˜¾ç¤ºå‡ºæ¥.</p>
<h3 id="config-c"><a href="#config-c" class="headerlink" title="config.c"></a>config.c</h3><p>è§£æé…ç½®æ–‡ä»¶çš„å®ç°å‡½æ•°,APIæ¥å£åœ¨redis.hé‡Œ</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://mojiajun.github.io/post/18ee0d3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mojiajun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mojiajun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/18ee0d3.html" itemprop="url">redis-serveråˆå§‹åŒ–</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-27T00:00:00+08:00">
                2019-04-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/æºç é˜…è¯»/" itemprop="url" rel="index">
                    <span itemprop="name">æºç é˜…è¯»</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/æºç é˜…è¯»/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="initServerConfig"><a href="#initServerConfig" class="headerlink" title="initServerConfig()"></a>initServerConfig()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initServerConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">    getRandomHexChars(server.runid,REDIS_RUN_ID_SIZE);</span><br><span class="line">    server.configfile = <span class="literal">NULL</span>;</span><br><span class="line">    server.hz = REDIS_DEFAULT_HZ;</span><br><span class="line">    server.runid[REDIS_RUN_ID_SIZE] = <span class="string">'\0'</span>;</span><br><span class="line">    server.arch_bits = (<span class="keyword">sizeof</span>(<span class="keyword">long</span>) == <span class="number">8</span>) ? <span class="number">64</span> : <span class="number">32</span>;</span><br><span class="line">    server.port = REDIS_SERVERPORT;</span><br><span class="line">    server.bindaddr_count = <span class="number">0</span>;</span><br><span class="line">    server.unixsocket = <span class="literal">NULL</span>;</span><br><span class="line">    server.unixsocketperm = REDIS_DEFAULT_UNIX_SOCKET_PERM;</span><br><span class="line">    server.ipfd_count = <span class="number">0</span>;</span><br><span class="line">    server.sofd = <span class="number">-1</span>;</span><br><span class="line">    server.dbnum = REDIS_DEFAULT_DBNUM;</span><br><span class="line">    server.verbosity = REDIS_DEFAULT_VERBOSITY;</span><br><span class="line">    server.maxidletime = REDIS_MAXIDLETIME;</span><br><span class="line">    server.tcpkeepalive = REDIS_DEFAULT_TCP_KEEPALIVE;</span><br><span class="line">    server.active_expire_enabled = <span class="number">1</span>;</span><br><span class="line">    server.client_max_querybuf_len = REDIS_MAX_QUERYBUF_LEN;</span><br><span class="line">    server.saveparams = <span class="literal">NULL</span>;</span><br><span class="line">    server.loading = <span class="number">0</span>;</span><br><span class="line">    server.logfile = zstrdup(REDIS_DEFAULT_LOGFILE);</span><br><span class="line">    server.syslog_enabled = REDIS_DEFAULT_SYSLOG_ENABLED;</span><br><span class="line">    server.syslog_ident = zstrdup(REDIS_DEFAULT_SYSLOG_IDENT);</span><br><span class="line">    server.syslog_facility = LOG_LOCAL0;</span><br><span class="line">    server.daemonize = REDIS_DEFAULT_DAEMONIZE;</span><br><span class="line">    server.aof_state = REDIS_AOF_OFF;</span><br><span class="line">    server.aof_fsync = REDIS_DEFAULT_AOF_FSYNC;</span><br><span class="line">    server.aof_no_fsync_on_rewrite = REDIS_DEFAULT_AOF_NO_FSYNC_ON_REWRITE;</span><br><span class="line">    server.aof_rewrite_perc = REDIS_AOF_REWRITE_PERC;</span><br><span class="line">    server.aof_rewrite_min_size = REDIS_AOF_REWRITE_MIN_SIZE;</span><br><span class="line">    server.aof_rewrite_base_size = <span class="number">0</span>;</span><br><span class="line">    server.aof_rewrite_scheduled = <span class="number">0</span>;</span><br><span class="line">    server.aof_last_fsync = time(<span class="literal">NULL</span>);</span><br><span class="line">    server.aof_rewrite_time_last = <span class="number">-1</span>;</span><br><span class="line">    server.aof_rewrite_time_start = <span class="number">-1</span>;</span><br><span class="line">    server.aof_lastbgrewrite_status = REDIS_OK;</span><br><span class="line">    server.aof_delayed_fsync = <span class="number">0</span>;</span><br><span class="line">    server.aof_fd = <span class="number">-1</span>;</span><br><span class="line">    server.aof_selected_db = <span class="number">-1</span>; <span class="comment">/* Make sure the first time will not match */</span></span><br><span class="line">    server.aof_flush_postponed_start = <span class="number">0</span>;</span><br><span class="line">    server.aof_rewrite_incremental_fsync = REDIS_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC;</span><br><span class="line">    server.pidfile = zstrdup(REDIS_DEFAULT_PID_FILE);</span><br><span class="line">    server.rdb_filename = zstrdup(REDIS_DEFAULT_RDB_FILENAME);</span><br><span class="line">    server.aof_filename = zstrdup(<span class="string">"appendonly.aof"</span>);</span><br><span class="line">    server.requirepass = <span class="literal">NULL</span>;</span><br><span class="line">    server.rdb_compression = REDIS_DEFAULT_RDB_COMPRESSION;</span><br><span class="line">    server.rdb_checksum = REDIS_DEFAULT_RDB_CHECKSUM;</span><br><span class="line">    server.stop_writes_on_bgsave_err = REDIS_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR;</span><br><span class="line">    server.activerehashing = REDIS_DEFAULT_ACTIVE_REHASHING;</span><br><span class="line">    server.notify_keyspace_events = <span class="number">0</span>;</span><br><span class="line">    server.maxclients = REDIS_MAX_CLIENTS;</span><br><span class="line">    server.bpop_blocked_clients = <span class="number">0</span>;</span><br><span class="line">    server.maxmemory = REDIS_DEFAULT_MAXMEMORY;</span><br><span class="line">    server.maxmemory_policy = REDIS_DEFAULT_MAXMEMORY_POLICY;</span><br><span class="line">    server.maxmemory_samples = REDIS_DEFAULT_MAXMEMORY_SAMPLES;</span><br><span class="line">    server.hash_max_ziplist_entries = REDIS_HASH_MAX_ZIPLIST_ENTRIES;</span><br><span class="line">    server.hash_max_ziplist_value = REDIS_HASH_MAX_ZIPLIST_VALUE;</span><br><span class="line">    server.list_max_ziplist_entries = REDIS_LIST_MAX_ZIPLIST_ENTRIES;</span><br><span class="line">    server.list_max_ziplist_value = REDIS_LIST_MAX_ZIPLIST_VALUE;</span><br><span class="line">    server.set_max_intset_entries = REDIS_SET_MAX_INTSET_ENTRIES;</span><br><span class="line">    server.zset_max_ziplist_entries = REDIS_ZSET_MAX_ZIPLIST_ENTRIES;</span><br><span class="line">    server.zset_max_ziplist_value = REDIS_ZSET_MAX_ZIPLIST_VALUE;</span><br><span class="line">    server.shutdown_asap = <span class="number">0</span>;</span><br><span class="line">    server.repl_ping_slave_period = REDIS_REPL_PING_SLAVE_PERIOD;</span><br><span class="line">    server.repl_timeout = REDIS_REPL_TIMEOUT;</span><br><span class="line">    server.repl_min_slaves_to_write = REDIS_DEFAULT_MIN_SLAVES_TO_WRITE;</span><br><span class="line">    server.repl_min_slaves_max_lag = REDIS_DEFAULT_MIN_SLAVES_MAX_LAG;</span><br><span class="line">    server.lua_caller = <span class="literal">NULL</span>;</span><br><span class="line">    server.lua_time_limit = REDIS_LUA_TIME_LIMIT;</span><br><span class="line">    server.lua_client = <span class="literal">NULL</span>;</span><br><span class="line">    server.lua_timedout = <span class="number">0</span>;</span><br><span class="line">    server.loading_process_events_interval_bytes = (<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    updateLRUClock();</span><br><span class="line">    resetServerSaveParams();</span><br><span class="line"></span><br><span class="line">    appendServerSaveParams(<span class="number">60</span>*<span class="number">60</span>,<span class="number">1</span>);  <span class="comment">/* save after 1 hour and 1 change */</span></span><br><span class="line">    appendServerSaveParams(<span class="number">300</span>,<span class="number">100</span>);  <span class="comment">/* save after 5 minutes and 100 changes */</span></span><br><span class="line">    appendServerSaveParams(<span class="number">60</span>,<span class="number">10000</span>); <span class="comment">/* save after 1 minute and 10000 changes */</span></span><br><span class="line">    <span class="comment">/* Replication related */</span></span><br><span class="line">    server.masterauth = <span class="literal">NULL</span>;</span><br><span class="line">    server.masterhost = <span class="literal">NULL</span>;</span><br><span class="line">    server.masterport = <span class="number">6379</span>;</span><br><span class="line">    server.master = <span class="literal">NULL</span>;</span><br><span class="line">    server.cached_master = <span class="literal">NULL</span>;</span><br><span class="line">    server.repl_master_initial_offset = <span class="number">-1</span>;</span><br><span class="line">    server.repl_state = REDIS_REPL_NONE;</span><br><span class="line">    server.repl_syncio_timeout = REDIS_REPL_SYNCIO_TIMEOUT;</span><br><span class="line">    server.repl_serve_stale_data = REDIS_DEFAULT_SLAVE_SERVE_STALE_DATA;</span><br><span class="line">    server.repl_slave_ro = REDIS_DEFAULT_SLAVE_READ_ONLY;</span><br><span class="line">    server.repl_down_since = <span class="number">0</span>; <span class="comment">/* Never connected, repl is down since EVER. */</span></span><br><span class="line">    server.repl_disable_tcp_nodelay = REDIS_DEFAULT_REPL_DISABLE_TCP_NODELAY;</span><br><span class="line">    server.slave_priority = REDIS_DEFAULT_SLAVE_PRIORITY;</span><br><span class="line">    server.master_repl_offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Replication partial resync backlog */</span></span><br><span class="line">    server.repl_backlog = <span class="literal">NULL</span>;</span><br><span class="line">    server.repl_backlog_size = REDIS_DEFAULT_REPL_BACKLOG_SIZE;</span><br><span class="line">    server.repl_backlog_histlen = <span class="number">0</span>;</span><br><span class="line">    server.repl_backlog_idx = <span class="number">0</span>;</span><br><span class="line">    server.repl_backlog_off = <span class="number">0</span>;</span><br><span class="line">    server.repl_backlog_time_limit = REDIS_DEFAULT_REPL_BACKLOG_TIME_LIMIT;</span><br><span class="line">    server.repl_no_slaves_since = time(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Client output buffer limits */</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; REDIS_CLIENT_LIMIT_NUM_CLASSES; j++)</span><br><span class="line">        server.client_obuf_limits[j] = clientBufferLimitsDefaults[j];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Double constants initialization */</span></span><br><span class="line">    R_Zero = <span class="number">0.0</span>;</span><br><span class="line">    R_PosInf = <span class="number">1.0</span>/R_Zero;</span><br><span class="line">    R_NegInf = <span class="number">-1.0</span>/R_Zero;</span><br><span class="line">    R_Nan = R_Zero/R_Zero;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Command table -- we initiialize it here as it is part of the</span></span><br><span class="line"><span class="comment">     * initial configuration, since command names may be changed via</span></span><br><span class="line"><span class="comment">     * redis.conf using the rename-command directive. */</span></span><br><span class="line">    server.commands = dictCreate(&amp;commandTableDictType,<span class="literal">NULL</span>);</span><br><span class="line">    server.orig_commands = dictCreate(&amp;commandTableDictType,<span class="literal">NULL</span>);</span><br><span class="line">    populateCommandTable();</span><br><span class="line">    server.delCommand = lookupCommandByCString(<span class="string">"del"</span>);</span><br><span class="line">    server.multiCommand = lookupCommandByCString(<span class="string">"multi"</span>);</span><br><span class="line">    server.lpushCommand = lookupCommandByCString(<span class="string">"lpush"</span>);</span><br><span class="line">    server.lpopCommand = lookupCommandByCString(<span class="string">"lpop"</span>);</span><br><span class="line">    server.rpopCommand = lookupCommandByCString(<span class="string">"rpop"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Slow log */</span></span><br><span class="line">    server.slowlog_log_slower_than = REDIS_SLOWLOG_LOG_SLOWER_THAN;</span><br><span class="line">    server.slowlog_max_len = REDIS_SLOWLOG_MAX_LEN;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Debugging */</span></span><br><span class="line">    server.assert_failed = <span class="string">"&lt;no assertion failed&gt;"</span>;</span><br><span class="line">    server.assert_file = <span class="string">"&lt;no file&gt;"</span>;</span><br><span class="line">    server.assert_line = <span class="number">0</span>;</span><br><span class="line">    server.bug_report_start = <span class="number">0</span>;</span><br><span class="line">    server.watchdog_period = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="initServer"><a href="#initServer" class="headerlink" title="initServer()"></a>initServer()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">    signal(SIGHUP, SIG_IGN);</span><br><span class="line">    signal(SIGPIPE, SIG_IGN);</span><br><span class="line">    setupSignalHandlers();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.syslog_enabled) &#123;</span><br><span class="line">        openlog(server.syslog_ident, LOG_PID | LOG_NDELAY | LOG_NOWAIT,</span><br><span class="line">            server.syslog_facility);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server.current_client = <span class="literal">NULL</span>;</span><br><span class="line">    server.clients = listCreate();</span><br><span class="line">    server.clients_to_close = listCreate();</span><br><span class="line">    server.slaves = listCreate();</span><br><span class="line">    server.monitors = listCreate();</span><br><span class="line">    server.slaveseldb = <span class="number">-1</span>; <span class="comment">/* Force to emit the first SELECT command. */</span></span><br><span class="line">    server.unblocked_clients = listCreate();</span><br><span class="line">    server.ready_keys = listCreate();</span><br><span class="line"></span><br><span class="line">    createSharedObjects();</span><br><span class="line">    adjustOpenFilesLimit();</span><br><span class="line">    server.el = aeCreateEventLoop(server.maxclients+REDIS_EVENTLOOP_FDSET_INCR);</span><br><span class="line">    server.db = zmalloc(<span class="keyword">sizeof</span>(redisDb)*server.dbnum);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Open the TCP listening socket for the user commands. */</span></span><br><span class="line">    <span class="keyword">if</span> (listenToPort(server.port,server.ipfd,&amp;server.ipfd_count) == REDIS_ERR)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Open the listening Unix domain socket. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.unixsocket != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        unlink(server.unixsocket); <span class="comment">/* don't care if this fails */</span></span><br><span class="line">        server.sofd = anetUnixServer(server.neterr,server.unixsocket,server.unixsocketperm);</span><br><span class="line">        <span class="keyword">if</span> (server.sofd == ANET_ERR) &#123;</span><br><span class="line">            redisLog(REDIS_WARNING, <span class="string">"Opening socket: %s"</span>, server.neterr);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Abort if there are no listening sockets at all. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.ipfd_count == <span class="number">0</span> &amp;&amp; server.sofd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        redisLog(REDIS_WARNING, <span class="string">"Configured to not listen anywhere, exiting."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create the Redis databases, and initialize other internal state. */</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.dbnum; j++) &#123;</span><br><span class="line">        server.db[j].dict = dictCreate(&amp;dbDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].expires = dictCreate(&amp;keyptrDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].blocking_keys = dictCreate(&amp;keylistDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].ready_keys = dictCreate(&amp;setDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].watched_keys = dictCreate(&amp;keylistDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].id = j;</span><br><span class="line">        server.db[j].avg_ttl = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    server.pubsub_channels = dictCreate(&amp;keylistDictType,<span class="literal">NULL</span>);</span><br><span class="line">    server.pubsub_patterns = listCreate();</span><br><span class="line">    listSetFreeMethod(server.pubsub_patterns,freePubsubPattern);</span><br><span class="line">    listSetMatchMethod(server.pubsub_patterns,listMatchPubsubPattern);</span><br><span class="line">    server.cronloops = <span class="number">0</span>;</span><br><span class="line">    server.rdb_child_pid = <span class="number">-1</span>;</span><br><span class="line">    server.aof_child_pid = <span class="number">-1</span>;</span><br><span class="line">    aofRewriteBufferReset();</span><br><span class="line">    server.aof_buf = sdsempty();</span><br><span class="line">    server.lastsave = time(<span class="literal">NULL</span>); <span class="comment">/* At startup we consider the DB saved. */</span></span><br><span class="line">    server.lastbgsave_try = <span class="number">0</span>;    <span class="comment">/* At startup we never tried to BGSAVE. */</span></span><br><span class="line">    server.rdb_save_time_last = <span class="number">-1</span>;</span><br><span class="line">    server.rdb_save_time_start = <span class="number">-1</span>;</span><br><span class="line">    server.dirty = <span class="number">0</span>;</span><br><span class="line">    server.stat_numcommands = <span class="number">0</span>;</span><br><span class="line">    server.stat_numconnections = <span class="number">0</span>;</span><br><span class="line">    server.stat_expiredkeys = <span class="number">0</span>;</span><br><span class="line">    server.stat_evictedkeys = <span class="number">0</span>;</span><br><span class="line">    server.stat_starttime = time(<span class="literal">NULL</span>);</span><br><span class="line">    server.stat_keyspace_misses = <span class="number">0</span>;</span><br><span class="line">    server.stat_keyspace_hits = <span class="number">0</span>;</span><br><span class="line">    server.stat_peak_memory = <span class="number">0</span>;</span><br><span class="line">    server.stat_fork_time = <span class="number">0</span>;</span><br><span class="line">    server.stat_rejected_conn = <span class="number">0</span>;</span><br><span class="line">    server.stat_sync_full = <span class="number">0</span>;</span><br><span class="line">    server.stat_sync_partial_ok = <span class="number">0</span>;</span><br><span class="line">    server.stat_sync_partial_err = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(server.ops_sec_samples,<span class="number">0</span>,<span class="keyword">sizeof</span>(server.ops_sec_samples));</span><br><span class="line">    server.ops_sec_idx = <span class="number">0</span>;</span><br><span class="line">    server.ops_sec_last_sample_time = mstime();</span><br><span class="line">    server.ops_sec_last_sample_ops = <span class="number">0</span>;</span><br><span class="line">    server.unixtime = time(<span class="literal">NULL</span>);</span><br><span class="line">    server.mstime = mstime();</span><br><span class="line">    server.lastbgsave_status = REDIS_OK;</span><br><span class="line">    server.repl_good_slaves_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create the serverCron() time event, that's our main way to process</span></span><br><span class="line"><span class="comment">     * background operations. */</span></span><br><span class="line">    <span class="keyword">if</span>(aeCreateTimeEvent(server.el, <span class="number">1</span>, serverCron, <span class="literal">NULL</span>, <span class="literal">NULL</span>) == AE_ERR) &#123;</span><br><span class="line">        redisPanic(<span class="string">"Can't create the serverCron time event."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create an event handler for accepting new connections in TCP and Unix</span></span><br><span class="line"><span class="comment">     * domain sockets. */</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.ipfd_count; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (aeCreateFileEvent(server.el, server.ipfd[j], AE_READABLE,</span><br><span class="line">            acceptTcpHandler,<span class="literal">NULL</span>) == AE_ERR)</span><br><span class="line">            &#123;</span><br><span class="line">                redisPanic(</span><br><span class="line">                    <span class="string">"Unrecoverable error creating server.ipfd file event."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (server.sofd &gt; <span class="number">0</span> &amp;&amp; aeCreateFileEvent(server.el,server.sofd,AE_READABLE,</span><br><span class="line">        acceptUnixHandler,<span class="literal">NULL</span>) == AE_ERR) redisPanic(<span class="string">"Unrecoverable error creating server.sofd file event."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Open the AOF file if needed. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.aof_state == REDIS_AOF_ON) &#123;</span><br><span class="line">        server.aof_fd = open(server.aof_filename,</span><br><span class="line">                               O_WRONLY|O_APPEND|O_CREAT,<span class="number">0644</span>);</span><br><span class="line">        <span class="keyword">if</span> (server.aof_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">            redisLog(REDIS_WARNING, <span class="string">"Can't open the append-only file: %s"</span>,</span><br><span class="line">                strerror(errno));</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 32 bit instances are limited to 4GB of address space, so if there is</span></span><br><span class="line"><span class="comment">     * no explicit limit in the user provided configuration we set a limit</span></span><br><span class="line"><span class="comment">     * at 3 GB using maxmemory with 'noeviction' policy'. This avoids</span></span><br><span class="line"><span class="comment">     * useless crashes of the Redis instance for out of memory. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.arch_bits == <span class="number">32</span> &amp;&amp; server.maxmemory == <span class="number">0</span>) &#123;</span><br><span class="line">        redisLog(REDIS_WARNING,<span class="string">"Warning: 32 bit instance detected but no memory limit set. Setting 3 GB maxmemory limit with 'noeviction' policy now."</span>);</span><br><span class="line">        server.maxmemory = <span class="number">3072L</span>L*(<span class="number">1024</span>*<span class="number">1024</span>); <span class="comment">/* 3 GB */</span></span><br><span class="line">        server.maxmemory_policy = REDIS_MAXMEMORY_NO_EVICTION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    replicationScriptCacheInit();</span><br><span class="line">    scriptingInit();</span><br><span class="line">    slowlogInit();</span><br><span class="line">    bioInit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="redisæ•°æ®åº“åˆ›å»º"><a href="#redisæ•°æ®åº“åˆ›å»º" class="headerlink" title="redisæ•°æ®åº“åˆ›å»º"></a>redisæ•°æ®åº“åˆ›å»º</h3><h4 id="æ ¸å¿ƒç»“æ„ä½“redisDb"><a href="#æ ¸å¿ƒç»“æ„ä½“redisDb" class="headerlink" title="æ ¸å¿ƒç»“æ„ä½“redisDb"></a>æ ¸å¿ƒç»“æ„ä½“redisDb</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisDb</span> &#123;</span></span><br><span class="line">    dict *dict;                 <span class="comment">/* The keyspace for this DB */</span></span><br><span class="line">    dict *expires;              <span class="comment">/* Timeout of keys with a timeout set */</span></span><br><span class="line">    dict *blocking_keys;        <span class="comment">/* Keys with clients waiting for data (BLPOP) */</span></span><br><span class="line">    dict *ready_keys;           <span class="comment">/* Blocked keys that received a PUSH */</span></span><br><span class="line">    dict *watched_keys;         <span class="comment">/* WATCHED keys for MULTI/EXEC CAS */</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> avg_ttl;          <span class="comment">/* Average TTL, just for stats */</span></span><br><span class="line">&#125; redisDb;</span><br></pre></td></tr></table></figure>
<h4 id="åˆ›å»ºæµç¨‹"><a href="#åˆ›å»ºæµç¨‹" class="headerlink" title="åˆ›å»ºæµç¨‹"></a>åˆ›å»ºæµç¨‹</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_DEFAULT_DBNUM     16</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initServerConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">    server.dbnum = REDIS_DEFAULT_DBNUM;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯é…ç½®æ–‡ä»¶é‡Œè®¾ç½®äº†æ•°æ®åº“çš„æ•°ç›®,å¦‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Set the number of databases. The default database is DB 0, you can select</span></span><br><span class="line"><span class="comment"># a different one on a per-connection basis using SELECT &lt;dbid&gt; where</span></span><br><span class="line"><span class="comment"># dbid is a number between 0 and 'databases'-1</span></span><br><span class="line">databases 16</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æŠŠæ–‡ä»¶é…ç½®ä¿¡æ¯è¯»å…¥å†…å­˜</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loadServerConfig</span><span class="params">(<span class="keyword">char</span> *filename, <span class="keyword">char</span> *options)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">loadServerConfigFromString(config);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è§£æé…ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loadServerConfigFromString</span><span class="params">(<span class="keyword">char</span> *config)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">"databases"</span>) &amp;&amp; argc == <span class="number">2</span>) &#123;</span><br><span class="line">            server.dbnum = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">if</span> (server.dbnum &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                err = <span class="string">"Invalid number of databases"</span>; <span class="keyword">goto</span> loaderr;</span><br><span class="line">            &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">    server.db = zmalloc(<span class="keyword">sizeof</span>(redisDb)*server.dbnum);</span><br><span class="line">...</span><br><span class="line">    <span class="comment">/* Create the Redis databases, and initialize other internal state. */</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.dbnum; j++) &#123;</span><br><span class="line">        server.db[j].dict = dictCreate(&amp;dbDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].expires = dictCreate(&amp;keyptrDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].blocking_keys = dictCreate(&amp;keylistDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].ready_keys = dictCreate(&amp;setDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].watched_keys = dictCreate(&amp;keylistDictType,<span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].id = j;</span><br><span class="line">        server.db[j].avg_ttl = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="åˆ‡æ¢æ•°æ®åº“"><a href="#åˆ‡æ¢æ•°æ®åº“" class="headerlink" title="åˆ‡æ¢æ•°æ®åº“"></a>åˆ‡æ¢æ•°æ®åº“</h4><p>SELECTå‘½ä»¤è°ƒç”¨selectCommand, æœ‰æ•ˆå€¼æ˜¾ç„¶æ˜¯[0, server.dbnum-1]<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">selectDb</span><span class="params">(redisClient *c, <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (id &lt; <span class="number">0</span> || id &gt;= server.dbnum)</span><br><span class="line">        <span class="keyword">return</span> REDIS_ERR;</span><br><span class="line">    c-&gt;db = &amp;server.db[id];</span><br><span class="line">    <span class="keyword">return</span> REDIS_OK;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// SELECTå‘½ä»¤è°ƒç”¨selectCommand</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">selectCommand</span><span class="params">(redisClient *c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getLongFromObjectOrReply(c, c-&gt;argv[<span class="number">1</span>], &amp;id,</span><br><span class="line">        <span class="string">"invalid DB index"</span>) != REDIS_OK)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (selectDb(c,id) == REDIS_ERR) &#123;</span><br><span class="line">        addReplyError(c,<span class="string">"invalid DB index"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        addReply(c,shared.ok);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://mojiajun.github.io/post/22230d9.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mojiajun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mojiajun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/22230d9.html" itemprop="url">ffmpeg-AVBuffer-AVBufferRef-æºç é˜…è¯»</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-03T00:00:00+08:00">
                2018-12-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/æºç é˜…è¯»/" itemprop="url" rel="index">
                    <span itemprop="name">æºç é˜…è¯»</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/æºç é˜…è¯»/ffmpeg/" itemprop="url" rel="index">
                    <span itemprop="name">ffmpeg</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>FFMPEG-AVBuffer-AVBufferRef-æºç é˜…è¯»</p>
<p>å‚è€ƒäº†<a href="https://www.cnblogs.com/tocy/p/ffmpeg-libavutil-avbuffer-imp.html" target="_blank" rel="noopener">ffmpegä¸­AVBufferçš„å®ç°åˆ†æ</a></p>
<p>ä¸‹é¢è¿™ä¸ªåˆ†æçš„æ›´å¥½.<a href="https://blog.csdn.net/muyuyuzhong/article/details/79381152" target="_blank" rel="noopener">æ·±å…¥ç†è§£FFMPEG-AVBuffer/AVBufferRef/AVBufferPool</a></p>
<p>ä¸»è¦å®ç°æ–‡ä»¶ä½äºlibavutilä¸­çš„buffer.hã€buffer_internal.hã€buffer.cä¸‰ä¸ªæ–‡ä»¶ä¸­ã€‚å…¶ä¸­æœ€ä¸»è¦çš„æ˜¯ä¸¤ä¸ªç»“æ„<strong>AVBufferRef</strong>å’Œ<strong>AVBuffer</strong>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">libavutil/buffer_internal.h</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AVBuffer</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint8_t</span> *data; <span class="comment">/**&lt; data described by this buffer */</span></span><br><span class="line">    <span class="keyword">int</span>      size; <span class="comment">/**&lt; size of data in bytes */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  number of existing AVBufferRef instances referring to this buffer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">atomic_uint</span> refcount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * a callback for freeing the data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> (*<span class="built_in">free</span>)(<span class="keyword">void</span> *opaque, <span class="keyword">uint8_t</span> *data);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * an opaque pointer, to be used by the freeing callback</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> *opaque;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A combination of BUFFER_FLAG_*</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">AVBufferRef</span> &#123;</span></span><br><span class="line">    AVBuffer *buffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The data buffer. It is considered writable if and only if</span></span><br><span class="line"><span class="comment">     * this is the only reference to the buffer, in which case</span></span><br><span class="line"><span class="comment">     * av_buffer_is_writable() returns 1.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> *data;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Size of data in bytes.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span>      size;</span><br><span class="line">&#125; AVBufferRef;</span><br></pre></td></tr></table></figure>
<p>å¤–éƒ¨ä½¿ç”¨æœ€å¥½æ˜¯é€šè¿‡AVBufferRefæ¥å¼•ç”¨æ•°æ®.ä¸ç„¶å°±ä¸§å¤±äº†è¿™ä¸ªè®¾è®¡çš„æ„ä¹‰.(èƒ½ä¿éšœå½“å¼•ç”¨è®¡æ•°ç­‰äº0æ—¶è‡ªåŠ¨é‡Šæ”¾æŒ‡å®šå†…å­˜åŒºåŸŸ.)</p>
<p>av_buffer_alloc()</p>
<blockquote>
<p>è°ƒç”¨äº†av_buffer_create()..æŠŠAVBufferRefå’ŒAVBufferçš„dataå’Œsizeè®¾æˆäº†ä¸€æ ·çš„å€¼</p>
<p>è°ƒç”¨å®Œæˆåè¿”å›ä¸€ä¸ªAVBufferRefæŒ‡é’ˆ.<br>ä¸‰æ¬¡åˆ†é…å†…å­˜,1.å®é™…æ•°æ®å­˜æ”¾çš„dataæŒ‡é’ˆ,2.AVBufferRefç»“æ„ä½“,3.AVBufferç»“æ„ä½“ã€‚</p>
</blockquote>
<p>av_buffer_allocz()åªæ˜¯åœ¨av_buffer_alloc()åŸºç¡€ä¸ŠåŠ äº†ä¸€ä¸ªæŠŠå®é™…çš„æ•°æ®åŸŸdataåˆå§‹åŒ–ä¸º0çš„è¿‡ç¨‹.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">AVBufferRef *<span class="title">av_buffer_ref</span><span class="params">(AVBufferRef *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AVBufferRef *ret = av_mallocz(<span class="keyword">sizeof</span>(*ret));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ret)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    *ret = *buf;</span><br><span class="line"></span><br><span class="line">    atomic_fetch_add_explicit(&amp;buf-&gt;buffer-&gt;refcount, <span class="number">1</span>, memory_order_relaxed);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>av_buffer_ref()ç»™AVBufferRef *bufåˆ›å»ºä¸€ä»½AVBufferRefç»“æ„ä½“çš„copy,ç„¶åè¿”å›è¿™ä¸ªAVBufferRef.ä½†æ˜¯æ²¡æœ‰æ‹·è´åº•å±‚æ•°æ®,åªæ˜¯æŠŠåŸæ¥çš„å¼•ç”¨è®¡æ•°ç”¨åŸå­æ“ä½œåŠ ä¸€.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">buffer_replace</span><span class="params">(AVBufferRef **dst, AVBufferRef **src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AVBuffer *b;</span><br><span class="line"></span><br><span class="line">    b = (*dst)-&gt;buffer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (src) &#123;</span><br><span class="line">        **dst = **src;</span><br><span class="line">        av_freep(src);</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">        av_freep(dst);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (atomic_fetch_add_explicit(&amp;b-&gt;refcount, <span class="number">-1</span>, memory_order_acq_rel) == <span class="number">1</span>) &#123;</span><br><span class="line">        b-&gt;<span class="built_in">free</span>(b-&gt;opaque, b-&gt;data);</span><br><span class="line">        av_freep(&amp;b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">	è¿™ä¸ªbuffer_replaceæ˜¯ä¸€ä¸ªå®ç°å‡½æ•°,åªèƒ½åœ¨buffer.cå†…éƒ¨ä½¿ç”¨.(åŠ äº†<span class="keyword">static</span>)</span><br><span class="line">	åŠŸèƒ½å¦‚å…¶å,è®©**dstè¢«**srcå–ä»£,è¿™æ˜¯ç»“æ„ä½“æœ¬èº«çš„ç›´æ¥èµ‹å€¼(è¦†ç›–).åˆ†ä¸¤ç§æƒ…å†µ:ä¸€,å¦‚æœsrcæ˜¯<span class="literal">NULL</span>,é‚£ä¹ˆç›´æ¥æŠŠAVBufferRef **dstè¿™ä¸ªç»“æ„ä½“é‡Šæ”¾æ‰;äºŒ,å¦‚æœsrcè¿™ä¸ªäºŒçº§æŒ‡é’ˆä¸ä¸ºç©º,é‚£ä¹ˆå°±å®Œæˆæ›¿æ¢æ“ä½œ,åŒæ—¶é‡Šæ”¾æ‰src.</span><br><span class="line"> 	ä¸ç®¡å“ªç§æƒ…å†µ,dsté‡Œé¢ç®¡ç†çš„AVBufferé‡Œé¢çš„refcountéƒ½è¦å‡ä¸€,å¦‚æœæ»¡è¶³åˆé€‚æ¡ä»¶(è¿™ä¸ªæ¡ä»¶æ²¡çœ‹æ‡‚,æ˜¯å‡ä¸€ååˆ¤æ–­å¼•ç”¨è®¡æ•°æ˜¯ä¸æ˜¯ç­‰äº<span class="number">1</span>?),å°±é‡Šæ”¾æ‰AVBufferå’Œbuf.ä¹Ÿå°±æ˜¯é‡Šæ”¾æ‰AVBufferRefè¿™ä¸ªç±»ä¼¼äºæ™ºèƒ½æŒ‡é’ˆåº•ä¸‹ç®¡ç†çš„æ•°æ®.</span><br><span class="line">    ç±»ä¼¼C++çš„æ™ºèƒ½æŒ‡é’ˆ.ä½†æ˜¯åˆæœ‰åŒºåˆ«,ä»å³åˆ°å·¦çš„èµ‹å€¼æ²¡æœ‰å¢åŠ å³è¾¹çš„å¼•ç”¨è®¡æ•°,åè€ŒæŠŠå³è¾¹çš„é‡Šæ”¾äº†,æ­£å¦‚replaceå«ä¹‰.</span><br><span class="line">PS:</span><br><span class="line"><span class="number">1.</span>æŸ¥é˜…æ–‡æ¡£,å‘ç°atomic_fetch_add_explicit()è¿”å›çš„æ˜¯è®¡ç®—å‰çš„å€¼,æ‰€ä»¥è¿™é‡Œ==<span class="number">1</span>ä¹Ÿå°±ä¸å¥‡æ€ªäº†.</span><br><span class="line">The value held previously be the atomic object pointed to by obj.</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void av_buffer_unref(AVBufferRef **buf)è°ƒç”¨äº†buffer_replace(buf, NULL),ä¹Ÿå°±æ˜¯æŠŠbufç›´æ¥é‡Šæ”¾æ‰äº†,åªè¦è°ƒç”¨buffer_replace()å°±ä¼šæŠŠå¼•ç”¨è®¡æ•°å‡ä¸€,ç„¶åæ£€æµ‹åº•å±‚æ•°æ®çš„å¼•ç”¨æ•°.å¦‚æœæ²¡æœ‰è¢«å¼•ç”¨äº†,å°±æŠŠåº•å±‚æ•°æ®é‡Šæ”¾æ‰.</span><br><span class="line"></span><br><span class="line">av_buffer_ref()</span><br><span class="line">av_buffer_unref()è¿™ä¸¤å‡½æ•°æ“ä½œçš„éƒ½æ˜¯AVBufferRef,ä¸€ä¸ªåˆ›å»ºAVBufferRef,ä¸€ä¸ªé”€æ¯AVBufferRef,è¦ä¸è¦æ“ä½œåº•å±‚æ•°æ®ä¼šæ ¹æ®å¼•ç”¨è®¡æ•°è‡ªè¡Œåˆ¤æ–­.</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">av_buffer_is_writable</span><span class="params">(<span class="keyword">const</span> AVBufferRef *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (buf-&gt;buffer-&gt;flags &amp; AV_BUFFER_FLAG_READONLY)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> atomic_load(&amp;buf-&gt;buffer-&gt;refcount) == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">bufferè¦å¯å†™å¿…é¡»å‰ææ˜¯flagsä¸èƒ½æ˜¯AV_BUFFER_FLAG_READONLY,ç„¶åå¼•ç”¨è®¡æ•°å¿…é¡»æ˜¯<span class="number">1.</span>ä¹Ÿå³æ˜¯å½“å‰åªæœ‰ä¸€ä¸ªAVBufferRefåœ¨å¼•ç”¨è¿™å—buffer,æ‰å¤„äºå¯å†™çŠ¶æ€.</span><br><span class="line">av_buffer_make_writable(AVBufferRef **pbuf)è¿™ä¸ªå°±å¦å¤–å»ºç«‹äº†ä¸€å¥—æ–°çš„å¼•ç”¨è®¡æ•°ç³»ç»Ÿ,å½“ç„¶è®¡æ•°ä¸º<span class="number">1.</span>æŠŠåŸæ¥çš„pbufé‡Œé¢çš„å¼•ç”¨è®¡æ•°å‡ä¸€.</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">av_buffer_make_writable</span><span class="params">(AVBufferRef **pbuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AVBufferRef *newbuf, *buf = *pbuf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (av_buffer_is_writable(buf))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    newbuf = av_buffer_alloc(buf-&gt;size);<span class="comment">//åˆ†é…ä¸‰ä¸ªä¸œè¥¿(1.å®é™…æ•°æ®å­˜æ”¾çš„dataæŒ‡é’ˆ,2.AVBufferRefç»“æ„ä½“,3.AVBufferç»“æ„ä½“ã€‚)çš„å†…å­˜.åˆ›å»ºä¸€å¥—æ–°çš„å¼•ç”¨è®¡æ•°ç³»ç»Ÿ.</span></span><br><span class="line">    <span class="keyword">if</span> (!newbuf)</span><br><span class="line">        <span class="keyword">return</span> AVERROR(ENOMEM);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(newbuf-&gt;data, buf-&gt;data, buf-&gt;size);<span class="comment">//æŠŠåŸæ¥çš„buf-&gt;dataæ‹·è´åˆ°newbuf-&gt;data.</span></span><br><span class="line"></span><br><span class="line">    buffer_replace(pbuf, &amp;newbuf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">å¯ä»¥é€šè¿‡av_buffer_make_writable()æ¥è®©å…¶å¯å†™ï¼Œè¯¥å‡½æ•°å†…éƒ¨å†…éƒ¨è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®ç¼“å†²åŒºï¼Œå¹¶ä¸”åŸæ¥çš„AVBufferå¼•ç”¨è®¡æ•°<span class="number">-1.</span></span><br></pre></td></tr></table></figure>
<p>AVBufferPoolè¿˜æ²¡åˆ†æ.</p>
<p>ç„¶åè¿™å‡ ä¸ªå‡½æ•°åœ¨å“ªè¢«ç”¨åˆ°äº†è¿˜æ²¡çœ‹</p>
<p>libavutil/frame.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AVFrame</span><br><span class="line">av_frame_ref()</span><br><span class="line">av_frame_unref()</span><br></pre></td></tr></table></figure>
<p>libavcodec/avpacket.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AVPacket</span><br><span class="line">av_packet_ref()</span><br><span class="line">av_packet_unref()</span><br></pre></td></tr></table></figure>
<p>å‚è€ƒæ–‡çŒ®:<br>1.<a href="https://www.cnblogs.com/tocy/p/ffmpeg-libavutil-avbuffer-imp.html" target="_blank" rel="noopener">ffmpegä¸­AVBufferçš„å®ç°åˆ†æ</a></p>
<p>2.<a href="https://blog.csdn.net/muyuyuzhong/article/details/79381152" target="_blank" rel="noopener">æ·±å…¥ç†è§£FFMPEG-AVBuffer/AVBufferRef/AVBufferPool</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">mojiajun</p>
              <p class="site-description motion-element" itemprop="description">è«ä½³éªå­¦ä¹ ç¬”è®°</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">mojiajun</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>








        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
